---
title: "Impact of interaction network structure on community-level plant reproduction success"
author: "Magrach, A, Molina, FP, Bartomeus, I"
date: "6 November 2018"
output: html_document
bibliography: library.bib
editor options:
  chunk_output_type: console
---

------------------------------------------------------------------------------------------------
To be potentially submitted to ECOLOGY LETTERS as a Letter: maximum of 5000 words and 6 figures, tables or text boxes. 
The abstract page should contain a short summary not exceeding 150 words for Letters.

III. Main text (Sections b-d required for Letters only)
(a) Introduction. The introduction should summarize briefly the background and aims, and end with a very brief statement of what has been achieved by the work.

(b) Material and methods. This section should contain sufficient detail so that all procedures can be repeated (in conjunction with cited references). A checklist is provided so that authors can check that their methods report details which our editors regard as essential. This checklist is available here. Where specific equipment and materials are named, the manufacturer's name, city and country should be given (generally in parentheses after first mention).

(c) Results. The Results section should present the experiments that support the conclusions to be drawn later in the Discussion. The Results section should conform to a high standard of rigour. Extended lines of inference, arguments or speculations should not be placed in the Results.

(d) Discussion. The Discussion section should be separate from the Results section. It allows authors to propose their interpretation of the results, and to suggest what they might mean in a wider context. It should end with a clear statement of the main conclusions of the research, and a clear explanation of their importance and relevance.

(e) Acknowledgements. Acknowledgements should be brief and concise.

(f) References. See below for detailed information to in-text citations and Reference list.]


---------------------------------------------------------------------------------------------------------

Title: Impact of interaction network structure on community-level plant reproduction success

Ainhoa Magrach, Francisco de Paula Molina, Ignasi Bartomeus

Short running title: Network structure effects on function

Keywords: nestedness, functional complementary, fruitset, pollination, plant-pollinator interaction

Type of article: Letter

Words in Abstract: 149 words

Words in main text (excluding abstract, acknowledgements, references, table and figure legends):

Words in text boxes: 

Number of references:

Number of figures, tables and text boxes:

Corresponding author: ainhoa.magrach@bc3research.org, nacho.bartomeus@gmail.com



# ABSTRACT

Declines in pollinator diversity and abundance have been reported across different regions, with implications for the reproductive success of many plant species. However, research has targeted the consequences for individual plant species, particularly focusing on pairwise plant-pollinator interactions, and largely overlooking community-level dynamics. Yet species do not interact in isolation, they are embedded within larger networks whose structure can affect pollinator functional roles and, ultimately, the pollination service they deliver to plants. Here, we present one of the first efforts linking pollinator visitation and plant reproduction from a community-wide perspective using a well-replicated dataset encompassing 16 well-resolved networks and data on reproductive success for 19 plant species from Mediterranean shrub ecosystems. We find that for prediction purposes, information on simple visitation metrics is sufficient. Contrastingly, a mechanisitic understanding of the pathways through which differences in pollinator diversity translate into changes in reproductive success, requires additional information on network structure. 

#INTRODUCTION

Pollinators provide key services to plants by facilitating pollen flow between individuals. The recent declining trends found for some pollinator species in some regions of the planet ([@Potts2010], although see [@Herrera2018] for opposite trends), have led many researchers to focus on the functional impacts of these changes in pollinator diversity, with a major focus being placed on the consequences for plant reproductive success [@Biesmeijer2006]. 

Many research efforts have targeted the reproductive success of individual plant species [@Albrecht2012a; @doi:10.1111/1365-2745.13055], and used relatively simple visitation metrics (e.g., the number of pollinator species that visit a plant or the number of visits they perform) to explain differences found  across different plant individuals. Some have gone a step further by including information on the efficiency of these visits, thus adding a measure of quality to the pollination services (REF). Contrastingly, community-level analyses remain scarce [@Bennett2018]. Yet plants and pollinators do not interact in isolation, but rather are embedded within larger networks of interactions encompassing other plant and pollinator species. We are thus missing an important part of the picture, which includes the direct interactions between the whole ensemble of plants and pollinators, but also the indirect ones between species within one guild (e.g., plants) through their shared resources [@Lazaro2014]. Understanding how changes in pollinator diversity affect whole plant assemblages is thus a major challenge that requires attention.

The few pollination studies that have analysed the effects of changing pollinator diversity for reproductive success at the community level, have done so using mainly experimental setups. As an example, a study that experimentally recreated a plant community with 9 plant species and differing levels of pollinator diversity across different enclosures, found that not only pollinator species diversity had an effect for average reproductive success, but also they found that the structure that shaped the community had an important effect [@Frund2013]. In particular, these authors found that functional complementarity between pollinators, in terms of plant species and temperature coverage (a measure of the overlap in the use of plant resources and optimum temperature activity) had a positive effect for average seed set at the community level [@Frund2013]. This provides added information on the effects of biodiversity for ecosystem functioning, suggesting that not only the diversity of species present but also the diversity of roles and ways in which a community is structured are determinant factors.

Indeed, theoretical research has long suggested that the structure of a community has an effect for ecosystem functioning (reviewed in [@Thompson2012]). This line of research, primarliy driven by food-web studies, has greatly advanced theory, but these ideas have not yet been tested with empirical data. Specifically, a major knowledge gap resides in understading which aspects of structure determine which aspects of function [@Thompson2012]. We are now at a point in which there is considerable understanding on the attributes of interaction networks (REF, REF, REF). Even further, we now have a substantial understanding of how these attributes vary along different types of gradients [@Pellissier2017; @Tylianakis2016]. Especially, in the case of pollination, we have ample knowledge on the attributes that shape these mutualistic interactions at the community level, such as a prevalence of nested structures (REF) or the presence of asymmetric specialization as a pervasive feature [@Vazquez2004]. The time is thus ripe to use this knowledge to explore relationships between community structure and ecosystem functioning, with special emphasis being placed on the underlying mechanisms that drive these relationships.

Here, we present one of the first efforts linking pollinator visitation and plant reproductive success at the community level. To this end, we use a well-replicated dataset encompassing 16 well-resolved networks coupled with data on the reproductive success of 19 plant species recorded at Mediterranean shrub ecosystems within the area of influence of Doñana National Park in SW Spain. Our study focuses on understanding whether adding information on the structure of the community to previously-used simple visitation metrics (e.g., number of pollinator species visiting a plant species) aids in better explaining the differences observed in community-wide reproductive success. In doing so, we conducted our analyses focusing on reproductive success at two different levels: (i) at the species level by considering the effect of the position of a focal species within the larger network and its impact on its individual reproductive success and (ii) at the community level, by evaluating how attributes that describe the whole community might affect average values of reproductive succes. 

Our results suggest that for prediction purposes, information on simple visitation metrics, particularly regarding the diversity of pollinators that visit a plant species, is sufficient. However, we find that a mechanisitic understanding of the pathways through which differences in pollinator diversity translate into changes in reproductive success requires additional information on network structure, notably information on the complementarity between the functions performed by different pollinator species. 

# METHODS

_Plant pollinator interactions_

Our study was conducted in SW Spain within the area of influence of Doñana National Park (Figure 1?). Here, we surveyed 16 Mediterranean woodland patches, located within a XXX m2 area and with an average distance of XX km between them (min= XX, max= XX). [SHOULD WE SAY SOMETHING ABOUT THE MATRIX SURROUNDING THESE SITES OR THE TYPE OF VEGETATION PRESENT IN THEM???] Each site was surveyed 7 times during the flowering season of 2015?? (February-July???) following a 100-m x 2 m transect for 30 mins. Along each transect, we identified all plant species and recorded all the flower visitors (IS IT JUST BEES AND HOVERFLIES?) that legitimately visited them. Floral visitors (from now on referred to as pollinators) that could not be identified in the field were captured, stored and identified in the laboratory by FdPM with the aid of experts in the different taxonomic groups (see acknowledgements). All surveys were done under similar weather conditions, avoiding windy or rainy days. 

_Plant reproductive success_

Within each site, we marked between 2 and 12 individuals (6.49 +- 2.37) of 1 to 6 plant species (4.06 +- 1.69), depending on availability and presence of flowers during the first sampling event. For each individual, we counted the number of flowers at the beginning of the season and recorded fruit set, the number of seeds per fruit (for 2-36 fruits, 11.17 +- 6.84) and average seed weight at the end of the season???. Our survey included a total of 19 plant species across our 16 sites. 

#DATA ANALYSES

In order to evaluate the completeness of our sampling of the pollinator and plant community as well as that of their interactions, we estimated the asymptotic number of species present, including non-detected species, and calculated the proportion detected with our original sampling data. We used Chao 1 asymptotic species richness estimators [@Chao2009] and estimated the richness of pollinators, plants and plant–pollinator links accumulated as sampling effort increased up to 100% sampling coverage using package iNEXT [@Hsieh2016] within the R environment [@RDevelopmentCoreTeam2011]. We then extracted the values covered by our sampling.

In order to analyse how differences within the pollinator community might affect plant reproductive success, we constructed weighted interaction networks by pooling the data for the 7 rounds of sampling. We thus obtained one weighted interaction network per site representing the frequency of visits by different pollinator species to different plant species. For each network we then proceeded to extract a series of relevant network metrics.

_Species-level network analysis_

At the species level, we focused on attributes defining the position of a focal plant species within the larger community. As such, we considered two metrics providing complementary non-redundant information: (i) average niche overlap between a focal species and other plant species in the community, which covers the potential indirect interactions between different plant species through shared resources (in this case pollinators), and (ii) centrality, which depicts the importance of the plant species within the larger community (as resource for a large number of pollinator species) and its contribution to network cohesiveness. 

_Community-level network analysis_

At the community level, we followed the same logic as the one presented at the species level. Thus, we also calculated two network metrics providing complementary non-redundant information. In this case we focused on (i) nestedness and (ii) functional complementarity. Nestedness is the property by which specialists interact with a subset of the species that generalists interact with (REF). Although there is an ongoing debate in the literature, some studies have found that nested networks are more stable and resilient to perturbations because nestedness implies a certain level of redundancy and thus the possibility for functional replacement in the case of species loss (REF). However, plant reproductive success depends on the delivery of conspecific pollen and thus of a certain level of specialization or niche divergence (reviewed in [@Brosi2016]). Yet at present we do not know how the interplay between redundancy and complementarity in species roles determines reproductive success.

Many network attributes vary with network size and complexity [@Bluthgen2006]. In the case of nestedness, we know it can be affected by network size and connectance (REF). An approach that is often used to correct for this, is to use null models and to compare null-model corrected nestedness values across different networks. However, this approach has been recently shown to present the same issues, as z-scores also change with network size and connectance [@Song2017]. Given the dependence of nestedness on network size and connectance, we followed the advice of these researchers by using a normalized value of nestedness, NODFc, which is independent of network size and thus comparable across different networks [@Song2017]. All network metrics were calculated using package bipartite [@Dormann2009].

_Statistical analyses_

In order to evaluate whether adding information on community structure improves our ability to explain differences in reproductive success both at the species and the community level, we used general linear (GLM) and general linear mixed models (GLMM). In both cases (species and community-level models) we fit two types of models: (i) model 1, that only included simple visitation metrics and (ii) model 2, that additionally included information on community structure.

At the species level, model 1 included as explanatory variables the diversity of pollinator species visiting a focal plant and the total number of visits received by that plant species; while model 2, added the two network attributes calculated at the species level: average niche overlap and centrality. In this case, we included plant species nested within site as a random effect to account for non-independence of several individuals measured for the same plant species within each site. The diversity of pollinator species visiting a focal plant was approximated using the plant´s normalised degree, i.e., the number of links with different pollinator species a plant has, scaled by the number of possible partners [@Dormann2009].

At the community level, we upscaled our species-level analyses. In this case, model 1 included total pollinator diversity and the total number of visits received by all plants within the community as explanatory variables. Model 2, in turn, added information on community structure by including nestedness and functional complementarity as explanatory variables. 

Average values of reproductive success at the community level can be driven to a large extent by one single plant species. Yet, what will determine the persistence of a diverse plant community, is the presence of some sort of “equity” in reproductive success across the whole community. We therefore calculated a measure of equity in reproductive success at the community level as the proportion of plant species within a site that is at 50% of the maximum value of fruitset recorded for that plant species within our sampling. We repeated this using 25% and 75% thresholds. We then used the same framework as before and fit the same model 1 and model 2 as those used at the community level but using equity in reproductive success as the response variable. 

We used information criterion methods to find the best model for each case and selected the ones with the lowest Akaike Information Criterion (AIC) value. Differences in AIC values < 2, were not considered enough to select one model over the other.

_Simulating the effect of community structure as sample size increases_

Finally, we tested whether the effect of community structure metrics increases with the number of plant species whose reproductive success is being considered. We expect that when only one plant species is considered, then the effect of community structure will be negligible. Further, we expect this effect to increase in importance as more plant species are considered (up to a maximum number of 6 species which is the maximum we have measured in our study).

To test this, we ran a simple simulation in which the number of species increases randomly (increases randomly or the identity of the sps is selected at random???) at each time step and calculate equity in reproductive success. Instead of drawing plants randomly for each run, for each plant number level and network, we test all possible combinations, as this number is low (n = 63 possible combiations overall for the network with the largest dataset) and increasing sampling events in our simulation would only result in repeated combinations. Then, we test the overall relation between equity in reproductive success and both community-level network metrics we consider: nestedness and functional complementarity within our simulated communities. To this end, for each species number level, we randomly combine the generated equity values across the 16 communities as to obtain one random value per species. Finally, for each of such combinations we calculated the estimate of equity in relation with functional complementarity and average all estimates from 1000 simulated combinations per number of plants considered. We expect that the more plants considered, the larger the resulting average estimates will be. Note that we only interpret the mean effects, as the variance among different plant number of species depends on the initial number of combinations.


#RESULTS

Within our sampling we recorded 57 species of plants and 277 species of pollinators. Within the pollinator community XX% of species were solitary bees, XX% hoverflies and XX%% other??

Our sampling completeness analyses revealed that with our survey we were able to capture 18-62% of pollinator species (average= 35%), 47-98% for plant species (average= 78%) and 13-41% for plant-pollinator links (average=27%), in line with that obtained with other studies (e.g., [@Chacoff2012], Figure S1?). Our values of sampling completeness are slightly smaller in the case of pollinators probably as a consequence of the great diversity found in the Mediterranean region and within our study area in particular, a hotspot of insect diversity (REF).

```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=9}

library(citr) #to include citations. use addins to insert references

#First attempt to load the data, etc...

#prepare stuff-----
#If you don't have devtools install it
#install.packages("devtools")
#library(devtools)
#Then install the data package. Reprot issues 
#install_github("ibartomeus/BeeFunData", ref = "fun")
library(BeeFunData)
library(plyr)




d<-all_interactions
f<-fruitset
s<-seedset


#calculate number of plant and pollinator species in total in our sampling

d.pl<-unique(all_interactions$Plant_gen_sp)
d.poll<-unique(all_interactions$Pollinator_gen_sp)

#calculate number of plant species per site, number of individuals per plant species and number of fruits per ind surveyed for repr succ

library(plyr)

f$Plant.sp<-paste(f$Plant_genus, f$Plant_species)

f.inds<-ddply(f, c("Site_ID", "Plant.sp"), summarise, 
                   tot.inds = length(Plant.sp)) #number of individuals per plant sps

#write.csv(f.inds, file="C:/Users/ainhoa.magrach/Dropbox/Beefun/Beefun/functioning/tables/plantindspersite.csv", row.names = FALSE)

mean<-mean(f.inds$tot.inds)
stdev<-sd(f.inds$tot.inds)


f.sps<-ddply(f.inds, c("Site_ID"), summarise, 
                   tot.sps = length(Site_ID)) #number of plant sps per site


#write.csv(f.sps, file="C:/Users/ainhoa.magrach/Dropbox/Beefun/Beefun/functioning/tables/plantspspersite.csv", row.names = FALSE) 

mean2<-mean(f.sps$tot.sps)
stdev2<-sd(f.sps$tot.sps)
  

s$Plant.sp<-paste(s$Plant_genus, s$Plant_species)

s.fruitnum<-ddply(s, c("Site_ID", "Plant.sp"), summarise, 
                   tot.fruits = length(Plant.ID)) #number of fruits per individual


#write.csv(s.fruitnum, file="C:/Users/ainhoa.magrach/Dropbox/Beefun/Beefun/functioning/tables/fruitnumberperplantindspersite.csv", row.names = FALSE) 

mean3<-mean(s.fruitnum$tot.fruits)
stdev3<-sd(s.fruitnum$tot.fruits)
   
###### read network and species level files (network analyses to be found at "...scripts/network analysis.R")

outsp.pl.site<-read.csv("SITE_plant_species_level_metrics.csv")
outsp.site<-read.csv("SITE_species_level_metrics.csv")
out.site<-read.csv("SITE_network_level_metrics.csv")

#####################################################################################################################
########################CALCULATE SAMPLING COMPLETENESS FOR POLLINATORS, PLANTS AND LINKS #############################
######################################################################################################################

library(iNEXT)
library(ggplot2)
library(grid)

#POLLINATORS
d2<-table(d$Site_ID, d$Pollinator_gen_sp)
d3<-as.data.frame.array(d2)

d4 <- t(d3[,1:277])
#head(d4)
#str(d4)
d5<-as.data.frame(d4)
#str(d5)
d6<-as.list(d5)


rar <- iNEXT(d6, q=0, datatype="abundance", endpoint = 400)
poll<-ggiNEXT.iNEXT(rar, color.var="site", se=FALSE) + ylab("Pollinator species richness") + theme_bw() + 
  theme (legend.position= "none") + theme(text = element_text(size = 15), axis.text=element_text(size=rel(1)),
                                          axis.title.x = element_blank(),
        axis.title=element_text(size=rel(1),face="bold"), legend.direction="horizontal", legend.text=element_text(size=10)) +
  scale_color_manual(values=c("#F1BB7B", "#FD6467", "#5B1A18", "#D67236", "#E6A0C4", "#C6CDF7", "#D8A499", "#7294D4", "#D8B70A", "#02401B", "#A2A475", "#81A88D", "#972D15", "#9C964A", "#CDC08C", "#FAD77B"))

#poll


#per site sampling completeness for pollinators
#Aznalcazar 64/103 = 0.62
#Bonares  54.000/178.701 = 0.30
#ConventodelaLuz  33.000/98.950 = 0.33
#CotitodeSantaTeresa  54.000/190.442 = 0.28
#Elpinar  29.000/158.657= 0.18
#Elpozo  32.000/174.000= 0.18
#Esparragal  39.000/110.859= 0.35
#LaCunya  32.000/118.672= 0.27
#LaRocina  74.000/147.129 = 0.50
#Lasmulas  52.000/127.295 = 0.41
#Niebla  57.000/124.792 = 0.46
#PinaresdeHinojos 40.000/168.852 = 0.24
#Pinodelcuervo  52.000/187.503 = 0.28
#Urbanizaciones  40.000/109.136 = 0.37 
#Villamanriqueeste  62.000/141.310 = 0.44
#Villamanriquesur  48.000/111.326 = 0.43


#(0.62 + 0.30 + 0.33 + 0.28 + 0.18 + 0.18 + 0.35 + 0.27 + 0.50 + 0.41 + 0.46 + 0.24 + 0.28 + 0.37 + 0.44 + 0.43)/16
#TOTAL AVERAGE sampling completeness of pollinators 0.35


#PLANTS
d.pl<-table(d$Site_ID, d$Plant_gen_sp)
d.pl2<-as.data.frame.array(d.pl)

d.pl3 <- t(d.pl2[,1:57])
#head(d.pl3)
#str(d.pl3)
d.pl4<-as.data.frame(d.pl3)
#str(d.pl4)
d.pl5<-as.list(d.pl4)


rar2 <- iNEXT(d.pl5, q=0, datatype="abundance", endpoint = 200)
plant<-ggiNEXT.iNEXT(rar2, color.var="site", se=FALSE) + ylab("Plant species richness") + 
  theme_bw()  + theme (legend.position= "none") + theme(text = element_text(size = 15), axis.text=element_text(size=rel(1)),
                                                         axis.title.x = element_blank(),
        axis.title=element_text(size=rel(1),face="bold"), legend.direction="horizontal", legend.text=element_text(size=10)) +
  scale_color_manual(values=c("#F1BB7B", "#FD6467", "#5B1A18", "#D67236", "#E6A0C4", "#C6CDF7", "#D8A499", "#7294D4", "#D8B70A", "#02401B", "#A2A475", "#81A88D", "#972D15", "#9C964A", "#CDC08C", "#FAD77B"))


#plant


#per site sampling completeness for plants
#Aznalcazar 17.000/18.490 = 0.92
#Bonares  13.000/13.990 = 0.93
#ConventodelaLuz  12.000/13.978 = 0.86
#CotitodeSantaTeresa  10.000/11.973 = 0.84
#Elpinar  11.000/23.255 = 0.47
#Elpozo  11.000 /13.219 = 0.83
#Esparragal  12.000 /16.436 = 0.73
#LaCunya  13.000/21.847 = 0.60
#LaRocina  16.000 /21.959 = 0.73 
#Lasmulas  12.000 /17.940 = 0.67
#Niebla  21.000/21.743 = 0.97
#PinaresdeHinojos 14.000/21.889 = 0.64
#Pinodelcuervo  15.000/27.372 = 0.55
#Urbanizaciones  10.000 /10.247 = 0.98
#Villamanriqueeste  9.000 /10.983 = 0.82
#Villamanriquesur  12.000 /12.989 = 0.92

#(0.92 + 0.93 + 0.86 + 0.84 + 0.47 + 0.83 + 0.73 + 0.60 + 0.73 + 0.67 + 0.97 + 0.64 + 0.55 + 0.98 + 0.82 + 0.92)/16

#TOTAL AVERAGE sampling completeness of plants 0.78


#LINKS

d$link<-paste(d$Plant_gen_sp, d$Pollinator_gen_sp)
d.l<-table(d$Site_ID, d$link)
d.l2<-as.data.frame.array(d.l)

d.l3 <- t(d.l2[,1:750])
#head(d.l3)
#str(d.l3)
d.l4<-as.data.frame(d.l3)
#str(d.l4)
d.l5<-as.list(d.l4)


rar3 <- iNEXT(d.l5, q=0, datatype="abundance", endpoint = 500)
link<-ggiNEXT.iNEXT(rar3, color.var="site", se=FALSE) + ylab("Link richness") + theme_bw() +
   theme (legend.position= "none") + theme(text = element_text(size = 15), axis.text=element_text(size=rel(1)),
        axis.title=element_text(size=rel(1),face="bold"), legend.direction="horizontal", legend.text=element_text(size=10)) +
 scale_color_manual(values=c("#F1BB7B", "#FD6467", "#5B1A18", "#D67236", "#E6A0C4", "#C6CDF7", "#D8A499", "#7294D4", "#D8B70A", "#02401B", "#A2A475", "#81A88D", "#972D15", "#9C964A", "#CDC08C", "#FAD77B"))
  

#link


#per site sampling completeness for links
#Aznalcazar 101.000/244.145 = 0.41
#Bonares  72.000/389.031 = 0.19
#ConventodelaLuz  52.000/221.285 = 0.23
#CotitodeSantaTeresa  64.000/478.893 = 0.13
#Elpinar  37.000/194.026 = 0.19
#Elpozo   46.000/159.994 = 0.29
#Esparragal   52.000/196.900 = 0.26
#LaCunya  44.000/115.025 = 0.38
#LaRocina  98.000/351.931 = 0.28
#Lasmulas  69.000/306.883 = 0.22
#Niebla  84.000/611.776 = 0.14
#PinaresdeHinojos  56.000/186.413 = 0.30
#Pinodelcuervo   77.000/273.425 = 0.28
#Urbanizaciones  55.000/204.100 = 0.27
#Villamanriqueeste  76.000/193.208 = 0.39
#Villamanriquesur  67.000/234.221 = 0.29 

#(0.41 + 0.19 + 0.23 + 0.13 + 0.19 + 0.29 + 0.26 + 0.38 + 0.28 + 0.22 + 0.14 + 0.30 + 0.28 + 0.27 + 0.39 + 0.29)/16

#TOTAL AVERAGE sampling completeness of links 0.27

grid.newpage()
grid.draw(rbind(ggplotGrob(poll), ggplotGrob(plant), ggplotGrob(link), size = "last"))

```

### Species-level analyses

At the species level, our results show that for all measures of reproductive success considered (i.e., fruitset, number of seeds per fruit, fruit and seed weight), the best model based on its AIC value was model 1, i.e., the model that only includes simple visitation metrics (i.e., the diversity of visiting pollinators and the total number of visits received by a focal plant species). In the case of fruitset, we find a positive effect of the diversity of species visiting a focal plant species (measured using the species´normalised degree, Fig. XX). Contrastingly, for seed set, fruit and seed weight we find that none of the variables included within our model explain the differences observed.


```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=5}

#compare 2 models: one with degree, i.e. diversity of partners, and number of visits, compared to one where position in a network (centrality) and niche overlap are included with these variables.

#calculate column with fruit set as
f$Plant.sp<-paste(f$Plant_genus, f$Plant_species)

#Fruit_Yes +  Fruit_Preyed + Fruit_Dispersed) / (Fruit_Yes + Fruit_No +Fruit_Preyed + Fruit_Dispersed) #Nacho this equation is wrong in your metadata!

#1st eliminate frutos perdidos
wordList <- c("fruto perdido","frutos perdidos")

require(Hmisc)
f2<-subset(f, Notes %nin% wordList)

f2$tot.fruitset<-(f2$Fruit_Yes +  f2$Fruit_preyed + f2$Fruit_dispersed)/(f2$Fruit_Yes +f2$Fruit_No + f2$Fruit_preyed + f2$Fruit_dispersed)


#check correlation between different variables

#head(out.site)
#str(out.site)
c<-cor(out.site[,2:20])
c2<-round(c,digits=2)
#write.csv(c2, file= "~/Dropbox/Beefun/Beefun/functioning/tables/variable_correlations.csv", row.names = TRUE, sep = ",")

#♣correlation between weighted nodf and functional complementarity of pollinators : -0.13


#create table with number of individuals per plant species sampled at each site

#tableSx <- aggregate(Plant.ID ~ Site_ID + Plant.sp, data = f2, FUN = function(x){NROW(x)})

#write.csv(tableSx, file= "C:/Users/ainhoa.magrach/Dropbox/Beefun/Beefun/functioning/tables/plantindspersite.csv", row.names = FALSE, sep = ",")

#-------------------------------------------------------------------------------------------
#join plant species level network metrics with fruit and seed set for each site, also with niche overlap and number of visits

#calculate total number of visits per plant sps
d.vis<-ddply(d, c("Site_ID", "Plant_gen_sp"), summarise,
            tot.visits= sum(Frequency))
  
d.vis$j<-paste(d.vis$Site_ID, d.vis$Plant_gen_sp)



#calculate average niche overlap per species 

library(reshape2)
library(spaa)
library(plyr)

sites <- unique(d$Site_ID)

out.niche <- data.frame(Site_id = NA, row = NA, col = NA,value  = NA)

webs <- list()
for(i in 1:length(sites)){
  temp <- subset(d, Site_ID == sites[i])
  temp2<-droplevels(temp)
 
  web <- table(temp2$Pollinator_gen_sp, temp2$Plant_gen_sp)

  ni<-niche.overlap(web, method="morisita")
  df <- melt(as.matrix(ni), varnames = c("row", "col"))
  df$row<-as.character(df$row)
  df$col<-as.character(df$col)
  
  n <- nrow(out.niche)
 
  out.niche[n + seq(nrow(df)),1] <- as.character(sites[i])
  out.niche[n + seq(nrow(df)),2:3] <- (df[,1:2])
  out.niche[n + seq(nrow(df)),4] <-df[,3]
  
}



out.niche.agg <- ddply(out.niche, c("Site_id", "col"), summarise,
               mean.niche.over    = mean(value))


out.niche.agg$j<-paste(out.niche.agg$Site_id, out.niche.agg$col)

#use unaggregated data

f2$functional.comp.poll<-out.site$functional.comp.poll[match(f2$Site_ID, out.site$Site_id)]
f2$nodf.song<-out.site$nodf.song[match(f2$Site_ID, out.site$Site_id)]
f2$species.poll<-out.site$species.poll[match(f2$Site_ID, out.site$Site_id)]

#also match with plant species level network data
f2$match<-paste(f2$Site_ID, f2$Plant.sp)
outsp.pl.site$match<-paste(outsp.pl.site$Site_id, outsp.pl.site$species)

f2$norm_degree<-outsp.pl.site$norm_degree[match(f2$match, outsp.pl.site$match)]
f2$weigh_closeness<-outsp.pl.site$weigh_closeness[match(f2$match, outsp.pl.site$match)]
f2$niche.overlap<-out.niche.agg$mean.niche.over[match(f2$match, out.niche.agg$j)]


f2$tot.visits<-d.vis$tot.visits[match(f2$match, d.vis$j)]
f2$tot.visits[is.na(f2$tot.visits)]<-0


#scale all variables used

f2$functional.comp.poll.sc<-scale(f2$functional.comp.poll, center = T, scale = T)
f2$nodf.song.sc<-scale(f2$nodf.song, center = T, scale = T)
f2$species.poll.sc<-scale(f2$species.poll, center = T, scale = T)


f2$norm_degree.sc<-scale(f2$norm_degree, center = T, scale = T)
f2$weigh_closeness.sc<-scale(f2$weigh_closeness, center = T, scale = T)
f2$niche.overlap.sc<-scale(f2$niche.overlap, center = T, scale = T)


#scale total visits per plant species
library(dplyr)
f2_scaled <- f2 %>% group_by(Plant.sp) %>% mutate(tot.visits.sc = scale(tot.visits, center = T, scale = T))

# 
# #check correlations between different species level variables
# 
#cor(f2[,23:29])

library(psych)
dim(f2)
pairs.panels(f2[,23:28]) 

#fit models 1 and 2 

library(lme4)
library(lmerTest) #to calculate coeff and p values
library(car) #to calculate VIF
library(bbmle)  #to select best model based on AIC
library(ggplot2)
library(DHARMa) #to check for problems in residuals
 
 m1<-glmer(tot.fruitset ~  norm_degree.sc + tot.visits.sc  + (1|Plant.sp:Site_ID) + (1|Site_ID), family="gaussian", data=f2_scaled)

 summary(m1)
 

 vif(m1)  #check for correlations between variables included in model
 
 
 m2<-glmer(tot.fruitset ~  norm_degree.sc  + tot.visits.sc + weigh_closeness.sc + niche.overlap.sc  + (1|Plant.sp:Site_ID) + (1|Site_ID), family="gaussian", data=f2_scaled)
 
 summary(m2)
 
 vif(m2)
 

#select best model based on AIC 

AICtab(m1, m2) 

#test for problems in residuals

# res<-simulateResiduals(m1)
# plot(res, rank = TRUE)


# extract coefficients and p-values for m1 and present them in paper
coefs.m1 <- data.frame(coef(summary(m1)))
# use normal distribution to approximate p-value
coefs.m1$p.z <- 2 * (1 - pnorm(abs(coefs.m1$t.value)))
coefs.m1
summ<-round(coefs.m1,digits=2)
#write.csv(summ, file="C:/Users/ainhoa.magrach/Dropbox/Beefun/Beefun/functioning/tables/resultsfruitsetSPECIES.csv", row.names = TRUE)

#best model is m1, plot significant variable, in this case degree, do partial residual plots to show the effect of that variable in isolation of the others

crPlots(m1, smooth=FALSE, terms = ~  norm_degree.sc, main = "", ylab = "Fruitset", col.lines= "black", pch=19, col= "black", bg = "darkgrey", cex=2, cex.axis=1.2, cex.lab=1.5, 
        xlab = "Pollinator species diversity")  #PROBLEM HERE BECAUSE OF RANDOM EFFECTS, NEED TO CHECK!

#or do original plots, no partial residuals

pl1<-ggplot(f2_scaled,  aes(x=norm_degree.sc, y=tot.fruitset, color=Plant.sp)) +    
        geom_point(size=4) + geom_smooth(method=lm, size=1.5, se=TRUE, color = "black", alpha=0.2) + 
        #geom_smooth(method=lm, linetype= "dashed", size=0.7, se=FALSE, alpha=0.8) +
        xlab("Normalized degree") +      
        ylab("Fruitset") + theme_bw()  + theme (legend.position= c(0.85,0.3)) +
        theme(text = element_text(size = 20), axis.text=element_text(size=rel(1.2)), axis.title=element_text(size=rel(1.3), face="bold")) + labs(col="Plant species") +  theme(legend.text = element_text(size = 10, face = "italic"), legend.title = element_text(size=11, face = "bold"))

pl1

#no color for different species 

pl1b<-ggplot(f2_scaled,  aes(x=norm_degree.sc, y=tot.fruitset)) +    
        geom_point(size=4, color = "darkgrey") + geom_smooth(method=lm,  size=1.5, se=TRUE, color = "black", alpha=0.2) + 
        #geom_smooth(method=lm, linetype= "dashed", size=0.7, se=FALSE, alpha=0.8) +
        xlab("Normalized degree") +      
        ylab("Fruitset") + theme_bw()  + theme (legend.position= "none") +
        theme(text = element_text(size = 20), axis.text=element_text(size=rel(1.2)), axis.title=element_text(size=rel(1.3), face="bold")) 

pl1b

##ahora con seed set

s$Plant.sp<-paste(s$Plant_genus, s$Plant_species)

#1st eliminate frutos perdidos
wordList <- c("fruto perdido","frutos perdidos")

require(Hmisc)
s2<-subset(s, Notes %nin% wordList)

#calculate average seed set per plant individual, there are several fruit measurements per plant and would lead to 3 nested random factors
library(plyr)

s3 <- ddply(s2, c("Site_ID", "Plant.sp", "Plant.ID"), summarise,
                         mean.seedn    = mean(Seeds2),
                          mean.seedw = mean(Seed.weight),
                          mean.fruitweight = mean(Fruit.weight2))


#use unaggregated data

s3$functional.comp.poll<-out.site$functional.comp.poll[match(s3$Site_ID, out.site$Site_id)]
s3$nodf.song<-out.site$nodf.song[match(s3$Site_ID, out.site$Site_id)]
s3$species.poll<-out.site$species.poll[match(s3$Site_ID, out.site$Site_id)]

#also match with plant species level network data
s3$match<-paste(s3$Site_ID, s3$Plant.sp)
outsp.pl.site$match<-paste(outsp.pl.site$Site_id, outsp.pl.site$species)

s3$norm_degree<-outsp.pl.site$norm_degree[match(s3$match, outsp.pl.site$match)]
s3$weigh_closeness<-outsp.pl.site$weigh_closeness[match(s3$match, outsp.pl.site$match)]
s3$niche.overlap<-out.niche.agg$mean.niche.over[match(s3$match, out.niche.agg$j)]


s3$tot.visits<-d.vis$tot.visits[match(s3$match, d.vis$j)]
s3$tot.visits[is.na(s3$tot.visits)]<-0


#scale all variables used

s3$functional.comp.poll.sc<-scale(s3$functional.comp.poll, center = T, scale = T)
s3$nodf.song.sc<-scale(s3$nodf.song, center = T, scale = T)
s3$species.poll.sc<-scale(s3$species.poll, center = T, scale = T)


s3$norm_degree.sc<-scale(s3$norm_degree, center = T, scale = T)
s3$weigh_closeness.sc<-scale(s3$weigh_closeness, center = T, scale = T)
s3$niche.overlap.sc<-scale(s3$niche.overlap, center = T, scale = T)


#scale total visits per plant species
library(dplyr)
s3_scaled <- s3 %>% group_by(Plant.sp) %>% mutate(tot.visits.sc = scale(tot.visits, center = T, scale = T))

s4_scaled <- s3_scaled %>% group_by(Plant.sp) %>% mutate(mean.seedn.sc = scale(mean.seedn, center = T, scale = T))


#fit two models

m1.seed<-glmer(mean.seedn.sc ~  norm_degree.sc + tot.visits.sc  + (1|Plant.sp:Site_ID), family="gaussian", data=s4_scaled)

summary(m1.seed)
 
vif(m1.seed)


m2.seed<-glmer(mean.seedn.sc ~  norm_degree.sc  + tot.visits.sc + weigh_closeness.sc + niche.overlap.sc  + (1|Plant.sp:Site_ID), family="gaussian", data=s4_scaled)
 
summary(m2.seed)
 
vif(m2.seed)
 

AICtab(m1.seed, m2.seed) 

#test for problems in residuals
# res<-simulateResiduals(m1.seed)
# plot(res, rank = TRUE)


# extract coefficients and p-values for m1 and present them in paper
coefs.m1.seed <- data.frame(coef(summary(m1.seed)))
# use normal distribution to approximate p-value
coefs.m1.seed$p.z <- 2 * (1 - pnorm(abs(coefs.m1.seed$t.value)))
coefs.m1.seed
summ.seed<-round(coefs.m1.seed,digits=2)
#write.csv(summ.seed, file="C:/Users/ainhoa.magrach/Dropbox/Beefun/Beefun/functioning/tables/resultsseedsetSPECIES.csv", row.names = TRUE)

#SEED WEIGHT

m1.seed.w<-glmer(mean.seedw ~  norm_degree.sc + tot.visits.sc  + (1|Plant.sp:Site_ID), family="gaussian", data=s3_scaled)

summary(m1.seed.w)
 
vif(m1.seed.w)
 
m2.seed.w<-glmer(mean.seedw ~  norm_degree.sc  + tot.visits.sc + weigh_closeness.sc + niche.overlap.sc  + (1|Plant.sp:Site_ID), family="gaussian", data=s3_scaled)
 
summary(m2.seed.w)
 
vif(m2.seed.w)

#select best model based on AIC 

AICtab(m1.seed.w, m2.seed.w) 

#test for problems in residuals
# res<-simulateResiduals(m1.seed.w)
# plot(res, rank = TRUE)


# extract coefficients and p-values for m1 and present them in paper
coefs.m1.seed.w <- data.frame(coef(summary(m1.seed.w)))
# use normal distribution to approximate p-value
coefs.m1.seed.w$p.z <- 2 * (1 - pnorm(abs(coefs.m1.seed.w$t.value)))
coefs.m1.seed.w
summ.seed.w<-round(coefs.m1.seed.w,digits=2)
#write.csv(summ.seed.w, file="C:/Users/ainhoa.magrach/Dropbox/Beefun/Beefun/functioning/tables/resultsseedweightSPECIES.csv", row.names = TRUE)

#FRUIT WEIGHT

m1.fruit.w<-glmer(mean.fruitweight ~  norm_degree.sc + tot.visits.sc  + (1|Plant.sp:Site_ID), family="gaussian", data=s3_scaled)

summary(m1.fruit.w)
 
vif(m1.fruit.w)


m2.fruit.w<-glmer(mean.fruitweight ~  norm_degree.sc  + tot.visits.sc + weigh_closeness.sc + niche.overlap.sc  + (1|Plant.sp:Site_ID), family="gaussian", data=s3_scaled)
 
summary(m2.fruit.w)
 
vif(m2.fruit.w)

 
#select best model based on AIC 

AICtab(m1.fruit.w, m2.fruit.w) 

#test for problems in residuals
# res<-simulateResiduals(m1.fruit.w)
# plot(res, rank = TRUE)


# extract coefficients and p-values for m1 and present them in paper
coefs.m1.fruit.w <- data.frame(coef(summary(m1.fruit.w)))
# use normal distribution to approximate p-value
coefs.m1.fruit.w$p.z <- 2 * (1 - pnorm(abs(coefs.m1.fruit.w$t.value)))
coefs.m1.fruit.w
summ.fruit.w<-round(coefs.m1.fruit.w,digits=2)
#write.csv(summ.seed.w, file="C:/Users/ainhoa.magrach/Dropbox/Beefun/Beefun/functioning/tables/resultsfruitweightSPECIES.csv", row.names = TRUE)

```

### Network-level analyses

At the network level, we find different patterns for fruitset and the number of seeds per fruit as compared to those for fruit and seed weight. In the case of fruitset and the number of seeds per fruit we find that the best model describing the differences observed is model 2, i.e., that including community-level network attributes in addition to simple visitation metrics. In particular, we find that fruitset is positively related to functional complementarity, while we find a similar yet marginal and non-significant trend in the case of the number of seeds per fruit. Additionally, we find a negative effect of community-level pollinator species diversity on average fruitset. Contrastingly, in the case of weight variables (fruit and seed weight), in both cases we find that the best model is model 1, i.e., that only including simple visitation metrics. Here, we find a consistent positive effect of community-level pollinator diversity for both weight descriptors.  


```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=5}
#####################################################################################################################
######################## NTW STRUCTURE ~ ECOSYSTEM FUNCTION #########################################################
######################################################################################################################

library(plyr)
#this is how i did originally, average of everything together, now following Nacho´s advice changing to mean of means previously calculated per sps

f.agg.prev <- ddply(f2, c("Site_ID", "nodf.song", "functional.comp.poll", "species.poll"), 
                    summarise, tot.visits    = sum(tot.visits),
                         mean.fruitset = mean(tot.fruitset))


#I see what you mean, no weghting for plant species... maybe is good doing it... mean on means? I don't think it will change much the result.
#Doing mean of means here, it does change some values a bit!!
f.ag <- ddply(f2, c("Site_ID", "Plant.sp", "nodf.song", "functional.comp.poll", "species.poll"), 
               summarise, tot.visits    = sum(tot.visits),
                         mean.fruitset = mean(tot.fruitset))

f.agg <- ddply(f.ag, c("Site_ID",  "nodf.song", "functional.comp.poll", "species.poll"), 
               summarise, tot.visits    = sum(tot.visits),
                         mean.fruitset = mean(mean.fruitset))


#scale all variables to be able to compare effect sizes 

f.agg$nodf.song.sc <- scale(f.agg$nodf.song, center = T, scale = T)
f.agg$functional.comp.poll.sc <- scale(f.agg$functional.comp.poll, center = T, scale = T)
f.agg$species.poll.sc <- scale(f.agg$species.poll, center = T, scale = T)
f.agg$tot.visits.sc <- scale(f.agg$tot.visits, center = T, scale = T)


#average FRUITset

m1.fruit.net<-glm(mean.fruitset ~  species.poll.sc + tot.visits.sc, family="gaussian", data=f.agg)

summary(m1.fruit.net)
 
vif(m1.fruit.net)
 
m2.fruit.net<-glm(mean.fruitset ~  species.poll.sc + tot.visits.sc + nodf.song.sc + functional.comp.poll.sc, family="gaussian", data=f.agg)

#note estimate of niche part do not overlap zero 0.06105  +-  0.03637 and it's moderatelly big.
 
summary(m2.fruit.net)
 
vif(m2.fruit.net)
 
#select best model based on AIC 

AICtab(m1.fruit.net, m2.fruit.net) #Almost as good. The take home message would be. If interested in predictions, go for simplicity. If interested in mechanisms, nich part is a mechanism to take into account.

#when changing values to mean of means actually model2 is best and funct compl is significant!! YUHUUUU

#save table with results for paper
summ.fruit.net<-round(summary(m2.fruit.net)$coef, digits=2)
#write.csv(summ.fruit.net, file="C:/Users/ainhoa.magrach/Dropbox/Beefun/Beefun/functioning/tables/resultsfruitsetNETWORK.csv", row.names = TRUE)



#TRYING TO MANUALLY CREATE PARTIAL RESIDUAL PLOTS

pred<-m2.fruit.net$coef[1]+ (m2.fruit.net$coef[2] * mean(f.agg$species.poll.sc)) + (m2.fruit.net$coef[3] * mean(f.agg$tot.visits.sc)) + (m2.fruit.net$coef[4]* mean(f.agg$nodf.song.sc)) + (m2.fruit.net$coef[5] * f.agg$functional.comp.poll.sc)

res<-pred-f.agg$mean.fruitset
  


pl2 <- ggplot(f.agg,  aes(x=functional.comp.poll.sc, y= res)) +    
        geom_point(size=4, color="darkgrey") + 
  stat_smooth(method = 'lm', size=1.5, se=TRUE, color = "black", alpha=0.2) +     
        xlab("Functional complementarity") +      
        ylab("Fruitset") + theme_bw()  + #theme (legend.position= "none") +
        theme(text = element_text(size = 20), axis.text=element_text(size=rel(1.2)), axis.title=element_text(size=rel(1.3), face="bold")) 

pl2

#SPECIFIC PACKAGE TO DO PARTIAL RES PLOTS BUT DIFFICULT TO CUSTOMIZE


#partial residual plots to see real value of each variable eliminating noise from others
library(car)

crPlots(m2.fruit.net, smooth=FALSE, terms = ~  species.poll.sc + functional.comp.poll.sc, main = "", ylab = "Mean fruitset", col.lines= "black", pch=19, col= "black", bg = "darkgrey", cex=2, cex.axis=1.2, cex.lab=1.5, 
        xlab = c("Pollinator diversity", "Functional complementarity"))


#ORINGINAL PLOTS DO NOT SHOW EFFECTS OF VARIABLES IN ISOLATION

pl2<-ggplot(f.agg,  aes(x=species.poll.sc, y=mean.fruitset)) +    
        geom_point(size=4, color="darkgrey") + geom_smooth(method=lm, size=1.5, se=TRUE, color = "black", alpha=0.2) + 
        xlab("Pollinator species diversity") +      
        ylab("Fruitset") + theme_bw()  + #theme (legend.position= "none") +
        theme(text = element_text(size = 20), axis.text=element_text(size=rel(1.2)), axis.title=element_text(size=rel(1.3), face="bold")) 

pl2

pl2b <-ggplot(f.agg,  aes(x=functional.comp.poll.sc, y=mean.fruitset)) +    
        geom_point(size=4, color="darkgrey") + geom_smooth(method=lm, size=1.5, se=TRUE, color = "black", alpha=0.2) + 
        xlab("Functional complementarity") +      
        ylab("Fruitset") + theme_bw()  + #theme (legend.position= "none") +
        theme(text = element_text(size = 20), axis.text=element_text(size=rel(1.2)), axis.title=element_text(size=rel(1.3), face="bold")) 

pl2b #Well, moderate... without scaling it was more pronunced?

#test for problems in residuals
# res<-simulateResiduals(m2.fruit.net)
# plot(res, rank = TRUE)



#seed number
#How mean seed number is calculated?? scaled first would be better, right? Yes using scaled values

#same as before now averaging per species first and then per site 

library(plyr)

s.comm.prev <- ddply(s4_scaled, c("Site_ID", "nodf.song", "functional.comp.poll", "species.poll"), summarise, tot.visits    = sum(tot.visits),
                         mean.seedset = mean(mean.seedn),
                          mean.seedweight = mean(mean.seedw),
                          mean.fruitweight = mean(mean.fruitweight))


#mean of means!

s.com <- ddply(s4_scaled, c("Site_ID", "Plant.sp", "nodf.song", "functional.comp.poll", "species.poll"), 
               summarise, tot.visits    = sum(tot.visits),
                         mean.seedset = mean(mean.seedn),
                          mean.seedweight = mean(mean.seedw),
                          mean.fruitweight = mean(mean.fruitweight))


s.comm <- ddply(s.com, c("Site_ID", "nodf.song", "functional.comp.poll", "species.poll"), 
               summarise, tot.visits    = sum(tot.visits),
                         mean.seedset = mean(mean.seedset),
                          mean.seedweight = mean(mean.seedweight),
                          mean.fruitweight = mean(mean.fruitweight))



#scale variables for comparison of effect sizes

s.comm$nodf.song.sc <- scale(s.comm$nodf.song, center = T, scale = T)
s.comm$functional.comp.poll.sc <- scale(s.comm$functional.comp.poll, center = T, scale = T)
s.comm$species.poll.sc <- scale(s.comm$species.poll, center = T, scale = T)
s.comm$tot.visits.sc <- scale(s.comm$tot.visits, center = T, scale = T)


#average seed set

m1.seed.net<-glm(mean.seedset ~  species.poll.sc + tot.visits.sc, family="gaussian", data=s.comm)

summary(m1.seed.net)

vif(m1.seed.net)
 
m2.seed.net<-glm(mean.seedset ~  species.poll.sc + tot.visits.sc + nodf.song.sc + functional.comp.poll.sc, family="gaussian", data=s.comm)
 
summary(m2.seed.net)
 
vif(m2.seed.net)
 
#select best model based on AIC 

AICtab(m1.seed.net, m2.seed.net)

#test for problems in residuals
# res<-simulateResiduals(m2.seed.net)
# plot(res, rank = TRUE)


#save table with results for paper
summ.seed.net<-round(summary(m2.seed.net)$coef, digits=2)
#write.csv(summ.seed.net, file="C:/Users/ainhoa.magrach/Dropbox/Beefun/Beefun/functioning/tables/resultsseedsetNETWORK.csv", row.names = TRUE)

#functional comp only marginally significant so no plot here but just to see partial residual plot

crPlots(m2.seed.net, smooth=FALSE, terms = ~  functional.comp.poll.sc, main = "", ylab = "Mean number of seeds per fruit", col.lines= "black", pch=19, col= "black", bg = "darkgrey", cex=2, cex.axis=1.2, cex.lab=1.5, 
        xlab = "Functional complementarity")

#fruit weight


m1.fruitw.net<-glm(mean.fruitweight ~  species.poll.sc + tot.visits.sc, family="gaussian", data=s.comm)

summary(m1.fruitw.net)
 
 vif(m1.fruitw.net)
 
m2.fruitw.net<-glm(mean.fruitweight ~  species.poll.sc + tot.visits.sc + nodf.song.sc + functional.comp.poll.sc, family="gaussian", data=s.comm)
 
 summary(m2.fruitw.net)
 
 vif(m2.fruitw.net)
 
#select best model based on AIC 

AICtab(m1.fruitw.net, m2.fruitw.net)

#test for problems in residuals
# res<-simulateResiduals(m1.fruitw.net)
# plot(res, rank = TRUE)


#save table with results for paper
summ.fruitw.net<-round(summary(m1.fruitw.net)$coef, digits=2)
#write.csv(summ.fruitw.net, file="C:/Users/ainhoa.magrach/Dropbox/Beefun/Beefun/functioning/tables/resultsfruitweightNETWORK.csv", row.names = TRUE)


crPlots(m1.fruitw.net, smooth=FALSE, terms = ~  species.poll.sc, main = "", ylab = "Mean fruit weight", col.lines= "black", pch=19, col= "black", bg = "darkgrey", cex=2, cex.axis=1.2, cex.lab=1.5, 
        xlab = "Pollinator species diversity")


pl4<-ggplot(s.comm,  aes(x=species.poll.sc, y=mean.fruitweight))+      
        geom_point(size=4, color="darkgrey") + geom_smooth(method=lm, size=1.5, se=TRUE, color = "black", alpha=0.2) + 
        #geom_smooth(method=lm, linetype= "dashed", size=0.7, se=FALSE, alpha=0.8) +
        xlab("Pollinator species diversity") +      
        ylab("Fruit weight (g)") + theme_bw()  + #theme (legend.position= "none") +
        theme(text = element_text(size = 20), axis.text=element_text(size=rel(1.2)), axis.title=element_text(size=rel(1.3), face="bold")) + labs(col="Plant species")

pl4


#seed weight


m1.seedw.net<-glm(mean.seedweight ~  species.poll.sc + tot.visits.sc, family="gaussian", data=s.comm)

summary(m1.seedw.net)
 
 
vif(m1.seedw.net)
 
m2.seedw.net<-glm(mean.seedweight ~  species.poll.sc + tot.visits.sc + nodf.song.sc + functional.comp.poll.sc, family="gaussian", data=s.comm)
 
summary(m2.seedw.net)
 
vif(m2.seedw.net)
 
#select best model based on AIC 

AICtab(m1.seedw.net, m2.seedw.net)

#test for problems in residuals
# res<-simulateResiduals(m1.seedw.net)
# plot(res, rank = TRUE)

#save table with results for paper
summ.seedw.net<-round(summary(m1.seedw.net)$coef, digits=2)
#write.csv(summ.fruitw.net, file="C:/Users/ainhoa.magrach/Dropbox/Beefun/Beefun/functioning/tables/resultsseedweightNETWORK.csv", row.names = TRUE)


crPlots(m1.seedw.net, smooth=FALSE, terms = ~  species.poll.sc, main = "", ylab = "Mean seed weight", col.lines= "black", pch=19, col= "black", bg = "darkgrey", cex=2, cex.axis=1.2, cex.lab=1.5, 
        xlab = "Pollinator species diversity")


pl5<-ggplot(s.comm,  aes(x=species.poll.sc, y=mean.seedweight))+      
        geom_point(size=4, color="darkgrey") + geom_smooth(method=lm, size=1.5, se=TRUE, color = "black", alpha=0.2) + 
        #geom_smooth(method=lm, linetype= "dashed", size=0.7, se=FALSE, alpha=0.8) +
        xlab("Pollinator species diversity") +      
        ylab("Seed weight (g)") + theme_bw()  + #theme (legend.position= "none") +
        theme(text = element_text(size = 20), axis.text=element_text(size=rel(1.2)), axis.title=element_text(size=rel(1.3), face="bold")) + labs(col="Plant species")

pl5

```

### Equity in fruitset

When evaluating the effect of differences in community composition and structure for equity in reproductive success across the different plant species, we find that both model 1 and model 2 are equally good (AIC diff < 2) and thus we cannot select one over the other. This suggests that, the penalty that should be given to model 2 given its greater complexity (greater number of variables) is smaller than the additional information that is being provided by including data on community structure. Specifically, regarding the results for model 2 we find a significant and positive effect of both the total number of visits received by the community and the functional complementarity within it (mean +- sd not overlapping 0, Table X, Fig. X). This effect that we find when using a 50% threshold of productivity (i.e., when looking at plant species that are producing 50% of the maximum fruitset observed for the area), is maintained when using 25 and 75% thresholds. In the case of the 75% thershold we find an additional positive effect of pollinator species diversity. 

ALL THESE RESULTS NOW CHANGE WHEN USING PROPORTION OF SPS RATHER THAN NUMBER, NOTHING IS SIG :()


```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=5}
#calculate column with fruit set as
f$Plant.sp<-paste(f$Plant_genus, f$Plant_species)

#Fruit_Yes +  Fruit_Preyed + Fruit_Dispersed) / (Fruit_Yes + Fruit_No +Fruit_Preyed + Fruit_Dispersed) #Nacho this equation is wrong in your metadata!

#1st eliminate frutos perdidos
wordList <- c("fruto perdido","frutos perdidos")

require(Hmisc)
f2<-subset(f, Notes %nin% wordList)

f2$tot.fruitset<-(f2$Fruit_Yes +  f2$Fruit_preyed + f2$Fruit_dispersed)/(f2$Fruit_Yes +f2$Fruit_No + f2$Fruit_preyed + f2$Fruit_dispersed)

library(vegan)
library(dplyr)

f2$Plant.sp<-paste(f2$Plant_genus, f2$Plant_species)
f3<-f2[,c(1,13:14)]

f4 <- ddply(f3, c("Site_ID", "Plant.sp"), summarise,
                         mean.fruitset    = mean(tot.fruitset))


#f4

fr.max<-aggregate(.~ Plant.sp, f4, FUN=max)

f4$fruit.max<-fr.max$mean.fruitset[match(f4$Plant.sp, fr.max$Plant.sp)]

f4$fruit.prop<-f4$mean.fruitset/f4$fruit.max
f5<-subset(f4, f4$fruit.prop>0.5)
f5$no_rows<-rep(1, nrow(f5))
head(f5)

#NOTE TO SELF: Here is where we want to subsample 1 to 6 species per site to test the idea of increasing plants, complementarity increase.

#for each site here is the number of sps whose fruitset exceeds 50% of maximum fruitset observed in the whole study area
f6<- aggregate(no_rows ~ Site_ID, f5, length)
head(f6)

#because when calculating thresholds, sites with 6 plants can score up to 6, but sites with 4 sites can oscar max = 4 we corrected for this doing % above threshold, and no number. 

f4$no_rows<-rep(1, nrow(f4))
f4b<- aggregate(no_rows ~ Site_ID, f4, length)
head(f4b)

f6$total.plant.numb<-f4b$no_rows[match(f6$Site_ID, f4b$Site_ID)]
f6$equity<-f6$no_rows/f6$total.plant.numb

#join this with fruitset data used previously

f6$nodf.song<-out.site$nodf.song[match(f6$Site_ID, out.site$Site_id)]
f6$functional.comp.poll<-out.site$functional.comp.poll[match(f6$Site_ID, out.site$Site_id)]
f6$species.poll<-out.site$species.poll[match(f6$Site_ID, out.site$Site_id)]
f6$tot.visits<-f.agg$tot.visits[match(f6$Site_ID, f.agg$Site_ID)]

#scale all variables

f6$nodf.song.sc <- scale(f6$nodf.song, center = T, scale = T)
f6$functional.comp.poll.sc <- scale(f6$functional.comp.poll, center = T, scale = T)
f6$species.poll.sc <- scale(f6$species.poll, center = T, scale = T)
f6$tot.visits.sc <- scale(f6$tot.visits, center = T, scale = T)

#fit two models
 m1.eq<-glm(equity ~  species.poll.sc + tot.visits.sc, family="binomial", data=f6)

 summary(m1.eq)
 

vif(m1.eq)
 
m2.eq<-glm(equity ~  species.poll.sc + tot.visits.sc + nodf.song.sc + functional.comp.poll.sc, family="binomial", data=f6)
 #nich estimate not overlaping zero: 0.6178     0.4354, second higher effect size!
summary(m2.eq)
 
 
vif(m2.eq)
 
#select best model based on AIC 

AICtab(m1.eq, m2.eq) #Almost equal... Again, for prediction, go with the simple, for mechanistic understanding, look into niche partitioning. 



#save table with results for paper, both models are equally good so save both tables
summ.eq<-round(summary(m1.eq)$coef, digits=2)
#write.csv(summ.eq, file="C:/Users/ainhoa.magrach/Dropbox/Beefun/Beefun/functioning/tables/resultsequityNETWORKm1.csv", row.names = TRUE)

summ.eq2<-round(summary(m2.eq)$coef, digits=2)
#write.csv(summ.eq2, file="C:/Users/ainhoa.magrach/Dropbox/Beefun/Beefun/functioning/tables/resultsequityNETWORKm2.csv", row.names = TRUE)

#partial residual plots

crPlots(m2.eq, smooth=FALSE, terms = ~  tot.visits.sc + functional.comp.poll.sc, main = "", ylab = "Equity in fruitset", col.lines= "black", pch=19, col= "black", bg = "darkgrey", cex=2, cex.axis=1.2, cex.lab=1.5)

pl.th_ <-ggplot(f6,  aes(x=functional.comp.poll.sc, y=no_rows))+      
        geom_point(size=4, color="darkgrey") + geom_smooth(method=lm, size=1.5, se=TRUE, color = "black", alpha=0.2) + 
        xlab("Functional complementarity") +      
        ylab("Equity in fruitset") + theme_bw() + 
        theme(text = element_text(size = 20), axis.text=element_text(size=rel(1.2)), axis.title=element_text(size=rel(1.3), face="bold")) 

pl.th_ #oh yeah!

pl.th<-ggplot(f6,  aes(x=tot.visits.sc, y=no_rows))+      
        geom_point(size=4, color="darkgrey") + geom_smooth(method=lm, size=1.5, se=TRUE, color = "black", alpha=0.2) + 
        xlab("Total number of visits") +      
        ylab("Equity in fruitset") + theme_bw() + 
        theme(text = element_text(size = 20), axis.text=element_text(size=rel(1.2)), axis.title=element_text(size=rel(1.3), face="bold")) 

pl.th

-------------------------------------------------------------------------------


m3.eq_ <-glm(no_rows ~ functional.comp.poll.sc, family="gaussian", data=f6)
 #Oh yeah. It works for doing my null simulation.
 summary(m3.eq_)

#test for problems in residuals
# res<-simulateResiduals(m1.eq)
# plot(res, rank = TRUE)

# 
# #check whether it is driven by that one point with large number of visits
# 
# f7 <- subset(f6, f6$tot.visits.sc < 2)
# 
#  m1.eqb<-glm(no_rows ~  species.poll.sc + tot.visits.sc, family="gaussian", data=f7)
# 
#  summary(m1.eqb)
#  
#  
#  
# pl.th2<-ggplot(f7,  aes(x=tot.visits.sc, y=no_rows))+      
#         geom_point(size=4, color="darkgrey") + geom_smooth(method=lm, size=1.5, se=TRUE, color = "black", alpha=0.2) + 
#         xlab("Total number of visits") +      
#         ylab("Equity in fruitset") + theme_bw() + 
#         theme(text = element_text(size = 20), axis.text=element_text(size=rel(1.2)), axis.title=element_text(size=rel(1.3), face="bold")) 
# 
# pl.th2
# 


#Repeat with 75% threshold

f75<-subset(f4, f4$fruit.prop>0.75)
f75$no_rows<-rep(1, nrow(f75))
head(f75)


#for each site here is the number of sps whose fruitset exceeds 75% of maximum fruitset observed in the whole study area
f75b<- aggregate(no_rows ~ Site_ID, f75, length)
head(f75b)
f75b$total.numb.plants<-f6$total.plant.numb[match(f75b$Site_ID, f6$Site_ID)]
f75b$equity<-f75b$no_rows/f75b$total.numb.plants

#join this with fruitset data used previously

f75b$nodf.song<-out.site$nodf.song[match(f75b$Site_ID, out.site$Site_id)]
f75b$functional.comp.poll<-out.site$functional.comp.poll[match(f75b$Site_ID, out.site$Site_id)]
f75b$species.poll<-out.site$species.poll[match(f75b$Site_ID, out.site$Site_id)]
f75b$tot.visits<-f.agg$tot.visits[match(f75b$Site_ID, f.agg$Site_ID)]

#scale all variables

f75b$nodf.song.sc <- scale(f75b$nodf.song, center = T, scale = T)
f75b$functional.comp.poll.sc <- scale(f75b$functional.comp.poll, center = T, scale = T)
f75b$species.poll.sc <- scale(f75b$species.poll, center = T, scale = T)
f75b$tot.visits.sc <- scale(f75b$tot.visits, center = T, scale = T)


 m1.eq.75<-glm(equity ~  species.poll.sc + tot.visits.sc, family="gaussian", data=f75b)

 summary(m1.eq.75)

 vif(m1.eq.75)
 
m2.eq.75<-glm(equity ~  species.poll.sc + tot.visits.sc + nodf.song.sc + functional.comp.poll.sc, family="gaussian", data=f75b)
 
 summary(m2.eq.75)
 
 vif(m2.eq.75)
 
#select best model based on AIC 

AICtab(m1.eq.75, m2.eq.75) #as before both models are equally good.

# #test for problems in residuals
# res<-simulateResiduals(m1.eq.75)
# plot(res, rank = TRUE)

#and for 25% threshold

f25<-subset(f4, f4$fruit.prop>0.25)
f25$no_rows<-rep(1, nrow(f25))
head(f25)


#for each site here is the number of sps whose fruitset exceeds 25% of maximum fruitset observed in the whole study area
f25b<- aggregate(no_rows ~ Site_ID, f25, length)
head(f25b)
f25b$total.numb.plants<-f6$total.plant.numb[match(f25b$Site_ID, f6$Site_ID)]
f25b$equity<-f25b$no_rows/f25b$total.numb.plants


f25b$nodf.song<-out.site$nodf.song[match(f25b$Site_ID, out.site$Site_id)]
f25b$functional.comp.poll<-out.site$functional.comp.poll[match(f25b$Site_ID, out.site$Site_id)]
f25b$species.poll<-out.site$species.poll[match(f25b$Site_ID, out.site$Site_id)]
f25b$tot.visits<-f.agg$tot.visits[match(f25b$Site_ID, f.agg$Site_ID)]

#scale all variables

f25b$nodf.song.sc <- scale(f25b$nodf.song, center = T, scale = T)
f25b$functional.comp.poll.sc <- scale(f25b$functional.comp.poll, center = T, scale = T)
f25b$species.poll.sc <- scale(f25b$species.poll, center = T, scale = T)
f25b$tot.visits.sc <- scale(f25b$tot.visits, center = T, scale = T)


 m1.eq.25<-glm(equity ~  species.poll.sc + tot.visits.sc, family="gaussian", data=f25b)

 summary(m1.eq.25)
 
  vif(m1.eq.25)
 
m2.eq.25<-glm(equity ~  species.poll.sc + tot.visits.sc + nodf.song.sc + functional.comp.poll.sc, family="gaussian", data=f25b)
 
 summary(m2.eq.25)
 
 vif(m2.eq.25)
 
#select best model based on AIC 

AICtab(m1.eq.25, m2.eq.25)

#test for problems in residuals
# res<-simulateResiduals(m1.eq.25)
# plot(res, rank = TRUE)



##equity in seed number

library(vegan)
library(dplyr)


s5 <- ddply(s4_scaled, c("Site_ID", "Plant.sp", "functional.comp.poll.sc", "nodf.song.sc", "species.poll.sc", "tot.visits.sc"), summarise,
                         mean.seedset    = mean(mean.seedn))



s5.max<-aggregate(.~ Plant.sp, s5, FUN=max)

s5$seed.max<-s5.max$mean.seedset[match(s5$Plant.sp, s5.max$Plant.sp)]

s5$seed.prop<-s5$mean.seedset/s5$seed.max
s6<-subset(s5, s5$seed.prop>0.5)
s6$no_rows<-rep(1, nrow(s6))
head(s6)


#for each site here is the number of sps whose seedset exceeds 50% of maximum seedset observed in the whole study area
s7<- aggregate(no_rows ~ Site_ID, s6, length)
head(s7)


#calculate proportion of sps at threshold because number depends on number of sps per site which is different

s5$no_rows<-rep(1, nrow(s5))
s5b<- aggregate(no_rows ~ Site_ID, s5, length)
head(s5b)

s7$total.plant.numb<-s5b$no_rows[match(s7$Site_ID, s5b$Site_ID)]
s7$equity<-s7$no_rows/s7$total.plant.numb

#join this with fruitset data used previously

s7$nodf.song<-out.site$nodf.song[match(s7$Site_ID, out.site$Site_id)]
s7$functional.comp.poll<-out.site$functional.comp.poll[match(s7$Site_ID, out.site$Site_id)]
s7$species.poll<-out.site$species.poll[match(s7$Site_ID, out.site$Site_id)]
s7$tot.visits<-f.agg$tot.visits[match(s7$Site_ID, f.agg$Site_ID)]

#scale all variables

s7$nodf.song.sc <- scale(s7$nodf.song, center = T, scale = T)
s7$functional.comp.poll.sc <- scale(s7$functional.comp.poll, center = T, scale = T)
s7$species.poll.sc <- scale(s7$species.poll, center = T, scale = T)
s7$tot.visits.sc <- scale(s7$tot.visits, center = T, scale = T)


#fit two models
 
 m1.eq.seed<-glm(equity ~  species.poll.sc + tot.visits.sc, family="binomial", data=s7)

 summary(m1.eq.seed)
 

 vif(m1.eq.seed)
 
m2.eq.seed<-glm(equity ~  species.poll.sc + tot.visits.sc + nodf.song.sc + functional.comp.poll.sc, family="binomial", data=s7)
 
 summary(m2.eq.seed)
 
 vif(m2.eq)
 
#select best model based on AIC 

AICtab(m1.eq.seed, m2.eq.seed)

#test for problems in residuals
# res<-simulateResiduals(m1.eq.seed)
# plot(res, rank = TRUE)



```

Now, we ask if the effect of niche complementariety increases with the number of species considered in the network. We expect that for any single species, the effect should be almost zero (as shown in our single species analysis above), but when you take into account up to 6 species, network metrics start to be important (see also above the community level results). This implies that if we would be able to measure reproductive success on all plant species in the community in all networks (not done for effort constrains) the effects of network configuartion may be even more prevalent. To test this, we ran a simple simulation where we first increase randomly the number of selected species per network and calculate the equitativity for each run. Instead of drawing random plants for each run, for each plant number level and network we test all possible combinations, as this number is low (n = 63 possible combiations overall for the network with the largest dataset) and increasing sampling events in our simulation would only result in repeated combinations. Second, we test the overall relation between equitativity in fruit set and niche complementariety in our simulated communities. To this end, for each species number level, we randomly combine the generated equitativity values across the 16 communities as to obtain one random value per species. Finally, for each of such combinations we calculated the estimate of equitativity in relation with niche partitioning and average all estimates from 1000 simulated combinations per number of plants considered. We expect that the more plants considered, the larger are the resulting average estimates. Note that We only interpret the mean effects, as the variance among different plant number of species depends on the initial number of combinations.

I ALSO INCLUDED HERE NESTEDNESS WHICH STARTS AS LESS IMPORTANT AND THEN BECOMES MORE IMPORTANT WITH NO ASYMPTOTE.

ONE QUESTION, WHY DO WE DO THIS SIMULATION ONLY FOR EQUITY AND NOT ALSO FOR AVERAGE REP SUCCESS?



```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=5}

library(vegan)
library(dplyr)

f2$Plant.sp<-paste(f2$Plant_genus, f2$Plant_species)
f3<-f2[,c(1,13:14)]

f4 <- ddply(f3, c("Site_ID", "Plant.sp"), summarise,
                         mean.fruitset    = mean(tot.fruitset))

table(f4$Plant.sp)
#Astragalus lusitanicus and Cistus albidus is causing problems later on. It has a very low fruit set, but as there is only one value, when correcting for max fruit set, gets a value of 1. Both are in Cotito... This is problematic. Similar with Anchusa azurea. 

#I am removing them here.
f4 <- subset(f4, !Plant.sp %in% c("Astragalus lusitanicus", "Cistus albidus", "Anchusa azurea"))
#Alternative, we use raw values (not dividing by max.)

#Ainhoa, another question, this is a mean per species, right? So, for some species we may have more than one value. 


#f4

fr.max<-aggregate(.~ Plant.sp, f4, FUN=max)

f4$fruit.max<-fr.max$mean.fruitset[match(f4$Plant.sp, fr.max$Plant.sp)]

f4$fruit.prop<-f4$mean.fruitset/f4$fruit.max
head(f4) #this is ok, I guess, but imply we are correcting for differences in production across plants. 

#Quick dirty fix to see if things change a lot for uncorrected values
#f4$fruit.prop <- f4$mean.fruitset
  
#1) First let's calculate all combinations of 1,2,3,4,5,6 species per network.
combinatorials_all <-  matrix(ncol = 6, nrow = 1, NA) 
colnames(combinatorials_all) <- c("SiteID", "Plant_number_level", "iteration", "equity", "functional.comp", "nestedness")
uniqueSite_ID <- unique(f4$Site_ID)
for(k in 1:length(uniqueSite_ID)){ #sites
  Site_temp <- subset(f4, Site_ID == uniqueSite_ID[k]) #1:SiteID
  n <- length(Site_temp$Plant.sp)
  combinatorials <- matrix(ncol = 6, nrow = 1, NA) #flexible
  colnames(combinatorials) <- c("SiteID", "Plant_number_level", "iteration", "equity", "functional.comp", "nestedness")
  combinatorials <- as.data.frame(combinatorials)
  for (i in 1:n){ #levels
    combinatorials_1 <- combn(x = Site_temp$Plant.sp, m = i) #1:n
    for (j in 1:ncol(combinatorials_1)){ #different combinations
      temp1 <- Site_temp[which(Site_temp$Plant.sp %in% combinatorials_1[,j]),]
      combinatorials_2 <- subset(temp1, temp1$fruit.prop > 0.5)
      if(dim(combinatorials_2)[1] == 0) {
        combinatorials_2 <- temp1
        combinatorials_2$no_rows <- 0
      } else{
        combinatorials_2$no_rows<-rep(1, nrow(combinatorials_2))
      }
      #head(combinatorials_2)
      #for each site here is the number of sps whose fruitset exceeds 50% of maximum fruitset observed in the whole study area
      combinatorials_3 <- aggregate(no_rows ~ Site_ID, combinatorials_2, sum)
      #head(combinatorials_3)
      combinatorials_3$functional.comp.poll <- out.site$functional.comp.poll[match(combinatorials_3$Site_ID, out.site$Site_id)]
      combinatorials_3$nestedness <- out.site$nodf.song[match(combinatorials_3$Site_ID, out.site$Site_id)]
      #now save for later.
      index <- dim(combinatorials)[1]
      combinatorials[index+1,1] <-  as.character(combinatorials_3$Site_ID) #1:SiteID
      combinatorials[index+1,2] <-  i #Plant number level
      #combinatorials[index+1,3] <-    #"iteration" let's asume we don' care, but would be good for unit testing
      combinatorials[index+1,4] <- combinatorials_3$no_rows/i #above threshold in %
      combinatorials[index+1,5] <-  combinatorials_3$functional.comp.poll #nich comp value...
      combinatorials[index+1,6] <-  combinatorials_3$nestedness #nestedness value...
    } #close different combinations
  } #close levels
  combinatorials_all <- rbind(combinatorials_all, combinatorials[-1,])
} #close sites

combinatorials_all <- combinatorials_all[-1,]

#plot overall (asi a saco)

scatter.smooth(combinatorials_all$equity ~ combinatorials_all$functional.comp) #no relationship, good
scatter.smooth(combinatorials_all$equity ~ combinatorials_all$nestedness) #no relationship, good


#scale variables

combinatorials_all$functional.comp.sc<-scale(combinatorials_all$functional.comp, center = T, scale = T)
combinatorials_all$nestedness.sc<-scale(combinatorials_all$nestedness, center = T, scale = T)


#now try overall, per level.
estimate <- rep(NA,6)
for (i in unique(combinatorials_all$Plant_number_level)){
  temp <- subset(combinatorials_all, Plant_number_level == i)
  m <- lm(temp$equity ~ temp$functional.comp.sc)
  plot(temp$equity ~ temp$functional.comp.sc) 
  abline(m)
  estimate[i] <- m$coefficients[2]
  }

plot(unique(combinatorials_all$Plant_number_level) , estimate, las = 1, ylim = c(0, 0.1) ,
     ylab = "importance of niche partitioning", xlab = "number of plants considered")



#now try overall, per level.
estimate <- rep(NA,6)
for (i in unique(combinatorials_all$Plant_number_level)){
  temp <- subset(combinatorials_all, Plant_number_level == i)
  m <- lm(temp$equity ~ temp$nestedness.sc)
  plot(temp$equity ~ temp$nestedness.sc) 
  abline(m)
  estimate[i] <- m$coefficients[2]
  }

plot(unique(combinatorials_all$Plant_number_level) , estimate,  las = 1, ylim = c(0, 0.1) ,
     ylab = "importance of nestedness", xlab = "number of plants considered")

# I think this is a true pattern, as the for the cnetral limit theorem a mean of means should equal the grand mean, but worth check it.

#now we subsample 16 combinations at a time 100 timeas and make the average.
estimate_i <- data.frame(level = NA, estimate = NA)
estimate_k <- data.frame(level = NA, estimate = NA)
head(combinatorials_all)
for (i in 1:length(unique(combinatorials_all$Plant_number_level))){ # over levels
  temp <- subset(combinatorials_all, Plant_number_level == unique(combinatorials_all$Plant_number_level)[i])
  for(k in 1:100){ #iterations
    value <- data.frame(site = NA, eq = NA, nich = NA)
    for(j in 1:length(unique(temp$SiteID))){ # over sites
      temp2 <- subset(temp, SiteID == unique(temp$SiteID)[j]) #why only one record at Elpinar??
      value_temp <- temp2[sample(x = 1:nrow(temp2), 1),]
      value[j,1] <- value_temp$SiteID
      value[j,2] <- value_temp$equity
      value[j,3] <- value_temp$functional.comp
    } #close sites
    m <- lm(value$eq ~ value$nich)
    #plot(value$eq ~ value$nich)
    estimate_k[k,1] <- i
    estimate_k[k,2] <- m$coefficients[2]  
  } #close iteration
  #unique(estimate_k) #only 5 unique ombinations for n = 5. All negative. highly influenced by one data point of low niche part and equ = 1. "CotitodeSantaTeresa"
  #subset(f4, Site_ID == "CotitodeSantaTeresa") #Super high values!
  estimate_mean <- aggregate(estimate ~ level, estimate_k, mean)
  estimate_i[i,1] <- estimate_mean$level
  estimate_i[i,2] <- estimate_mean$estimate
  }

estimate_i

plot(estimate_i$level, estimate_i$estimate, las = 1,
     ylab = "importance of niche partitioning", xlab = "number of plants considered")
#we had an issue for n = 5 ... this is cause by cotito de santa teresa having a huge influence when only 7 datasets are used. Once This is fixed, the plot looks nice. It's a shame that with 5 and 6 plants it asimptotes, but on the other hand, for 6 plants we only have very few sites.

#One option is removing n = 6 from the simulation, as there is only one model for n = 6, and hence, while all other models estimate better the uncertainty on plant choice, the last model we have just 4 communities.


#Ainhoa, this akes me think that when calculating thresholds, sites with 6 plants can score up to 6, but sites with 4 sites can oscar max = 4. I corrected for this doing % above threshold, and no number. Worth doing the same in the above models.

#I only did it for fruit set.... no seeds, no weight...

```



#DISCUSSION
Importance of functional complementarity found in artificial [@Frund2013] and natural [@Fontaine2005] communities. 





The analysis of natural communities of interacting species using network analysis represents an ideal way of visualizing and grasping the complexity present. 






we have yet to know whether these variables contribute more to plant reproductive success than others related to the position of a particular plant species within the wider plant community that hosts it. In particular, our study focuses on the importance of pollinator diversity and total number of visits for plant reproductive success in comparison to that of the plant´s position in the community. Specifically, niche overlap between plant species (which could give us a proxy for the existence of competition for pollination between plant species) and the position of the plant given by the connections it establishes with other species, e.g. its centrality within the network, where central species are those receiving the greatest number of connections from other species, could have an influence in a plant´s reproductive success.

Furthermore, we do not know how the overall structure of a community, and the architecture of the network of interactions it hosts, affects the reproductive success of the whole community. In particular, one of the networks metrics that has received the most attention in the community ecology literature is that of nestedness. Nestedness is the property by which specialists interact with a subset of the species that generalists interact with. Although there is ongoing debate in the literature, some studies have found that more nested networks are more stable and resilient to perturbations because nestedness implies a certain level of redundancy and thus the possibility for functional replacement in the case of species loss. However, plant reproductive success depends on the delivery of conspecific pollen and thus of a certain level of specialization or niche divergence. Yet at present we do not know how the interplay between redundancy and complementarity determines reproductive success.
Finally, average values of reproductive success at the community level can be driven to a large degree by one single plant species. Yet, what will determine the persistence of a diverse plant community is the presence of some sort of “equity” in reproductive success across the whole community. We thus also focus on the effect of community structure for equity in reproductive success across the plant community.

