---
title: "Impact of interaction network structure on community-level plant reproduction success"
author: "Magrach, A, Molina, FP, Bartomeus, I"
output: html_document
bibliography: library.bib
csl: ecology-letters.csl
editor options:
  chunk_output_type: console
---

------------------------------------------------------------------------------------------------
[To be potentially submitted to ECOLOGY LETTERS as a Letter: maximum of 5000 words and 6 figures, tables or text boxes. 
The abstract page should contain a short summary not exceeding 150 words for Letters.

III. Main text (Sections b-d required for Letters only)
(a) Introduction. The introduction should summarize briefly the background and aims, and end with a very brief statement of what has been achieved by the work.

(b) Material and methods. This section should contain sufficient detail so that all procedures can be repeated (in conjunction with cited references). A checklist is provided so that authors can check that their methods report details which our editors regard as essential. This checklist is available here. Where specific equipment and materials are named, the manufacturer's name, city and country should be given (generally in parentheses after first mention).

(c) Results. The Results section should present the experiments that support the conclusions to be drawn later in the Discussion. The Results section should conform to a high standard of rigour. Extended lines of inference, arguments or speculations should not be placed in the Results.

(d) Discussion. The Discussion section should be separate from the Results section. It allows authors to propose their interpretation of the results, and to suggest what they might mean in a wider context. It should end with a clear statement of the main conclusions of the research, and a clear explanation of their importance and relevance.

(e) Acknowledgements. Acknowledgements should be brief and concise.

(f) References. See below for detailed information to in-text citations and Reference list.]



Title: Interaction network structure maximizes community-level plant reproduction success via niche complementarity

Ainhoa Magrach, Francisco de Paula Molina, Ignasi Bartomeus

Short running title: Network structure effects on reproductive success

Keywords: nestedness, niche complementary, fruitset, pollination, plant-pollinator interaction

Type of article: Letter

Words in Abstract: 147 words

Words in main text (excluding abstract, acknowledgements, references, table and figure legends):

Words in text boxes: 

Number of references:

Number of figures, tables and text boxes:

Corresponding author: ainhoa.magrach@bc3research.org, nacho.bartomeus@gmail.com



# ABSTRACT

Declines in pollinator diversity and abundance have been reported across different regions, with implications for the reproductive success of plant species. However, research has focused primarily on pairwise plant-pollinator interactions, largely overlooking community-level dynamics. Yet species do not interact in isolation, they are embedded within larger networks whose structure can affect pollinator functional roles and, ultimately, the pollination services they deliver to plants. Here, we present one of the first efforts linking pollinator visitation to plant reproduction from a community-wide perspective using a well-replicated dataset encompassing 16 well-resolved networks and data on reproductive success for 19 plant species from Mediterranean shrub ecosystems. We find that, for prediction purposes, information on simple visitation metrics is sufficient. Contrastingly, a mechanisitic understanding of the pathways through which differences in pollinator diversity translate into changes in reproductive success, requires additional information on community structure, particularly that reflecting niche complementarity between pollinators. 

#INTRODUCTION

Pollinators provide key services to plants by facilitating pollen flow between individuals. The recent declining trends found for some pollinator species in some regions of the planet ([@Potts2010], although see [@I.2019] reflecting general lack of knowledge at the global level), have led many researchers to focus on the functional impacts of these changes in pollinator diversity, with a major focus being placed on the consequences for plant reproductive success [@Biesmeijer2006]. 

Many research efforts have targeted the reproductive success of individual plant species [@Albrecht2012a; @doi:10.1111/1365-2745.13055], and used relatively simple visitation metrics (e.g., the number of pollinator species that visit a plant or the number of visits they perform) to explain differences found  across different plant individuals. Some have gone a step further by including information on the efficiency of these visits, thus adding a measure of quality to the pollination services [@Willcox2017]. Contrastingly, community-level analyses remain scarce [@Bennett2018]. Yet plants and pollinators do not interact in isolation, but rather are embedded within larger networks of interactions encompassing other plant and pollinator species. We are thus missing an important part of the picture, which includes the direct interactions between the whole ensemble of plants and pollinators, but also the indirect ones between species within one guild (e.g., plants) through their shared resources [@Carvalheiro2014; @Lazaro2014; @Mayfield2017]. Understanding how changes in pollinator diversity and interaction structure affect whole community assemblages is thus a major challenge that requires attention.

The few pollination studies that have analysed the effects of changing pollinator diversity for reproductive success at the community level, have done so using mainly experimental setups. As an example, a study that experimentally recreated a plant community with 9 plant species and differing levels of pollinator diversity across different enclosures, found that not only pollinator species diversity had an effect for average reproductive success, but also they found that community structure had an important effect [@Frund2013]. In particular, these authors found that niche complementarity between pollinators, in terms of plant species and temperature coverage (a measure of the overlap in the use of plant resources and optimum temperature activity) had a positive effect for average seed set at the community level [@Frund2013]. This provides added information on the effects of biodiversity for ecosystem functioning, suggesting that not only the diversity of species present but also the diversity of roles and ways in which a community is structured are determinant factors.

Indeed, theoretical research has long suggested that the structure of a community has an effect for ecosystem functioning (reviewed in [@Thompson2012]). This line of research, primarliy driven by food-web studies, has greatly advanced theory, but these ideas have not yet been tested using empirical data (but see [@Poisot2013]). Specifically, a major knowledge gap resides in understading which aspects of structure determine which aspects of function [@Thompson2012]. We are now at a point in which there is considerable understanding on the attributes characterizing mutualistic interaction networks [@Bascompte2007b] and we have a substantial understanding of how these attributes vary along different types of gradients [@Pellissier2017; @Tylianakis2016]. Especially, in the case of pollination, we have ample knowledge on the attributes that shape these mutualistic interactions at the community level, such as a prevalence of nested structures [Bascompte et al 2013 PNAS] or the presence of asymmetric specialization as a pervasive feature [@Vazquez2004]. However, how the structure shaping this network of interactions affects key ecosystem functions such as plant reproduction remains untested [@Winfree2013]. The time is thus ripe to use this knowledge to explore relationships between community structure and ecosystem functioning, with special emphasis being placed on the underlying mechanisms that drive these relationships.

Here, we present one of the first efforts linking pollinator visitation and plant reproductive success at the community level. To this end, we use a well-replicated dataset encompassing 16 well-resolved plant-pollinator interaction networks coupled with data on the reproductive success of 19 plant species recorded at Mediterranean shrub ecosystems within the area of influence of Doñana National Park in SW Spain. Our study focuses on understanding whether adding information on the structure of the community to previously-used simple visitation metrics (e.g., number and diversity of pollinator species visiting a plant species) aids in better explaining the differences observed in community-wide reproductive success. In doing so, we conducted our analyses focusing on reproductive success at two different levels: (i) at the species level by considering the effect of the position of a focal species within the larger network and its impact on its individual reproductive success, and (ii) at the community level, by evaluating how attributes that describe the whole community might affect average values of reproductive success. In addition, we evaluate whether community structure helps us explain differences in equity in reproductive success across individuals within a species and species within a community as a measure of evenness and [stability in the pollination service??]() 

Our results suggest that for prediction purposes, information on simple visitation metrics, particularly regarding the diversity of pollinators that visit a plant species, is sufficient. However, we find that a mechanisitic understanding of the pathways through which differences in pollinator diversity translate into changes in reproductive success requires additional information on network structure, notably information on the complementarity between the functions performed and the niches occupied by different pollinator species. 

[IB: this intro is brilliant!]() THANK YOU!! :) :)

# METHODS

_Plant pollinator interactions_

Our study was conducted in SW Spain within the area of influence of Doñana National Park (Figure 1?). Here, we surveyed 16 Mediterranean woodland patches, located within a XXX m2 area and with an average distance of XX km between them (min= XX, max= XX). [SHOULD WE SAY SOMETHING ABOUT THE MATRIX SURROUNDING THESE SITES OR THE TYPE OF VEGETATION PRESENT IN THEM??? IB: I don't think is relevant. ASK CURRO ABOUT THE NUMBERS ABOVE.]() Each site was surveyed 7 times during the flowering season of 2015 (from February to May) following a 100-m x 2 m transect for 30 mins. Along each transect, we identified all plant species and recorded all the flower visitors (including bees, hoverflies, beetles and XX) [IS IT JUST BEES AND HOVERFLIES? IB: NO, ALL VISITORS!]() that legitimately visited them. Floral visitors (from now on referred to as pollinators) that could not be identified in the field were captured, stored and identified in the laboratory by FdPM with the aid of experts in the different taxonomic groups (see acknowledgements). All surveys were done under similar weather conditions, avoiding windy or rainy days. 

_Plant reproductive success_

Within each site, we marked between 2 and 12 individuals (6.49 +- 2.37) of 1 [NB: Which site has only one species!]() [AM: Elpinar only has Rosmarinus and Villamanriqueeste only Cistus salvifolius]() to 6 plant species (4.06 +- 1.69), depending on the availability and presence of flowers during the sampling events. For each individual, we counted the number of flowers at each sampling point and recorded fruitset, the number of seeds per fruit (for 2-36 fruits, 11.17 +- 6.84) and average seed weight per fruit at the end of the season. Our survey included a total of 19 different plant species across our 16 sites. 

#DATA ANALYSES

In order to evaluate the completeness of our sampling of the pollinator and plant community as well as that of their interactions, we estimated the asymptotic number of species present, including non-detected species, and calculated the proportion detected with our original sampling data. We used Chao 1 asymptotic species richness estimators [@Chao2009] and estimated the richness of pollinators, plants and plant–pollinator links accumulated as sampling effort increased up to 100% sampling coverage using package iNEXT [@Hsieh2016] within the R environment [@RDevelopmentCoreTeam2011]. We then extracted the values covered by our sampling.

In order to analyse how differences within the community structure might affect plant reproductive success, we constructed weighted plant-pollinator interaction networks by pooling the data for the 7 rounds of sampling. We thus obtained one weighted interaction network per site, representing the frequency of visits by different pollinator species to different plant species. For each network, we then proceeded to extract a series of relevant network metrics.

_Species-level network analysis_

At the species level, we focused on attributes defining the position of a focal plant species within the larger community. As such, we considered two metrics providing complementary non-redundant information: (i) average niche overlap between a focal plant species and other plant species in the community, which covers the potential indirect interactions between different plant species through shared resources (in this case pollinators), and (ii) centrality, which depicts the importance of the plant species within the larger community (as resource for a large number of pollinator species) and its contribution to network cohesiveness. 

_Community-level network analysis_

At the community level, we followed the same logic as the one presented at the species level. Thus, we also calculated two network metrics providing complementary non-redundant information. In this case we focused on (i) nestedness and (ii) niche complementarity. Nestedness is the property by which specialists interact with a subset of the species that generalists interact with [@Bascompte2003]. Although there is an ongoing debate in the literature, some studies have found that nested networks are more stable and resilient to perturbations because nestedness promotes a greater diversity by minimizing competition among species in a community [@Bastolla2009]. However, many network attributes vary with network size and complexity [@Bluthgen2006]. In the case of nestedness, we know it can be affected by network size and connectance [@Song2017]. An approach that is often used to correct for this, is to use null models and to compare null-model corrected nestedness values across different networks. However, this approach has been recently shown to present the same issues, as z-scores also change with network size and connectance [@Song2017]. We thus followed the advice provided by Song et al. (2017) by using a normalized value of the widely-used nestedness metric NODF [@Almeida-Neto2011], $NODF_c$. This normalized value is calculated as $NODF_c = NODF_n/(C * log(S))$, where C is connectance, S is network size and $NODF_n = NODF/max(NODF)$, which is independent of network size and thus comparable across different networks [@Song2017].[See new paper by Benno simons updating Song method :(]()

Nevertheless, plant reproductive success depends on the delivery of conspecific pollen and thus of a certain level of specialization or niche divergence (reviewed in [@Brosi2016]). Yet at present we do not know how the interplay between redundancy and complementarity in species roles determines reproductive success. To calculate niche complmentarity we used a community-level measure defined as the total branch length of a functional dendrogram based on qualitative differences in visitor assemblages between plants [@Devoto2012; @Petchey2007a]. All network metrics were calculated using package bipartite [@Dormann2009].

_Statistical analyses_

In order to evaluate whether adding information on community structure improves our ability to explain differences in reproductive success - both at the species and the community level - we used general linear (GLMs) and general linear mixed models (GLMMs). In both cases (species and community-level models) we fit two types of models: (i) model 1, that only included simple visitation metrics and (ii) model 2, that additionally included information on community structure.

At the species level, model 1 included as explanatory variables the diversity of pollinator species visiting a focal plant and the total number of visits received by that plant species; while model 2, added the two network attributes calculated at the species level: average niche overlap and centrality. In this case, we included plant species nested within site as a random effect to account for the non-independence of several individuals measured for the same plant species within each site. The diversity of pollinator species visiting a focal plant was approximated using the plant´s normalised degree, i.e., the number of links with different pollinator species a plant has, scaled by the number of possible partners [@Dormann2009]. Niche overlap was calculated as the average overlap in pollinator species visiting a focal plant and each of the other plants in the community using the morisita index  (@Manual{,
    title = {spaa: SPecies Association Analysis},
    author = {Jinlong Zhang},
    year = {2016},
    note = {R package version 0.2.2},
    url = {https://CRAN.R-project.org/package=spaa},
  }). As a measure of centrality we used weighted closeness centrality which describes centrality through the path lengths of a species to other species in the network using a weighted representation of the network [@Dormann2009]. Response variables included fruitset for different individuals measured per species analyzed using a binomial distribution, the number of seeds per species for different individuals analyzed using normal distribution and average values per species of fruit and seed weight fitted to poisson distributions.
  
At the community level, we upscaled our species-level analyses. In this case, model 1 included total pollinator diversity and the total number of visits received by all plants within the community as explanatory variables. Model 2, in turn, added information on community structure by including nestedness and niche complementarity as explanatory variables. As response variable we had the average reproductive success for the whole community (i.e., average fruitset analyzed using a binomial distribution, average number of seeds per fruit and average fruit and seed weight previously scaled for each species for which we used normal distributions). We thus had a single value per site and no random effects are needed in this case.

Average values of reproductive success at the community level can be driven to a large extent by a single plant species. Yet, what will determine the persistence of a diverse plant community, is the presence of some sort of “equity” or evenness in reproductive success across the whole community. We therefore calculated a measure of equity in reproductive success at the community level as the proportion of species within a community with normalized average fruitset values above 0.5. We repeated this using 0.25 and 0.75 thresholds. We then used the same framework as before and fit the same models 1 and 2 GLMs as the ones used at the community level, but using equity in reproductive success as the response variable and a binomial distribution. In this case, we retained only sites for which we had at least measured reproductive success for 2 plant species (N=14 sites). 
We used information criterion methods to find the best model for each case and selected the ones with the lowest Akaike Information Criterion (AIC) value. $\Delta AIC<2$, were not considered enough to select one model over the other [@Burnham2011].

_Simulating the effect of community structure as sample size increases_

Finally, we tested whether the importance of community structure in explaining differences in equity in reproductive success within communities increases with the number of plant species being considered. We expect that when only one plant species is considered, then the importance of community structure will be negligible, while we expect this importance to increase as more plant species are considered (up to a maximum number of 6 species which is the maximum we have measured in our study at a particular site).

To test this, we ran a simple simulation in which the number of species considered increased at each time step and for each time step we re-calculated equity in reproductive success. Instead of drawing plant species randomly for each run, we tested all possible combinations for each plant number level and network, as the number of combinations is low (e.g. for n = 3 plant selected out of 6 there is only 20 possible combiations). Then, we tested the overall relationship between equity in reproductive success and both community-level network metrics we measured: nestedness and functional complementarity within our simulated communities. To this end, for each species number level considered, we randomly selected one of the generated equity values across each of the 16 communities, regress this against our netrok level predictors and extracted the model estimates. We averaged all estimates from 1,000 simulated combinations per number of plants considered. We expect that the more plants considered, the larger the resulting average estimates will be. Note that we only interpret the mean effects, as the variance among different plant number of species depends on the initial number of combinations.


#RESULTS

Within our sampling we recorded `r nrow(d)` pollinator individuals belonging to 57 species of plants and 277 species of pollinators. Within the pollinator community XX% of species were solitary bees, XX% hoverflies, 20% honeybees, and XX%% other?? [Curro can calculate this if needed]()

```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=9}

#prepare stuff-----
#If you don't have devtools install it
#install.packages("devtools")
#library(devtools)
#Then install the data package. Reprot issues 
#install_github("ibartomeus/BeeFunData", ref = "fun")
library(BeeFunData)

#devtools::install_github("jonocarroll/mathpix") #package to include mathematical formulas
library(mathpix)


library(plyr)


d<-all_interactions
#head(d)
#I just realized here we are using all data available. 
#This is ok, but a few rare interactions are taken outside the transect (which can be removed?), and we are including focal 3' observations, which can be explained in methods.
#d <- subset(d, subset = Out != "out") #Should we do that?
f<-fruitset
s<-seedset


#calculate number of plant and pollinator species in total in our sampling

d.pl<-unique(all_interactions$Plant_gen_sp)
d.poll<-unique(all_interactions$Pollinator_gen_sp)

#calculate number of plant species per site, number of individuals per plant species and number of fruits per ind surveyed for repr succ

library(plyr)

f$Plant.sp<-paste(f$Plant_genus, f$Plant_species)

f.inds<-ddply(f, c("Site_ID", "Plant.sp"), summarise, 
                   tot.inds = length(Plant.sp)) #number of individuals per plant sps

#write.csv(f.inds, file="tables/plantindspersite.csv", row.names = FALSE)

mean<-mean(f.inds$tot.inds)
stdev<-sd(f.inds$tot.inds)


f.sps<-ddply(f.inds, c("Site_ID"), summarise, 
                   tot.sps = length(Site_ID)) #number of plant sps per site


#write.csv(f.sps, file="tables/plantspspersite.csv", row.names = FALSE) 

mean2<-mean(f.sps$tot.sps)
stdev2<-sd(f.sps$tot.sps)
  

s$Plant.sp<-paste(s$Plant_genus, s$Plant_species)

s.fruitnum<-ddply(s, c("Site_ID", "Plant.sp"), summarise, 
                   tot.fruits = length(Plant.ID)) #number of fruits per individual


#write.csv(s.fruitnum, file="tables/fruitnumberperplantindspersite.csv", row.names = FALSE) 

mean3<-mean(s.fruitnum$tot.fruits)
stdev3<-sd(s.fruitnum$tot.fruits)
   
###### read network and species level files (network analyses to be found at "...scripts/network analysis.R")

outsp.pl.site<-read.csv("SITE_plant_species_level_metrics.csv")
outsp.site<-read.csv("SITE_species_level_metrics.csv")
out.site<-read.csv("SITE_network_level_metrics.csv")
```


Our sampling completeness analyses revealed that with our survey we were able to capture 18-62% of pollinator species (average= 35%), 47-98% for plant species (average= 78%) and 13-41% for plant-pollinator links (average=27%), in line with that obtained with other studies (e.g., [@Chacoff2012], Figure S1?). Our values of sampling completeness are slightly smaller in the case of pollinators probably as a consequence of the great diversity found in the Mediterranean region and within our study area in particular, a hotspot of insect diversity (REF).


```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=5}

#######CALCULATE SAMPLING COMPLETENESS FOR POLLINATORS, PLANTS AND LINKS 

library(iNEXT)
library(ggplot2)
library(grid)

#POLLINATORS
d2<-table(d$Site_ID, d$Pollinator_gen_sp)
d3<-as.data.frame.array(d2)

d4 <- t(d3[,1:ncol(d3)]) #I updated this to use defensive programming.
#head(d4)
#str(d4)
d5<-as.data.frame(d4)
#str(d5)
d6<-as.list(d5)


rar <- iNEXT(d6, q=0, datatype="abundance", endpoint = 400)
poll<-ggiNEXT.iNEXT(rar, color.var="site", se=FALSE) + ylab("Pollinator species richness") + theme_bw() + 
  theme (legend.position= "none") + theme(text = element_text(size = 15), axis.text=element_text(size=rel(1)),
                                          axis.title.x = element_blank(),
        axis.title=element_text(size=rel(1),face="bold"), legend.direction="horizontal", legend.text=element_text(size=10)) +
  scale_color_manual(values=c("#F1BB7B", "#FD6467", "#5B1A18", "#D67236", "#E6A0C4", "#C6CDF7", "#D8A499", "#7294D4", "#D8B70A", "#02401B", "#A2A475", "#81A88D", "#972D15", "#9C964A", "#CDC08C", "#FAD77B"))

#poll


#per site sampling completeness for pollinators
#Aznalcazar 64/103 = 0.62
#Bonares  54.000/178.701 = 0.30
#ConventodelaLuz  33.000/98.950 = 0.33
#CotitodeSantaTeresa  54.000/190.442 = 0.28
#Elpinar  29.000/158.657= 0.18
#Elpozo  32.000/174.000= 0.18
#Esparragal  39.000/110.859= 0.35
#LaCunya  32.000/118.672= 0.27
#LaRocina  74.000/147.129 = 0.50
#Lasmulas  52.000/127.295 = 0.41
#Niebla  57.000/124.792 = 0.46
#PinaresdeHinojos 40.000/168.852 = 0.24
#Pinodelcuervo  52.000/187.503 = 0.28
#Urbanizaciones  40.000/109.136 = 0.37 
#Villamanriqueeste  62.000/141.310 = 0.44
#Villamanriquesur  48.000/111.326 = 0.43


#(0.62 + 0.30 + 0.33 + 0.28 + 0.18 + 0.18 + 0.35 + 0.27 + 0.50 + 0.41 + 0.46 + 0.24 + 0.28 + 0.37 + 0.44 + 0.43)/16
#TOTAL AVERAGE sampling completeness of pollinators 0.35


#PLANTS
d.pl<-table(d$Site_ID, d$Plant_gen_sp)
d.pl2<-as.data.frame.array(d.pl)

d.pl3 <- t(d.pl2[,1:57])
#head(d.pl3)
#str(d.pl3)
d.pl4<-as.data.frame(d.pl3)
#str(d.pl4)
d.pl5<-as.list(d.pl4)


rar2 <- iNEXT(d.pl5, q=0, datatype="abundance", endpoint = 200)
plant<-ggiNEXT.iNEXT(rar2, color.var="site", se=FALSE) + ylab("Plant species richness") + 
  theme_bw()  + theme (legend.position= "none") + theme(text = element_text(size = 15), axis.text=element_text(size=rel(1)),
                                                         axis.title.x = element_blank(),
        axis.title=element_text(size=rel(1),face="bold"), legend.direction="horizontal", legend.text=element_text(size=10)) +
  scale_color_manual(values=c("#F1BB7B", "#FD6467", "#5B1A18", "#D67236", "#E6A0C4", "#C6CDF7", "#D8A499", "#7294D4", "#D8B70A", "#02401B", "#A2A475", "#81A88D", "#972D15", "#9C964A", "#CDC08C", "#FAD77B"))


#plant


#per site sampling completeness for plants
#Aznalcazar 17.000/18.490 = 0.92
#Bonares  13.000/13.990 = 0.93
#ConventodelaLuz  12.000/13.978 = 0.86
#CotitodeSantaTeresa  10.000/11.973 = 0.84
#Elpinar  11.000/23.255 = 0.47
#Elpozo  11.000 /13.219 = 0.83
#Esparragal  12.000 /16.436 = 0.73
#LaCunya  13.000/21.847 = 0.60
#LaRocina  16.000 /21.959 = 0.73 
#Lasmulas  12.000 /17.940 = 0.67
#Niebla  21.000/21.743 = 0.97
#PinaresdeHinojos 14.000/21.889 = 0.64
#Pinodelcuervo  15.000/27.372 = 0.55
#Urbanizaciones  10.000 /10.247 = 0.98
#Villamanriqueeste  9.000 /10.983 = 0.82
#Villamanriquesur  12.000 /12.989 = 0.92

#(0.92 + 0.93 + 0.86 + 0.84 + 0.47 + 0.83 + 0.73 + 0.60 + 0.73 + 0.67 + 0.97 + 0.64 + 0.55 + 0.98 + 0.82 + 0.92)/16

#TOTAL AVERAGE sampling completeness of plants 0.78


#LINKS

d$link<-paste(d$Plant_gen_sp, d$Pollinator_gen_sp)
d.l<-table(d$Site_ID, d$link)
d.l2<-as.data.frame.array(d.l)

d.l3 <- t(d.l2[,1:750])
#head(d.l3)
#str(d.l3)
d.l4<-as.data.frame(d.l3)
#str(d.l4)
d.l5<-as.list(d.l4)


rar3 <- iNEXT(d.l5, q=0, datatype="abundance", endpoint = 500)
link<-ggiNEXT.iNEXT(rar3, color.var="site", se=FALSE) + ylab("Link richness") + theme_bw() +
   theme (legend.position= "none") + theme(text = element_text(size = 15), axis.text=element_text(size=rel(1)),
        axis.title=element_text(size=rel(1),face="bold"), legend.direction="horizontal", legend.text=element_text(size=10)) +
 scale_color_manual(values=c("#F1BB7B", "#FD6467", "#5B1A18", "#D67236", "#E6A0C4", "#C6CDF7", "#D8A499", "#7294D4", "#D8B70A", "#02401B", "#A2A475", "#81A88D", "#972D15", "#9C964A", "#CDC08C", "#FAD77B"))
  

#link


#per site sampling completeness for links
#Aznalcazar 101.000/244.145 = 0.41
#Bonares  72.000/389.031 = 0.19
#ConventodelaLuz  52.000/221.285 = 0.23
#CotitodeSantaTeresa  64.000/478.893 = 0.13
#Elpinar  37.000/194.026 = 0.19
#Elpozo   46.000/159.994 = 0.29
#Esparragal   52.000/196.900 = 0.26
#LaCunya  44.000/115.025 = 0.38
#LaRocina  98.000/351.931 = 0.28
#Lasmulas  69.000/306.883 = 0.22
#Niebla  84.000/611.776 = 0.14
#PinaresdeHinojos  56.000/186.413 = 0.30
#Pinodelcuervo   77.000/273.425 = 0.28
#Urbanizaciones  55.000/204.100 = 0.27
#Villamanriqueeste  76.000/193.208 = 0.39
#Villamanriquesur  67.000/234.221 = 0.29 

#(0.41 + 0.19 + 0.23 + 0.13 + 0.19 + 0.29 + 0.26 + 0.38 + 0.28 + 0.22 + 0.14 + 0.30 + 0.28 + 0.27 + 0.39 + 0.29)/16

#TOTAL AVERAGE sampling completeness of links 0.27

grid.newpage()
grid.draw(rbind(ggplotGrob(poll), ggplotGrob(plant), ggplotGrob(link), size = "last"))

```

### Species-level analyses

At the species level, in the case of fruitset, our results show that both model 1 and model 2 are equally good in explaining the variability observed (i.e.,$\Delta AIC<2$), and therefore we cannot select one over the other. Given that model 2 has a greater number of variables which should be penalized given the added complexity it provides, we will comment results only for model 2. In this case, we find a positive effect of pollinator species diversity (measured using the species´normalised degree, Fig. XX) as well as a positive effect of the centrality of the focal plant on its fruitset. 

```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=5}

library(ggplot2)
library(grid)

#compare 2 models: one with degree, i.e. diversity of partners, and number of visits, compared to one where position in a network (centrality) and niche overlap are included with these variables.

#calculate column with fruit set as
f$Plant.sp<-paste(f$Plant_genus, f$Plant_species)

#Fruit_Yes +  Fruit_Preyed + Fruit_Dispersed) / (Fruit_Yes + Fruit_No +Fruit_Preyed + Fruit_Dispersed) #Nacho this equation is wrong in your metadata!

#1st eliminate frutos perdidos
wordList <- c("fruto perdido","frutos perdidos")

require(Hmisc)
f2<-subset(f, Notes %nin% wordList)

f2$tot.fruitset<-(f2$Fruit_Yes +  f2$Fruit_preyed + f2$Fruit_dispersed)/(f2$Fruit_Yes +f2$Fruit_No + f2$Fruit_preyed + f2$Fruit_dispersed)


#check correlation between different variables

#head(out.site)
#str(out.site)
c<-cor(out.site[,2:20])
c2<-round(c,digits=2)
#write.csv(c2, file= "tables/variable_correlations.csv", row.names = TRUE, sep = ",")

#♣correlation between weighted nodf and functional complementarity of pollinators : -0.13


#create table with number of individuals per plant species sampled at each site

#tableSx <- aggregate(Plant.ID ~ Site_ID + Plant.sp, data = f2, FUN = function(x){NROW(x)})

#write.csv(tableSx, file= "tables/plantindspersite.csv", row.names = FALSE, sep = ",")

#-------------------------------------------------------------------------------------------
#join plant species level network metrics with fruit and seed set for each site, also with niche overlap and number of visits

#calculate total number of visits per plant sps

library(plyr)

d.vis<-ddply(d, c("Site_ID", "Plant_gen_sp"), summarise,
            tot.visits= sum(Frequency))
  
d.vis$j<-paste(d.vis$Site_ID, d.vis$Plant_gen_sp)



#calculate average niche overlap per species 

library(reshape2)
library(spaa)
library(plyr)

sites <- unique(d$Site_ID)

out.niche <- data.frame(Site_id = NA, row = NA, col = NA,value  = NA)

webs <- list()
for(i in 1:length(sites)){
  temp <- subset(d, Site_ID == sites[i])
  temp2<-droplevels(temp)
 
  web <- table(temp2$Pollinator_gen_sp, temp2$Plant_gen_sp)

  ni<-niche.overlap(web, method="morisita") #THIS SHOULD BE EXPLAINED IN METHODS
  df <- melt(as.matrix(ni), varnames = c("row", "col"))
  df$row<-as.character(df$row)
  df$col<-as.character(df$col)
  
  n <- nrow(out.niche)
 
  out.niche[n + seq(nrow(df)),1] <- as.character(sites[i])
  out.niche[n + seq(nrow(df)),2:3] <- (df[,1:2])
  out.niche[n + seq(nrow(df)),4] <-df[,3]
  
}



out.niche.agg <- ddply(out.niche, c("Site_id", "col"), summarise,
               mean.niche.over    = mean(value))


out.niche.agg$j<-paste(out.niche.agg$Site_id, out.niche.agg$col)

#use unaggregated data

f2$functional.comp.poll<-out.site$functional.comp.poll[match(f2$Site_ID, out.site$Site_id)]
f2$nodf.song<-out.site$nodf.song[match(f2$Site_ID, out.site$Site_id)]
f2$species.poll<-out.site$species.poll[match(f2$Site_ID, out.site$Site_id)]

#also match with plant species level network data
f2$match<-paste(f2$Site_ID, f2$Plant.sp)
outsp.pl.site$match<-paste(outsp.pl.site$Site_id, outsp.pl.site$species)

f2$norm_degree<-outsp.pl.site$norm_degree[match(f2$match, outsp.pl.site$match)]
f2$weigh_closeness<-outsp.pl.site$weigh_closeness[match(f2$match, outsp.pl.site$match)]
f2$niche.overlap<-out.niche.agg$mean.niche.over[match(f2$match, out.niche.agg$j)]


f2$tot.visits<-d.vis$tot.visits[match(f2$match, d.vis$j)]
f2$tot.visits[is.na(f2$tot.visits)]<-0


#scale all variables used

f2$functional.comp.poll.sc<-scale(f2$functional.comp.poll, center = T, scale = T)
f2$nodf.song.sc<-scale(f2$nodf.song, center = T, scale = T)
f2$species.poll.sc<-scale(f2$species.poll, center = T, scale = T)


f2$norm_degree.sc<-scale(f2$norm_degree, center = T, scale = T)
f2$weigh_closeness.sc<-scale(f2$weigh_closeness, center = T, scale = T)
f2$niche.overlap.sc<-scale(f2$niche.overlap, center = T, scale = T)


#scale total visits per plant species
library(dplyr)
f2_scaled <- f2 %>% group_by(Plant.sp) %>% mutate(tot.visits.sc = scale(tot.visits, center = T, scale = T))

# 
# #check correlations between different species level variables
# 
#cor(f2[,23:29])

library(psych)
dim(f2)
pairs.panels(f2[,23:28]) 

#fit models 1 and 2 

library(lme4)
library(lmerTest) #to calculate coeff and p values
library(car) #to calculate VIF
library(bbmle)  #to select best model based on AIC
library(ggplot2)
library(DHARMa) #to check for problems in residuals
 
m1<-glmer(tot.fruitset ~  norm_degree.sc + tot.visits.sc  + (1|Plant.sp:Site_ID) + (1|Site_ID), family="binomial", data=f2_scaled)

summary(m1)
 

vif(m1)  #check for correlations between variables included in model
 
 
m2<-glmer(tot.fruitset ~  norm_degree.sc  + tot.visits.sc + weigh_closeness.sc + niche.overlap.sc  + (1|Plant.sp:Site_ID) + (1|Site_ID), family="binomial", data=f2_scaled)
 
summary(m2) #both norm degree and weigh closeness have intervals not overlapping 0
 
vif(m2)
 

#select best model based on AIC 

AICtab(m1, m2) #both are equally good using binomial distribution!!

#test for problems in residuals

# res<-simulateResiduals(m1)
# plot(res, rank = TRUE)


# extract coefficients and p-values for m1 and present them in paper
coefs.m2 <- data.frame(coef(summary(m2)))
# use normal distribution to approximate p-value
coefs.m2$p.z <- 2 * (1 - pnorm(abs(coefs.m2$z.value)))
coefs.m2
summ<-round(coefs.m2,digits=2)
#write.csv(summ, file="tables/resultsfruitsetSPECIES.csv", row.names = TRUE)

#both models equally good, plot significant variables, in this case degree, do partial residual plots to show the effect of that variable in isolation of the others


#devtools::install_github("hohenstein/remef")  USE THIS PACKAGE TO DO PARTIAL RESIDUAL PLOTS OF SIGNIFICANT VARIABLES

#devtools::install_github("hohenstein/remef")
library(remef)
y_partial_norm <- remef(m2, fix= c( "tot.visits.sc", "weigh_closeness.sc", "niche.overlap.sc"), ran = "all", inverse = F)
#With this we remove the influece of x2 and the random effects from the dependent variable
y_partial_norm_inv<-exp(y_partial_norm)/(1+exp(y_partial_norm))
#then we use this new variable to plot. We use m1@frame as dataset because not all observations are used in modeldue to presence of NAs


pl1<-ggplot(m2@frame,  aes(x=m2@frame$norm_degree.sc[1:325,1], y=y_partial_norm_inv)) +    
  geom_point(size=4) + stat_smooth(method=lm,  size=1.5, se=TRUE, color = "black", alpha=0.2) + 
  #geom_smooth(method=lm, linetype= "dashed", size=0.7, se=FALSE, alpha=0.8) +
  xlab("Normalized degree") +      
  ylab("Fruitset") + theme_bw()  + theme (legend.position= c(0.85,0.3)) +
  theme(text = element_text(size = 20), axis.text=element_text(size=rel(1.2)), axis.title=element_text(size=rel(1.3), face="bold")) + 
  labs(col="Plant species") +  theme(legend.text = element_text(size = 10, face = "italic"), legend.title = element_text(size=11, face = "bold"))

#pl1


y_partial_weigh <- remef(m2, fix= c( "tot.visits.sc", "norm_degree.sc", "niche.overlap.sc"), ran = "all", inverse = F)
#With this we remove the influece of x2 and the random effects from the dependent variable
y_partial_weigh_inv<-exp(y_partial_weigh)/(1+exp(y_partial_weigh))

pl1b<-ggplot(m2@frame,  aes(x=m2@frame$weigh_closeness.sc[1:325,1], y=y_partial_weigh_inv)) +    
  geom_point(size=4) + stat_smooth(method=lm,  size=1.5, se=TRUE, color = "black", alpha=0.2) + 
  #geom_smooth(method=lm, linetype= "dashed", size=0.7, se=FALSE, alpha=0.8) +
  xlab("Centrality") +      
  ylab("Fruitset") + theme_bw()  + theme (legend.position= c(0.85,0.3)) +
  theme(text = element_text(size = 20), axis.text=element_text(size=rel(1.2)), axis.title=element_text(size=rel(1.3), face="bold")) + 
  labs(col="Plant species") +  theme(legend.text = element_text(size = 10, face = "italic"), legend.title = element_text(size=11, face = "bold"))

#pl1b

library(cowplot)
plot_grid(pl1, pl1b, labels = c("A", "B"))

```

Figure X. Partial residual plots showing the effect of a) pollinator species diversity (approximated using normalized degree) and b) species centrality on fruitset for each of the plant species considered. Dots represent each of the individuals sampled for each species within each site.


For all other measures of reproductive success considered (i.e., the number of seeds per fruit, fruit and seed weight), the best model based on its AIC value was model 1, i.e., the model that only included simple visitation metrics (in this case, pollinator species diversity and the total number of visits received by a focal plant species). However, none of the variables included within our model explain the differences observed. [show in sup mat?]()

```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=5}
##ahora con seed set

s$Plant.sp<-paste(s$Plant_genus, s$Plant_species)

#1st eliminate frutos perdidos
wordList <- c("fruto perdido","frutos perdidos")

require(Hmisc)
s2<-subset(s, Notes %nin% wordList)

#calculate average seed set per plant individual, there are several fruit measurements per plant and would lead to 3 nested random factors
library(plyr)

s3 <- ddply(s2, c("Site_ID", "Plant.sp", "Plant.ID"), summarise,
                         mean.seedn    = mean(Seeds2),
                          mean.seedw = mean(Seed.weight),
                          mean.fruitweight = mean(Fruit.weight2))


#use unaggregated data

s3$functional.comp.poll<-out.site$functional.comp.poll[match(s3$Site_ID, out.site$Site_id)]
s3$nodf.song<-out.site$nodf.song[match(s3$Site_ID, out.site$Site_id)]
s3$species.poll<-out.site$species.poll[match(s3$Site_ID, out.site$Site_id)]

#also match with plant species level network data
s3$match<-paste(s3$Site_ID, s3$Plant.sp)
outsp.pl.site$match<-paste(outsp.pl.site$Site_id, outsp.pl.site$species)

s3$norm_degree<-outsp.pl.site$norm_degree[match(s3$match, outsp.pl.site$match)]
s3$weigh_closeness<-outsp.pl.site$weigh_closeness[match(s3$match, outsp.pl.site$match)]
s3$niche.overlap<-out.niche.agg$mean.niche.over[match(s3$match, out.niche.agg$j)]


s3$tot.visits<-d.vis$tot.visits[match(s3$match, d.vis$j)]
s3$tot.visits[is.na(s3$tot.visits)]<-0


#scale all variables used

s3$functional.comp.poll.sc<-scale(s3$functional.comp.poll, center = T, scale = T)
s3$nodf.song.sc<-scale(s3$nodf.song, center = T, scale = T)
s3$species.poll.sc<-scale(s3$species.poll, center = T, scale = T)


s3$norm_degree.sc<-scale(s3$norm_degree, center = T, scale = T)
s3$weigh_closeness.sc<-scale(s3$weigh_closeness, center = T, scale = T)
s3$niche.overlap.sc<-scale(s3$niche.overlap, center = T, scale = T)


#scale total visits per plant species
library(dplyr)
s3_scaled <- s3 %>% group_by(Plant.sp) %>% mutate(tot.visits.sc = scale(tot.visits, center = T, scale = T))

s4_scaled <- s3_scaled %>% group_by(Plant.sp) %>% mutate(mean.seedn.sc = scale(mean.seedn, center = T, scale = T))


#fit two models

m1.seed<-glmer(mean.seedn.sc ~  norm_degree.sc + tot.visits.sc  + (1|Plant.sp:Site_ID), family="gaussian", data=s4_scaled)

summary(m1.seed)
 
vif(m1.seed)


m2.seed<-glmer(mean.seedn.sc ~  norm_degree.sc  + tot.visits.sc + weigh_closeness.sc + niche.overlap.sc  + (1|Plant.sp:Site_ID), family="gaussian", data=s4_scaled)
 
summary(m2.seed)
 
vif(m2.seed)
 

AICtab(m1.seed, m2.seed) #m1 here is best model with m2 having a differnce of 4. However m2 has niche overlap as significant.

#test for problems in residuals
# res<-simulateResiduals(m1.seed)
# plot(res, rank = TRUE)


# extract coefficients and p-values for m1 and present them in paper
coefs.m1.seed <- data.frame(coef(summary(m1.seed)))
# use normal distribution to approximate p-value
coefs.m1.seed$p.z <- 2 * (1 - pnorm(abs(coefs.m1.seed$t.value)))
coefs.m1.seed
summ.seed<-round(coefs.m1.seed,digits=2)
#write.csv(summ.seed, file="tables/resultsseedsetSPECIES.csv", row.names = TRUE)

#SEED WEIGHT
library(glmmTMB)
m1.seed.w<-glmmTMB(mean.seedw ~  norm_degree.sc + tot.visits.sc  + (1|Plant.sp:Site_ID), family="poisson", data=s3_scaled)

summary(m1.seed.w)
 
 
m2.seed.w<-glmmTMB(mean.seedw ~  norm_degree.sc  + tot.visits.sc + weigh_closeness.sc + niche.overlap.sc  + (1|Plant.sp:Site_ID), family="poisson", data=s3_scaled)
 
summary(m2.seed.w)
 


#select best model based on AIC 

AICtab(m1.seed.w, m2.seed.w) 

#test for problems in residuals
# res<-simulateResiduals(m1.seed.w)
# plot(res, rank = TRUE)


# extract coefficients and p-values for m1 and present them in paper
summ.seed.w<-summary(m1.seed.w)$coefficients$cond
#write.csv(summ.seed.w, file="tables/resultsseedweightSPECIES.csv", row.names = TRUE)

#FRUIT WEIGHT

m1.fruit.w<-glmmTMB(mean.fruitweight ~  norm_degree.sc + tot.visits.sc  + (1|Plant.sp:Site_ID), family="poisson", data=s3_scaled)

summary(m1.fruit.w)
 


m2.fruit.w<-glmmTMB(mean.fruitweight ~  norm_degree.sc  + tot.visits.sc + weigh_closeness.sc + niche.overlap.sc  + (1|Plant.sp:Site_ID), family="poisson", data=s3_scaled)
 
summary(m2.fruit.w)
 

#select best model based on AIC 

AICtab(m1.fruit.w, m2.fruit.w) 

#test for problems in residuals
# res<-simulateResiduals(m1.fruit.w)
# plot(res, rank = TRUE)


# extract coefficients and p-values for m1 and present them in paper
summ.fruit.w<-summary(m1.fruit.w)$coefficients$cond
#write.csv(summ.seed.w, file="tables/resultsfruitweightSPECIES.csv", row.names = TRUE)

```

### Community-level analyses

At the network level, we find different patterns for fruitset and the number of seeds per fruit as compared to those for fruit and seed weight. In the case of fruitset and the number of seeds per fruit, we find that both model 1 and 2 are equally good in describing the differences observed (i.e.,$\Delta AIC<2$). Again, because this suggests model 2 is a good model despite its added complexity, we will comment results for this model only. In particular, we find that both fruitset and the number of seeds per fruit are positively related to niche complementarity between pollinators. Additionally, we find a negative effect of community-level pollinator species diversity on average fruitset. 


```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=5, fig.width=10}

######################## NTW STRUCTURE ~ ECOSYSTEM FUNCTION 

library(plyr)
#this is how i did originally, average of everything together, now following Nacho´s advice changing to mean of means previously calculated per sps

f.agg.prev <- ddply(f2, c("Site_ID", "nodf.song", "functional.comp.poll", "species.poll"), 
                    summarise, tot.visits    = sum(tot.visits),
                         mean.fruitset = mean(tot.fruitset))


#I see what you mean, no weghting for plant species... maybe is good doing it... mean on means? I don't think it will change much the result.
#Doing mean of means here, it does change some values a bit!!
f.ag <- ddply(f2, c("Site_ID", "Plant.sp", "nodf.song", "functional.comp.poll", "species.poll"), 
               summarise, tot.visits    = sum(tot.visits),
                         mean.fruitset = mean(tot.fruitset))

f.agg <- ddply(f.ag, c("Site_ID",  "nodf.song", "functional.comp.poll", "species.poll"), 
               summarise, tot.visits    = sum(tot.visits),
                         mean.fruitset = mean(mean.fruitset))

#scale all variables to be able to compare effect sizes 

f.agg$nodf.song.sc <- scale(f.agg$nodf.song, center = T, scale = T)
f.agg$functional.comp.poll.sc <- scale(f.agg$functional.comp.poll, center = T, scale = T)
f.agg$species.poll.sc <- scale(f.agg$species.poll, center = T, scale = T)
f.agg$tot.visits.sc <- scale(f.agg$tot.visits, center = T, scale = T)


#average FRUITset

m1.fruit.net<-glmmTMB(mean.fruitset ~  species.poll.sc + tot.visits.sc, family="beta_family", data=f.agg)

summary(m1.fruit.net)
 
 
m2.fruit.net<-glmmTMB(mean.fruitset ~  species.poll.sc + tot.visits.sc + nodf.song.sc + functional.comp.poll.sc, family="beta_family", data=f.agg)

#note estimate of niche part do not overlap zero 0.06105  +-  0.03637 and it's moderatelly big.
 
summary(m2.fruit.net)
 
 
#select best model based on AIC 

AICtab(m1.fruit.net, m2.fruit.net) #Almost as good. The take home message would be. If interested in predictions, go for simplicity. If interested in mechanisms, nich part is a mechanism to take into account. 

#test for problems in residuals
# res<-simulateResiduals(m2.fruit.net)
# plot(res, rank = TRUE)

#when changing values to mean of means actually model2 is best and funct compl is significant!! 

#save table with results for paper
summ.fruit.net<-round(summary(m2.fruit.net)$coefficients$cond, digits=2)
#write.csv(summ.fruit.net, file="tables/resultsfruitsetNETWORK.csv", row.names = TRUE)



#TRYING TO MANUALLY CREATE PARTIAL RESIDUAL PLOTS

pred<-summary(m2.fruit.net)$coefficients$cond[1]+ (summary(m2.fruit.net)$coefficients$cond[2] * mean(f.agg$species.poll.sc)) + (summary(m2.fruit.net)$coefficients$cond[3] * mean(f.agg$tot.visits.sc)) + (summary(m2.fruit.net)$coefficients$cond[4]* mean(f.agg$nodf.song.sc)) + (summary(m2.fruit.net)$coefficients$cond[5] * f.agg$functional.comp.poll.sc)

res<-pred-f.agg$mean.fruitset
res.tr<-exp(res)/(1+exp(res)) #transform using logit back transformation


pl2 <- ggplot(f.agg,  aes(x=functional.comp.poll.sc, y= res.tr)) +    
        geom_point(size=4, color="black") + 
  stat_smooth(method = 'lm', size=1.5, se=TRUE, color = "black", alpha=0.2) +     
        xlab("Functional complementarity") +      
        ylab("Fruitset") + theme_bw()  + #theme (legend.position= "none") +
        theme(text = element_text(size = 20), axis.text=element_text(size=rel(1.2)), axis.title=element_text(size=rel(1.3), face="bold")) 

pl2



pred2<-summary(m2.fruit.net)$coefficients$cond[1]+ (summary(m2.fruit.net)$coefficients$cond[2] * f.agg$species.poll.sc) + (summary(m2.fruit.net)$coefficients$cond[3] * mean(f.agg$tot.visits.sc)) + (summary(m2.fruit.net)$coefficients$cond[4]* mean(f.agg$nodf.song.sc)) + (summary(m2.fruit.net)$coefficients$cond[5] * mean(f.agg$functional.comp.poll.sc))

res2<-pred2-f.agg$mean.fruitset
res.tr2<-exp(res2)/(1+exp(res2))
  


pl3 <- ggplot(f.agg,  aes(x=species.poll.sc, y= res.tr2)) +    
        geom_point(size=4, color="black") + 
  stat_smooth(method = 'lm', size=1.5, se=TRUE, color = "black", alpha=0.2) +     
        xlab("Pollinator species diversity") +      
        ylab("Fruitset") + theme_bw()  + #theme (legend.position= "none") +
        theme(text = element_text(size = 20), axis.text=element_text(size=rel(1.2)), axis.title=element_text(size=rel(1.3), face="bold")) 

pl3


#test for problems in residuals
# res<-simulateResiduals(m2.fruit.net)
# plot(res, rank = TRUE)


library(cowplot)
plot_grid(pl3, pl2, labels = c("A", "B"))

```

Figure X. Partial residual plots showing the effect of a) total pollinator species diversity at the community level and b) functional complementarity between pollinator species on average fruitset at the community level. Dots represent average vaues of fruitset at the level of the community for all plant species considered (N=16 sites).

```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=5, fig.width=10}

#seed number
#How mean seed number is calculated?? scaled first would be better, right? Yes using scaled values

#same as before now averaging per species first and then per site 

library(plyr)

s.comm.prev <- ddply(s4_scaled, c("Site_ID", "nodf.song", "functional.comp.poll", "species.poll"), summarise, tot.visits    = sum(tot.visits),
                         mean.seedset = mean(mean.seedn),
                          mean.seedweight = mean(mean.seedw),
                          mean.fruitweight = mean(mean.fruitweight))


#mean of means!

s.com <- ddply(s4_scaled, c("Site_ID", "Plant.sp", "nodf.song", "functional.comp.poll", "species.poll"), 
               summarise, tot.visits    = sum(tot.visits),
                         mean.seedset = mean(mean.seedn),
                          mean.seedweight = mean(mean.seedw),
                          mean.fruitweight = mean(mean.fruitweight))


s.comm <- ddply(s.com, c("Site_ID", "nodf.song", "functional.comp.poll", "species.poll"), 
               summarise, tot.visits    = sum(tot.visits),
                         mean.seedset = mean(mean.seedset),
                          mean.seedweight = mean(mean.seedweight),
                          mean.fruitweight = mean(mean.fruitweight))



#scale variables for comparison of effect sizes

s.comm$nodf.song.sc <- scale(s.comm$nodf.song, center = T, scale = T)
s.comm$functional.comp.poll.sc <- scale(s.comm$functional.comp.poll, center = T, scale = T)
s.comm$species.poll.sc <- scale(s.comm$species.poll, center = T, scale = T)
s.comm$tot.visits.sc <- scale(s.comm$tot.visits, center = T, scale = T)


#average seed set
#TRY ZERO-INFLATED POISSON!


m1.seed.net <- lm(mean.seedset ~  species.poll.sc + tot.visits.sc,
    data=s.comm,family="gaussian")
 
 summary(m1.seed.net)
 
m2.seed.net <- glm(mean.seedset ~  species.poll.sc + tot.visits.sc + nodf.song.sc + functional.comp.poll.sc, data=s.comm,family="gaussian")
 
 summary(m2.seed.net)
 
#select best model based on AIC 
AICtab(m1.seed.net, m2.seed.net)#both models are equally good

#test for problems in residuals
res<-simulateResiduals(m2.seed.net)
# plot(res, rank = TRUE)

#save table with results for paper
summ.seed.net<-round(summary(m2.seed.net)$coef$cond, digits=2)
#write.csv(summ.seed.net, file="tables/resultsseedsetNETWORK.csv", row.names = TRUE)


y_partial_seed<-keepef(m2.seed.net, fix= c( "tot.visits.sc", "species.poll.sc ", "nodf.song.sc"), ran = "all", keep.intercept = F, grouping = F)

pl4<-ggplot(s.comm,  aes(x=tot.visits.sc, y=mean.seedset))+      
        geom_point(size=4, color="black") + stat_smooth(method=lm,  size=1.5, se=TRUE, color = "black", alpha=0.2) + 
        #geom_smooth(method=lm, linetype= "dashed", size=0.7, se=FALSE, alpha=0.8) +
        xlab("Total number of visits") +      
        ylab("Number of seeds/fruit") + theme_bw()  + #theme (legend.position= "none") +
        theme(text = element_text(size = 20), axis.text=element_text(size=rel(1.2)), axis.title=element_text(size=rel(1.3), face="bold"))

#pl4

pl5<-ggplot(s.comm,  aes(x=functional.comp.poll.sc, y=mean.seedset))+      
        geom_point(size=4, color="black") + stat_smooth(method=lm,  size=1.5, se=TRUE, color = "black", alpha=0.2) + 
        #geom_smooth(method=lm, linetype= "dashed", size=0.7, se=FALSE, alpha=0.8) +
        xlab("Functional complementarity") +      
        ylab("Number of seeds/fruit") + theme_bw()  + #theme (legend.position= "none") +
        theme(text = element_text(size = 20), axis.text=element_text(size=rel(1.2)), axis.title=element_text(size=rel(1.3), face="bold"))

#pl5

library(cowplot)
plot_grid(pl4, pl5, labels = c("A", "B")) #NEED TO DO PARTIAL RESIDUAL PLOTS FOR THIS ONE, BUT BECAUSE I DO NOT KNOW WHETHER THIS FIG WILL ALSO GO ON THE MS NOT DOING IT NOW!
```

Figure X. Partial residual plots showing the effect of a) the total number of pollinator visits received at the community level and b) functional complementarity between pollinator species on the scaled average number of seeds per fruit at the community level. Dots represent average vaues of previously scaled values of the number of seeds per fruit at the level of the community for all plant species considered (N=16 sites).


Contrastingly, in the case of weight variables (fruit and seed weight), in both cases we find that the best model is model 1, i.e., that only including simple visitation metrics. Here, we find a consistent positive effect of community-level pollinator diversity for both weight descriptors.  


```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=5, fig.width=10}

#fruit weight


m1.fruitw.net<-glm(mean.fruitweight ~  species.poll.sc + tot.visits.sc, family="gaussian", data=s.comm)

summary(m1.fruitw.net)
 
 vif(m1.fruitw.net)
 
m2.fruitw.net<-glm(mean.fruitweight ~  species.poll.sc + tot.visits.sc + nodf.song.sc + functional.comp.poll.sc, family="gaussian", data=s.comm)
 
 summary(m2.fruitw.net)
 
 vif(m2.fruitw.net)
 
#select best model based on AIC 

AICtab(m1.fruitw.net, m2.fruitw.net)

#test for problems in residuals
# res<-simulateResiduals(m1.fruitw.net)
# plot(res, rank = TRUE)


#save table with results for paper
summ.fruitw.net<-round(summary(m1.fruitw.net)$coef, digits=2)
#write.csv(summ.fruitw.net, file="tables/resultsfruitweightNETWORK.csv", row.names = TRUE)


crPlots(m1.fruitw.net, smooth=FALSE, terms = ~  species.poll.sc, main = "", ylab = "Mean fruit weight", col.lines= "black", pch=19, col= "black", bg = "darkgrey", cex=2, cex.axis=1.2, cex.lab=1.5, 
        xlab = "Pollinator species diversity")



pred3<-m1.fruitw.net$coef[1]+ (m1.fruitw.net$coef[2] * s.comm$species.poll.sc) + (m1.fruitw.net$coef[3] * mean(s.comm$tot.visits.sc)) 
res3<-pred3-s.comm$mean.fruitweight


#need to see how to change the line of fit  

pl6<-ggplot(s.comm,  aes(x=species.poll.sc, y=res3))+      
        geom_point(size=4, color="black") + stat_smooth(method=lm,  size=1.5, se=TRUE, color = "black", alpha=0.2) + 
        #geom_smooth(method=lm, linetype= "dashed", size=0.7, se=FALSE, alpha=0.8) +
        xlab("Pollinator species diversity") +      
        ylab("Fruit weight (g)") + theme_bw()  + #theme (legend.position= "none") +
        theme(text = element_text(size = 20), axis.text=element_text(size=rel(1.2)), axis.title=element_text(size=rel(1.3), face="bold")) + labs(col="Plant species")

pl6 


#seed weight


m1.seedw.net<-glm(mean.seedweight ~  species.poll.sc + tot.visits.sc, family="gaussian", data=s.comm)

summary(m1.seedw.net)
 
 
vif(m1.seedw.net)
 
m2.seedw.net<-glm(mean.seedweight ~  species.poll.sc + tot.visits.sc + nodf.song.sc + functional.comp.poll.sc, family="gaussian", data=s.comm)
 
summary(m2.seedw.net)
 
vif(m2.seedw.net)
 
#select best model based on AIC 

AICtab(m1.seedw.net, m2.seedw.net) #m1 is better

#test for problems in residuals
# res<-simulateResiduals(m1.seedw.net)
# plot(res, rank = TRUE)

#save table with results for paper
summ.seedw.net<-round(summary(m1.seedw.net)$coef, digits=2)
#write.csv(summ.fruitw.net, file="tables/resultsseedweightNETWORK.csv", row.names = TRUE)


crPlots(m1.seedw.net, smooth=FALSE, terms = ~  species.poll.sc, main = "", ylab = "Mean seed weight", col.lines= "black", pch=19, col= "black", bg = "darkgrey", cex=2, cex.axis=1.2, cex.lab=1.5, 
        xlab = "Pollinator species diversity")





pred4<-m1.seedw.net$coef[1]+ (m1.seedw.net$coef[2] * s.comm$species.poll.sc) + (m1.seedw.net$coef[3] * mean(s.comm$tot.visits.sc)) 
res4<-pred4-s.comm$mean.seedweight

#need to see how to change the line of fit  


pl7<-ggplot(s.comm,  aes(x=species.poll.sc, y=mean.seedweight))+      
        geom_point(size=4, color="black") + geom_smooth(method=lm, size=1.5, se=TRUE, color = "black", alpha=0.2) + 
        #geom_smooth(method=lm, linetype= "dashed", size=0.7, se=FALSE, alpha=0.8) +
        xlab("Pollinator species diversity") +      
        ylab("Seed weight (g)") + theme_bw()  + #theme (legend.position= "none") +
        theme(text = element_text(size = 20), axis.text=element_text(size=rel(1.2)), axis.title=element_text(size=rel(1.3), face="bold")) + labs(col="Plant species")

pl7

library(cowplot)
plot_grid(pl6, pl7, labels = c("A", "B")) 

```
Figure X. Partial residual plots showing the effect of community-level pollinator species diversity on average a) fruit and b) seed weight at the community level. Dots represent average vaues of weight at the level of the community for all plant species considered (N=16 sites).


### Equity in fruitset

When evaluating the effect of differences in community composition and structure for equity in reproductive success across the different species within a community we find that model 1 is the best model for all the thresholds considered (50%, 25% and 75%). However, we find that none of the variables considered are able to explain the differences observed. 
[this is interesting, as selfing rates I expect to be ~ 40%... In any case I am confused now on this calculation]()


```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=5}

#EQUITY SPECIES WITHIN COMMUNITIES

#normalize fruitset values for individuals within species and sites, to have values between 0 and 1

range01 <- function(x){(x-min(x))/(max(x)-min(x))}
f2_scaled_fruit <- f2 %>% group_by(Plant.sp) %>% mutate(tot.fruitset = range01(tot.fruitset))
f2_scaled_fruit2 <- f2 %>% group_by(Plant.sp) %>% mutate(tot.fruitset = scale(tot.fruitset, center = TRUE, scale = TRUE))

#calculate average normalized fruitset values per site to have one unique value per site
f.ag.pr <- ddply(f2_scaled_fruit, c("Site_ID", "Plant.sp", "nodf.song", "functional.comp.poll", "species.poll"), 
              summarise, tot.visits    = sum(tot.visits),
              mean.fruitset = mean(tot.fruitset))
f.ag.pr2 <- ddply(f2_scaled_fruit2, c("Site_ID", "Plant.sp", "nodf.song", "functional.comp.poll", "species.poll"), 
              summarise, tot.visits    = sum(tot.visits),
              mean.fruitset = mean(tot.fruitset))
hist(f.ag.pr2$mean.fruitset)
#select species with normalized values >0.5
f.ag_scaledb<-subset(f.ag.pr, f.ag.pr$mean.fruitset>0.50)
f.ag_scaledb2<-subset(f.ag.pr2, f.ag.pr$mean.fruitset>0)

#for each site here is the number of sps whose fruitset exceeds 50% of maximum fruitset observed in the whole study area
f.ag_scaledb2$no_rows<-rep(1, nrow(f.ag_scaledb2))
f4c<- aggregate(no_rows ~ Site_ID, f.ag_scaledb2, length)
head(f4c)

#because when calculating thresholds, sites with 6 plants can score up to 6, but sites with 4 sites can score max = 4 we corrected for this doing % above threshold, and no number. 
#calculate total number of species per site
f4$no_rows<-rep(1, nrow(f4))
f4d<- aggregate(no_rows ~ Site_ID, f4, length)
head(f4d)

f4c$total.plant.numb<-f4d$no_rows[match(f4c$Site_ID, f4d$Site_ID)]

#remove sites that only have one plant sps, Elpinar and Villamanriqueeste
f4e<-subset(f4c, f4c$total.plant.numb>1)

#calculate equity as proportion of species with >50% of fruitset compared to total number of sps
f4e$equity<-f4e$no_rows/f4e$total.plant.numb

#join this with fruitset data used previously

f4e$nodf.song<-out.site$nodf.song[match(f4e$Site_ID, out.site$Site_id)]
f4e$functional.comp.poll<-out.site$functional.comp.poll[match(f4e$Site_ID, out.site$Site_id)]
f4e$species.poll<-out.site$species.poll[match(f4e$Site_ID, out.site$Site_id)]
f4e$tot.visits<-f.agg$tot.visits[match(f4e$Site_ID, f.agg$Site_ID)]


f4e$species.pl<-out.site$species.pl[match(f4e$Site_ID, out.site$Site_id)]
#scale all variables
f4e$nodf.song.sc <- scale(f4e$nodf.song, center = T, scale = T)
f4e$functional.comp.poll.sc <- scale(f4e$functional.comp.poll, center = T, scale = T)
f4e$species.poll.sc <- scale(f4e$species.poll, center = T, scale = T)
f4e$tot.visits.sc <- scale(f4e$tot.visits, center = T, scale = T)
f4e$species.pl.sc <- scale(f4e$species.pl, center = T, scale = T)

#Nacho depart##
#plot
plot(f4e$equity ~ f4e$functional.comp.poll.sc, las = 1)
#WARNING! Fails, because f4 (as calculated below) removes plants with n = 1 across trials). Hence 1.6 value...

m1 <- glm(equity ~  functional.comp.poll.sc , family="binomial", data=f4e)
m2 <- glm(cbind(no_rows, total.plant.numb) ~  functional.comp.poll.sc , family="binomial", data=f4e)
m3 <- glm(equity ~  functional.comp.poll.sc , weights = total.plant.numb, family="binomial", data=f4e)

summary(m1)
summary(m2)
summary(m3)
#bah...
####


#fit two models
 m1.eq.comm<-glm(equity ~  species.poll.sc + tot.visits.sc , family="binomial", data=f4e)
 

 summary(m1.eq.comm)

 m2.eq.comm<-glm(equity ~  species.poll.sc + tot.visits.sc + nodf.song.sc + functional.comp.poll.sc , family="binomial", data=f4e)
summary(m2.eq.comm) 
 

#select best model based on AIC 

AICtab(m1.eq.comm, m2.eq.comm) #m1 is best no variables significant


#save table with results for paper, both models are equally good so save both tables
summ.eq<-round(summary(m1.eq.comm)$coef, digits=2)
#write.csv(summ.eq, file="tables/resultsequityNETWORKm1.csv", row.names = TRUE)


#partial residual plots


#test for problems in residuals
# res<-simulateResiduals(m1.eq.comm)
# plot(res, rank = TRUE)


#Repeat with 75% threshold

f75<-subset(f.ag.pr, f.ag.pr$mean.fruitset>0.75)

#for each site here is the number of sps whose fruitset exceeds 75% of maximum fruitset observed in the whole study area
f75$no_rows<-rep(1, nrow(f75))
f75b<- aggregate(no_rows ~ Site_ID, f75, length)
head(f75b)

#because when calculating thresholds, sites with 6 plants can score up to 6, but sites with 4 sites can score max = 4 we corrected for this doing % above threshold, and no number. 
#calculate total number of species per site
f4$no_rows<-rep(1, nrow(f4))
f4d<- aggregate(no_rows ~ Site_ID, f4, length)
head(f4d)

f75b$total.plant.numb<-f4d$no_rows[match(f75b$Site_ID, f4d$Site_ID)]

#remove sites that only have one plant sps, Elpinar and Villamanriqueeste
f75c<-subset(f75b, f75b$total.plant.numb>1)

#calculate equity as proportion of species with >50% of fruitset compared to total number of sps
f75c$equity<-f75c$no_rows/f75c$total.plant.numb

#join this with fruitset data used previously

f75c$nodf.song<-out.site$nodf.song[match(f75c$Site_ID, out.site$Site_id)]
f75c$functional.comp.poll<-out.site$functional.comp.poll[match(f75c$Site_ID, out.site$Site_id)]
f75c$species.poll<-out.site$species.poll[match(f75c$Site_ID, out.site$Site_id)]
f75c$tot.visits<-f.agg$tot.visits[match(f75c$Site_ID, f.agg$Site_ID)]

f75c$species.pl<-out.site$species.pl[match(f75c$Site_ID, out.site$Site_id)]
#scale all variables

f75c$nodf.song.sc <- scale(f75c$nodf.song, center = T, scale = T)
f75c$functional.comp.poll.sc <- scale(f75c$functional.comp.poll, center = T, scale = T)
f75c$species.poll.sc <- scale(f75c$species.poll, center = T, scale = T)
f75c$tot.visits.sc <- scale(f75c$tot.visits, center = T, scale = T)

f75c$species.pl.sc <- scale(f75c$species.pl, center = T, scale = T)

#fit two models
 m1.eq.75<-glm(equity ~  species.poll.sc + tot.visits.sc , family="binomial", data=f75c)

 summary(m1.eq.75)

 
m2.eq.75<-glm(equity ~  species.poll.sc + tot.visits.sc + nodf.song.sc + functional.comp.poll.sc , family="binomial", data=f75c)
 
 summary(m2.eq.75)
 
 
#select best model based on AIC 

AICtab(m1.eq.75, m2.eq.75) #m1 better model

# #test for problems in residuals
# res<-simulateResiduals(m1.eq.75)
# plot(res, rank = TRUE)


#Repeat with 25% threshold

f25<-subset(f.ag.pr, f.ag.pr$mean.fruitset>0.25)

#for each site here is the number of sps whose fruitset exceeds 25% of maximum fruitset observed in the whole study area
f25$no_rows<-rep(1, nrow(f25))
f25b<- aggregate(no_rows ~ Site_ID, f25, length)
head(f25b)

#because when calculating thresholds, sites with 6 plants can score up to 6, but sites with 4 sites can score max = 4 we corrected for this doing % above threshold, and no number. 
#calculate total number of species per site
f4$no_rows<-rep(1, nrow(f4))
f4d<- aggregate(no_rows ~ Site_ID, f4, length)
head(f4d)

f25b$total.plant.numb<-f4d$no_rows[match(f25b$Site_ID, f4d$Site_ID)]

#remove sites that only have one plant sps, Elpinar and Villamanriqueeste
f25c<-subset(f25b, f25b$total.plant.numb>1)

#calculate equity as proportion of species with >50% of fruitset compared to total number of sps
f25c$equity<-f25c$no_rows/f25c$total.plant.numb

#join this with fruitset data used previously

f25c$nodf.song<-out.site$nodf.song[match(f25c$Site_ID, out.site$Site_id)]
f25c$functional.comp.poll<-out.site$functional.comp.poll[match(f25c$Site_ID, out.site$Site_id)]
f25c$species.poll<-out.site$species.poll[match(f25c$Site_ID, out.site$Site_id)]
f25c$tot.visits<-f.agg$tot.visits[match(f25c$Site_ID, f.agg$Site_ID)]

f25c$species.pl<-out.site$species.pl[match(f25c$Site_ID, out.site$Site_id)]
#scale all variables

f25c$nodf.song.sc <- scale(f25c$nodf.song, center = T, scale = T)
f25c$functional.comp.poll.sc <- scale(f25c$functional.comp.poll, center = T, scale = T)
f25c$species.poll.sc <- scale(f25c$species.poll, center = T, scale = T)
f25c$tot.visits.sc <- scale(f25c$tot.visits, center = T, scale = T)

f25c$species.pl.sc <- scale(f25c$species.pl, center = T, scale = T)

#fit two models
 m1.eq.25<-glm(equity ~  species.poll.sc + tot.visits.sc , family="binomial", data=f25c)

 summary(m1.eq.25)

 
m2.eq.25<-glm(equity ~  species.poll.sc + tot.visits.sc + nodf.song.sc + functional.comp.poll.sc , family="binomial", data=f25c)
 
 summary(m2.eq.25)
 
#select best model based on AIC 

AICtab(m1.eq.25, m2.eq.25) #m1 is better. 

# #test for problems in residuals
# res<-simulateResiduals(m1.eq.25)
# plot(res, rank = TRUE)
 

```

###Simulating the effect of community structure as sample size increases

Within our simulation evaluating the effect of niche complementarity on equity in reproductive success, we find that the effect of complementarity becomes more important as the reproductive success of more species is considered (Fig. X). This importance seems to reach some sort of plateau at 6 species, however, this should be further evaluated as this is the maximum number of species simultaneously observed in a community for our study which precludes us from simulating further numbers of species.  
 

```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=5}

library(vegan)
library(dplyr)

f2$Plant.sp<-paste(f2$Plant_genus, f2$Plant_species)
f3<-f2[,c(1,13:14)]

f4 <- ddply(f3, c("Site_ID", "Plant.sp"), summarise,
                         mean.fruitset    = mean(tot.fruitset))

table(f4$Plant.sp)
#Astragalus lusitanicus and Cistus albidus is causing problems later on. It has a very low fruit set, but as there is only one value, when correcting for max fruit set, gets a value of 1. Both are in Cotito... This is problematic. Similar with Anchusa azurea. 

#I am removing them here.
f4 <- subset(f4, !Plant.sp %in% c("Astragalus lusitanicus", "Cistus albidus", "Anchusa azurea"))
#Alternative, we use raw values (not dividing by max. and scale. Thos will take value of 0, which is equally arbitrary...)

#Ainhoa, another question, this is a mean per species, right? So, for some species we may have more than one value. 


#f4

fr.max<-aggregate(.~ Plant.sp, f4, FUN=max)

f4$fruit.max<-fr.max$mean.fruitset[match(f4$Plant.sp, fr.max$Plant.sp)]

f4$fruit.prop<-f4$mean.fruitset/f4$fruit.max
head(f4) #this is ok, I guess, but imply we are correcting for differences in production across plants. 

#Quick dirty fix to see if things change a lot for uncorrected values
#f4$fruit.prop <- f4$mean.fruitset
  
#1) First let's calculate all combinations of 1,2,3,4,5,6 species per network.
combinatorials_all <-  matrix(ncol = 5, nrow = 1, NA) 
colnames(combinatorials_all) <- c("SiteID", "Plant_number_level", "iteration", "equity", "functional.comp")
uniqueSite_ID <- unique(f4$Site_ID)
for(k in 1:length(uniqueSite_ID)){ #sites
  Site_temp <- subset(f4, Site_ID == uniqueSite_ID[k]) #1:SiteID
  n <- length(Site_temp$Plant.sp)
  combinatorials <- matrix(ncol = 5, nrow = 1, NA) #flexible
  colnames(combinatorials) <- c("SiteID", "Plant_number_level", "iteration", "equity", "functional.comp")
  combinatorials <- as.data.frame(combinatorials)
  for (i in 1:n){ #levels
    combinatorials_1 <- combn(x = Site_temp$Plant.sp, m = i) #1:n
    for (j in 1:ncol(combinatorials_1)){ #different combinations
      temp1 <- Site_temp[which(Site_temp$Plant.sp %in% combinatorials_1[,j]),]
      combinatorials_2 <- subset(temp1, temp1$fruit.prop > 0.5)
      if(dim(combinatorials_2)[1] == 0) {
        combinatorials_2 <- temp1
        combinatorials_2$no_rows <- 0
      } else{
        combinatorials_2$no_rows<-rep(1, nrow(combinatorials_2))
      }
      #head(combinatorials_2)
      #for each site here is the number of sps whose fruitset exceeds 50% of maximum fruitset observed in the whole study area
      combinatorials_3 <- aggregate(no_rows ~ Site_ID, combinatorials_2, sum)
      #head(combinatorials_3)
      combinatorials_3$functional.comp.poll <- out.site$functional.comp.poll[match(combinatorials_3$Site_ID, out.site$Site_id)]
      #now save for later.
      index <- dim(combinatorials)[1]
      combinatorials[index+1,1] <-  as.character(combinatorials_3$Site_ID) #1:SiteID
      combinatorials[index+1,2] <-  i #Plant number level
      #combinatorials[index+1,3] <-    #"iteration" let's asume we don' care, but would be good for unit testing
      combinatorials[index+1,4] <- combinatorials_3$no_rows/i #above threshold in %
      combinatorials[index+1,5] <-  combinatorials_3$functional.comp.poll #nich comp value...

    } #close different combinations
  } #close levels
  combinatorials_all <- rbind(combinatorials_all, combinatorials[-1,])
} #close sites

combinatorials_all <- combinatorials_all[-1,]

#plot overall (asi a saco)

#scatter.smooth(combinatorials_all$equity ~ combinatorials_all$functional.comp) #no relationship, good
 


#scale variables

combinatorials_all$functional.comp.sc<-scale(combinatorials_all$functional.comp, center = T, scale = T)



#now try overall, per level.
estimate <- rep(NA,6)
for (i in unique(combinatorials_all$Plant_number_level)){
  temp <- subset(combinatorials_all, Plant_number_level == i)
  m <- lm(temp$equity ~ temp$functional.comp.sc)
  plot(temp$equity ~ temp$functional.comp.sc) 
  abline(m)
  estimate[i] <- m$coefficients[2]
  }

#plot(unique(combinatorials_all$Plant_number_level) , estimate, las = 1, ylim = c(-0.01, 0.1) ,
   #  ylab = "importance of niche partitioning", xlab = "number of plants considered")



# I think this is a true pattern, as the for the cnetral limit theorem a mean of means should equal the grand mean, but worth check it.

#now we subsample 16 combinations at a time 100 timeas and make the average.
estimate_i <- data.frame(level = NA, estimate = NA)
estimate_k <- data.frame(level = NA, estimate = NA)
head(combinatorials_all)
for (i in 1:length(unique(combinatorials_all$Plant_number_level))){ # over levels
  temp <- subset(combinatorials_all, Plant_number_level == unique(combinatorials_all$Plant_number_level)[i])
  for(k in 1:100){ #iterations
    value <- data.frame(site = NA, eq = NA, nich = NA)
    for(j in 1:length(unique(temp$SiteID))){ # over sites
      temp2 <- subset(temp, SiteID == unique(temp$SiteID)[j]) #why only one record at Elpinar??
      value_temp <- temp2[sample(x = 1:nrow(temp2), 1),]
      value[j,1] <- value_temp$SiteID
      value[j,2] <- value_temp$equity
      value[j,3] <- value_temp$functional.comp
    } #close sites
    m <- lm(value$eq ~ value$nich)
    #plot(value$eq ~ value$nich)
    estimate_k[k,1] <- i
    estimate_k[k,2] <- m$coefficients[2]  
  } #close iteration
  #unique(estimate_k) #only 5 unique ombinations for n = 5. All negative. highly influenced by one data point of low niche part and equ = 1. "CotitodeSantaTeresa"
  #subset(f4, Site_ID == "CotitodeSantaTeresa") #Super high values!
  estimate_mean <- aggregate(estimate ~ level, data = estimate_k, FUN = "mean")
  estimate_i[i,1] <- estimate_mean$level
  estimate_i[i,2] <- estimate_mean$estimate
  }

estimate_i

#plot(estimate_i$level, estimate_i$estimate, las = 1,
    # ylab = "importance of niche partitioning", xlab = "number of plants considered")


ggplot(estimate_i,  aes(x=level, y=estimate)) +    
  geom_point(size=4) + stat_smooth(method=loess,  size=1.5, se=TRUE, color = "black", alpha=0.2) + 
  #geom_smooth(method=lm, linetype= "dashed", size=0.7, se=FALSE, alpha=0.8) +
  xlab("Number of plant species considered") +      
  ylab("Importance of niche complementarity") + theme_bw()  +
  theme(text = element_text(size = 20), axis.text=element_text(size=rel(1.2)), axis.title=element_text(size=rel(1.3), face="bold")) 

#AM: NOT SURE WHICH FIGURE WE WANT TO USE HERE 

#we had an issue for n = 5 ... this is cause by cotito de santa teresa having a huge influence when only 7 datasets are used. Once This is fixed, the plot looks nice. It's a shame that with 5 and 6 plants it asimptotes, but on the other hand, for 6 plants we only have very few sites.

#One option is removing n = 6 from the simulation, as there is only one model for n = 6, and hence, while all other models estimate better the uncertainty on plant choice, the last model we have just 4 communities.


#Ainhoa, this akes me think that when calculating thresholds, sites with 6 plants can score up to 6, but sites with 4 sites can oscar max = 4. I corrected for this doing % above threshold, and no number. Worth doing the same in the above models.

#I only did it for fruit set.... no seeds, no weight...

```
Figure X. Results of simulation evaluating the importance of niche complementarity in determining differences in equity in reproductive across communities harboring from one to six species. Points represent average values for 16 combinations of XXXX 100 times??? [can you fill this Nacho?]()


#DISCUSSION

The existence of a relationship between community structure and ecosystem function has been long hypothesized, yet, the specific mechanisms by which structure influences function remain elusive [@Thompson2012]. Our results show that different aspects of community structure affect different dimensions of functioning. In particular, we find that the centrality of a species within a community, which measures the number of connections it received from other species in the community, had a positive effect for its fruitset. At the community level, however, we find that niche complementarity between pollinators, a measure of the overlap in the niches of different species in terms of plant coverage, has an important effect for average fruitset. 

One of the first conclusions we can extract from the fact that in most cases both of the models we considered (i.e., the simple model based on visitation metrics and the more complex one including community structure metrics) were equally good, is that for simple predictive purposes, simple visitation metrics, such as pollinator diversity, might be enough [@Garibaldi2013; @Garibaldi2015 estos???][cite Garibaldi papers using them](). Yet, a mechanistic understanding of the underlying processes requires that we take into account measures of community structure, and in particular those related to the overlap in the niches of interacting species. 

Consistent with previous studies conducted within experimental [@Fontaine2005; @Frund2013] and natural [@Valdovinos2016] communities, we find that niche complementarity is very important in determining differences in reproductive outputs. Similar to these previous studies, we find that communities where there is less overlap in the niches occupied by pollinator species had greater values of reproductive success, both greater fruitset values and larger numbers of seeds per fruit. Indeed, this reflects the fact that reproductive success in plant species requires of the delivery of conspecific pollen and thus of a certain degree of specialization amongst pollinator species on a particular plant resource in order to avoid the negative effects of inter-specific pollen deposition (e.g., pollen loss [@Flanagan2009] or interference with conspecific pollen [@Morales2008]). 

In our study, we did not find an effect of nestedness for reproductive success in any case. This metric, widely used across network analysis, and which is deemed to stabilize [@Bastolla2009] or destabilize [@James2012] natural communities, does not seem to play a direct role in ecosystem function measured as plant reproductive success. However, our study is limited to a maximum of six plant species per community, and including more species might reveal different patterns, in which nestedness and the redundancy it implies might play a more important role.
 
Community-level plant reproductive success, measured as average fruit or seed set across all the species considered [@Frund2013], is an important part of the functions delivered by pollinators to plants. However, these average values might be masking a great deal of variability amongst species, and thus a nuanced view of the effect of pollinators on whole-plant ensembles is that which we include in our analyses: the effect of pollinators on equity in reproductive succes across plant species. This aspect ensures that reproductive success is equally distributed amongst a larger number of species, thus contributing to the maintenance of a greater species diversity in natural populations. Indeed, we know that plant species diversity within a community is largely driven by different types of direct and indirect interactions including those amongst plant species (e.g., resource competition [@Goldberg1992] or facilitation [@Bruno2003]), as well as those defining antagonistic (e.g., involving pathogens [@Bagchi2010], or mutualistic interactions (e.g, pollinators [@Benadi2013]).
However, equitability in reproductive success across species is seldom taken into account, despite its importance in maintaining genetic diversity and ensuring the resilience of populations to further change (REF). 

In the case of equity we did not find a significant effect of either simple visitation or community structure metrics. However, the results of our simulation on the importance of community structure as the number of plant species considered increases shows us that this effect dramatically increases when more than four plant species are considered. This implies that if we were able to measure reproductive success for all the plant species in all the communities (which we cannot do due to constraints on sampling effort), we might find that the effects of community structure might be even more prevalent.

In summary, our findings show that the analysis of natural communities of interacting species using network analysis not only represents an ideal way of visualizing and grasping the complexity present within these communities, but also represents a manner of mechanisitically understanding differences observed across individuals and/or species. 

Future studies could build on this body of research by focusing on the long-lasting effects of community structure for plant fitness, by evaluating the consequences of different community structures for heritability. 

##References