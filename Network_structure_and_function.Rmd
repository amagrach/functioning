---
title: Niche complementarity among pollinators increases community-level plant reproductive success 
author: "Magrach, A, Molina, FP, Bartomeus, I"
csl: ecology-letters.csl
output:
  word_document: default
  html_document: default
  pdf_document: default
editor options:
  chunk_output_type: console
bibliography: library.bib
---

**Niche complementarity among pollinators increases community-level plant reproductive success**

Ainhoa Magrach^1^ ^2^, Francisco P. Molina^3^, Ignasi Bartomeus^3^

Short running title: Network structure effects on ecosystem functioning

^1^Basque Centre for Climate Change-BC3, Edif. Sede 1, 1º, Parque Científico UPV-EHU, Barrio Sarriena s/n, 48940, Leioa, Spain

^2^IKERBASQUE, Basque Foundation for Science, María Díaz de Haro 3, 48013, Bilbao, Spain

^3^Estación Biológica de Doñana (EBD-CSIC), Avda. Américo Vespucio 26, Isla de la Cartuja, 41092, Sevilla, Spain


Type of article: Letter

Words in Abstract: 147 words

Words in main text (excluding abstract, acknowledgements, references, table and figure legends): 5,272


Number of references: 67

Number of figures, tables and text boxes: 5

Corresponding author: ainhoa.magrach@bc3research.org, nacho.bartomeus@gmail.com

Keywords: nestedness, niche complementary, fruitset, pollination, plant-pollinator interactions

\nextpage

**Abstract**

Our understanding of how the structure of species interactions shapes natural communities has increased, particularly regarding plant-pollinator interactions. However, research linking pollinator diversity to reproductive success has focused on pairwise plant-pollinator interactions, largely overlooking community-level dynamics. Here, we present one of the first empirical studies linking pollinator visitation to plant reproduction from a community-wide perspective using a well-replicated dataset encompassing 16 plant-pollinator networks and data on reproductive success for 19 plant species from Mediterranean shrub ecosystems. We find that statistical models including simple visitation metrics are sufficient to explain the variability observed. However, a mechanistic understanding of how pollinator diversity affects reproductive success requires additional information on network structure. Specifically, we find positive effects of increasing complementarity in the plant species visited by different pollinators on plant reproductive success. Hence, maintaining communities with a diversity of species but also of functions is paramount to preserving plant diversity.

\nextpage


**Introduction**

Pollinators provide key services to plants by facilitating pollen flow between individuals [@Garibaldi2013]. Records of declining trends for some pollinator species in some regions ([@Potts2010; @I.2019]) have led researchers to focus on the functional impacts of these changes in pollinator diversity, especially on the consequences for plant reproductive success [@Biesmeijer2006]. 

  Many research efforts have targeted the reproductive success of individual plant species [@Albrecht2012; @doi:10.1111/1365-2745.13055], and used relatively simple visitation metrics (e.g., the number of pollinator species that visit a plant or the number of visits they perform) to explain the differences observed (e.g., [@Bommarco2012]). Contrastingly, community-level analyses remain scarce [@Bennett2018]. Yet plants and pollinators do not interact in isolation, but rather are embedded within larger networks of interactions encompassing other plant and pollinator species [@Memmott2004a]. We are thus missing an important part of the picture, which includes the direct interactions between the whole ensemble of plants and pollinators, but also the indirect interactions between species within one guild (e.g., plants) through their shared resources [@Carvalheiro2014; @Lazaro2014; @Mayfield2017; @Pauw2013; @Johnson2019]. Understanding how changes in pollinator diversity and interaction structure affect ecosystem functioning is thus a major challenge that requires attention.

  The few pollination studies that have analyzed the effects of changing pollinator diversity for reproductive success at the community level have done so using mainly experimental setups. As an example, a study that experimentally recreated a plant community with 9 plant species and differing levels of pollinator diversity across different enclosures, found a positive effect of pollinator species diversity on seed set, but also an important effect of niche complementarity between pollinators, a measure of community structure [@Frund2013]. These findings show that not only the diversity of species present, but also the diversity of roles they play and the way in which a community is structured are determinant factors of ecosystem functions.

  Indeed, theoretical research has long suggested that the structure of multitrophic communities has an effect for ecosystem functioning (reviewed in [@Thompson2012]). This line of research, rooted in niche theory and revamped by food-web studies [@Godoy2018; @Macarthur1967; @May1972a; @Tilman1982], has greatly advanced theory, but the relationship between structure and function has seldom been tested using empirical data (but see [@Kaiser-Bunbury2017; @Poisot2013; @Lazaro2019]). Specifically, a major knowledge gap resides in understanding which aspects of structure determine which aspects of function [@Thompson2012]. This is because although a network perspective has promised to encapsulate complex ecological mechanisms occurring at the community level – such as indirect interactions [@Abrams1998; @Holt1977] or niche overlap [@Woodward2002]- less attention has been given to the ways in which these mechanisms relate to observed ecosystem processes [@Bluthgen2010a]. In contrast, we are now at a point where we understand some of the emergent patterns characterizing mutualistic interaction networks at the community level, especially in the case of pollination [@Bascompte2007a]. Amongst them is the prevalence of nested structures, i.e., arrangements where specialist species interact with a subset of the species that generalists interact with [@Bascompte2003]. Further, plant-pollinator interaction networks seem to exhibit a relatively high extent of complementary specialization at the community scale, which may be directly related to key ecosystem functions [@Bluthgen2011]. However, the mechanisms by which these attributes affect plant reproduction remain to be understood [@Winfree2013]. The time is thus ripe to explore the relationship between community structure and ecosystem functioning empirically, with special emphasis on the underlying ecological mechanisms that drive these relationships.

  Here, we present an empirical study linking pollinator visitation and plant reproductive success at the community level using empirical data on plant-pollinator interaction networks and plant reproductive success. To this end, we use a well-replicated dataset encompassing plant-pollinator interaction networks collected at 16 sites coupled with data on the reproductive success of 19 plant species recorded in Mediterranean shrub ecosystems. Our study focuses on understanding whether adding information on selected interaction network structure indices to previously used simple visitation metrics (e.g., the number and diversity of pollinator species visiting a plant species) aids in better explaining the differences observed in community-wide reproductive success. In doing so, we conducted our analyses focusing on reproductive success at two different levels: (i) at the species level by considering the association between the position of a focal species within the larger network and its link to individual reproductive success, and (ii) at the site level, by evaluating how attributes that describe the whole site might affect average values of reproductive success for all species measured within one particular site. Specifically, our study focuses on how the interplay between the complementarity in plant species visited by different pollinators (i.e., the complementarity in the functions they perform) and the redundancy in this function relates to reproductive success. Plant reproductive success requires of the delivery of conspecific pollen and thus of a certain degree of niche complementarity [@Bluthgen2011]. Yet, greater values of redundancy in species functions (e.g., that provided by nested structures), are thought to promote species diversity [@Bastolla2009] and stability [@Thebault2010a] within plant-pollinator networks. At present, we do not know how either of these network characteristics affects the functions performed by pollinators. 

  Our results suggest that models including information on simple visitation metrics alone are good in explaining the variability observed in reproductive success. However, insights into the mechanisms through which differences in pollinator diversity translate into changes in reproductive success require additional information on network structure, notably information on the complementarity between the functions performed and the niches occupied by different pollinator species. Specifically, we find a positive effect of increasing niche complementarity between pollinators on plant reproductive success. 



```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE}

#LOAD ALL NECESSARY DATA AND PACKAGES

#R PACKAGES

library(devtools)
#Then install the data package. Reprot issues 
#install_github("ibartomeus/BeeFunData", ref = "fun")

library(BeeFunData)#this package holds all the necessary data
library(plyr)
library(dplyr)
library(ggplot2)
library(grid)
library(iNEXT)
require(Hmisc)
library(knitr)
library(lme4)
library(lmerTest) #to calculate coeff and p values
library(car) #to calculate VIF
library(bbmle)  #to select best model based on AIC
library(ggplot2)
library(DHARMa) #to check for problems in residuals
library(reshape2)
library(spaa)
library(cowplot)
#devtools::install_github("hohenstein/remef")
library(remef)
library(glmmTMB)
library(vegan)
library(piecewiseSEM)
library(MuMIn)
library(jtools)
library(sjPlot)

#LOAD ALL DATA

d<-all_interactions
dtrans<-subset(d, d$Out=="transect")  #keep only records within transects, eliminate focal and other records outside transects
f<-fruitset
s<-seedset
flower_count<-flowers

f$Plant.sp<-paste(f$Plant_genus, f$Plant_species)
f$Plant.sp<-as.factor(f$Plant.sp)

s$Plant.sp<-paste(s$Plant_genus, s$Plant_species)
s$Plant.sp<-as.factor(s$Plant.sp)


#1st eliminate frutos perdidos
wordList <- c("fruto perdido","frutos perdidos")

f2<-subset(f, Notes %nin% wordList)

#calculate column with fruit set as
f2$tot.fruitset<-(f2$Fruit_Yes +  f2$Fruit_preyed + f2$Fruit_dispersed)/(f2$Fruit_Yes +f2$Fruit_No + f2$Fruit_preyed + f2$Fruit_dispersed)


s2<-subset(s, Notes %nin% wordList)

#calculate average seed set per plant individual, there are several fruit measurements per plant and would lead to 3 nested random factors

s3 <- ddply(s2, c("Site_ID", "Plant.sp", "Plant.ID"), summarise,
                         mean.seedn    = mean(Seeds2),
                          mean.seedw = mean(Seed.weight),
                          mean.fruitweight = mean(Fruit.weight2))


###### read network and species level files (network analyses to be found at "...scripts/network analysis.R")

outsp.pl.site<-read.csv("SITE_plant_species_level_metrics.csv")
outsp.site<-read.csv("SITE_species_level_metrics.csv")
out.site<-read.csv("SITE_network_level_metrics.csv")
```


```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE}
#check number of sps per site surveyed in the focal analyses

foc<-subset(d, d$Out=="focal")
foc2<-ddply(foc, c("Site_ID", "Plant_gen_sp"), summarise, 
              tot.species = length(Plant_gen_sp)) #number of species per site
foc3<-ddply(foc2, c("Site_ID"), summarise, 
            tot.species = length(Site_ID)) #number of species per site

```


```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE}

#calculate sorensen index to look at beta-diversity across sites for plants
library(betapart)
dtrans<-subset(d, d$Out=="transect") #keep only plants surveyed in transects, remove focals
d.beta<-table(dtrans$Site_ID, dtrans$Plant_gen_sp)
d.beta[d.beta>1]<-1 
d.betadiv<-mean(betadiver(d.beta, method = 11)) 
#summary(betadiver(d.beta, method = 11)) #max value 0.66.
```


**Methods**

_Plant pollinator interactions_

Our study was conducted in SW Spain within the area of influence of Doñana National Park, i.e., within the limits of the Natural Space of Doñana as defined by the local government (Junta de Andalucía, Fig. S1). All 16 sites were located within similar elevations (ranging from 50 to 150 m a.s.l.), similar habitat and soil types, and presented similar plant composition (plant mean Sørensen beta-diversity among sites = `r round(d.betadiv, 2)`), reducing potential confounding factors. Here, we surveyed 16 Mediterranean woodland patches with an average distance of 7 km between them (min= 3 km, max= 46.5 km). Each site was surveyed every two weeks for a total of 7 times during the flowering season of 2015 (from February to May) following a 100-m x 2 m transect for 30 mins. Along each transect, we identified all plant species and recorded all the floral visitors that landed on their flowers during each 30-min period. Only floral visitors (from now on referred to as pollinators) that could not be identified in the field were captured, stored and identified in the laboratory by FPM and another expert entomologist (see acknowledgements). All surveys were done under similar weather conditions, avoiding windy or rainy days, during mornings and afternoons with the sampling order being established randomly. Within each transect every 10 m we surveyed a 2x2 m quadrant where the number of flowers per species were counted, i.e., 10 quadrats per transect which makes 40m2 of area surveyed overall. 

```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE}

f.inds<-ddply(f, c("Site_ID", "Plant.sp"), summarise, 
                   tot.inds = length(Plant.sp)) #number of individuals per plant sps


tableS1<-ddply(f.inds, c("Site_ID"), summarise, 
                   tot.sps = length(Site_ID)) #number of plant sps per site


s.fruitnum<-ddply(s, c("Site_ID", "Plant.sp"), summarise, 
                   tot.fruits = length(Plant.ID)) #number of fruits per individual



```


_Plant reproductive success_

Within each site, we marked between 3 and `r max(f.inds$tot.inds)` individuals (mean $\pm$ SD: `r round(mean(f.inds$tot.inds), digits=2)` $\pm$ `r round(sd(f.inds$tot.inds), digits=2)`, Table S2) belonging to `r min(tableS1$tot.sps)` to `r max(tableS1$tot.sps)` plant species (mean $\pm$ SD:`r round(mean(tableS1$tot.sps), digits=2)` $\pm$ `r round(sd(tableS1$tot.sps), digits=2)`, Table S2). For each individual, at the end of the season, we recorded fruit set (i.e. the proportion of flowers that set fruit), the average number of seeds per fruit and the average fruit and seed weight per fruit (`r min(s.fruitnum$tot.fruits)`-`r max(s.fruitnum$tot.fruits)` fruits subsampled, mean $\pm$ SD: `r round(mean(s.fruitnum$tot.fruits), digits=2)` $\pm$ `r round(sd(s.fruitnum$tot.fruits), digits=2)`, Table S3). These last two variables show a strong correlation (Pearson correlation= 0.89), but we believe they provide complementary information. Our survey included a total of `r nlevels(f2$Plant.sp)` different totally or partially self-incompatible plant species that depend on pollinators to maximize their reproduction (Table S4) across our `r nlevels(f2$Site_ID)` sites. All plant species were shrubs selected to be common and widespread species. Individuals were selected depending on the presence of flowers during the sampling events. In addition to species-level values, we also calculated the average reproductive success at the site level. To that end, the values of reproductive success obtained at the species level were averaged per site.

_Data analyses_

In order to evaluate the completeness of our sampling, we estimated the asymptotic number of species of plants, pollinators and interactions present [@Chao2009], a non-parametric estimator of species richness for abundance data. This estimator includes non-detected species and allowed us to calculate the proportion detected with our original sampling data. We used Chao 1 asymptotic species richness estimators [@Chao2009] and estimated the richness of pollinators, plants and plant–pollinator links accumulated as sampling effort increased up to 100% sampling coverage using package iNEXT [@Hsieh2016] within the R environment [@RDevelopmentCoreTeam2011]. We then extracted the values covered by our sampling.

  In order to analyse how differences in network structure between communities might affect plant reproductive success, we constructed quantitative plant-pollinator interaction networks by pooling the data for the 7 rounds of sampling. We thus obtained one interaction network per site, representing the number of individuals of different pollinator species recorded visiting each different plant species. For each network, we then extracted a series of relevant network metrics at the species and site levels.
  
  In addition, we checked for potential spatial autocorrelation in our data by means of Mantel correlograms. Autocorrelation values were non-significant for all variables included in our analyses, except in the case of pollinator richness where we have a small but significant effect at small spatial scales (Fig. S2), and hence we treat each site as independent in our analysis.    

_Species-level network analysis_

At the species level, we focused on attributes defining the position of a focal plant species within the larger community. As such, we considered two metrics providing complementary non-redundant information: (i) average niche overlap in terms of pollinators between a focal plant species and each of the other plant species in the community, which estimates the potential indirect interactions between different plant species through shared resources (in this case pollinators) and the potential for increased heterospecific pollen deposition [@Arceo-Gomez2019], and (ii) centrality, which depicts the importance of the role played by a plant species within the larger community (as resource for a large number of pollinator species) and its contribution to network cohesiveness. 
 Niche overlap was calculated as the average overlap in pollinator species visiting a focal plant and each of the other plants in the community using the Morisita overlap index, a measure of similarity between two sets of data [@Zhang2016]. As a measure of centrality, we used weighted closeness centrality, which represents the number of shortest paths going through a focal plant based on a unipartite projection of the bipartite plant-pollinator network using a weighted representation of the network [@Dormann2009]. With this method, links between plant species represent shared pollinator species.  
 

_Site-level network analysis_

At the site level, we followed the same logic as the one presented at the species level. Thus, we also calculated two network metrics providing complementary non-redundant information. In this case we focused on a metric that measures the redundancy in the plants visited by different pollinators, nestedness, and another one, not correlated with the previous one, measuring the complementarity in the plant species visited by the different pollinator species, pollinator niche complementarity. 

  Nestedness is the property by which specialists interact with a subset of the species that generalists interact with [@Bascompte2003]. Although there is an ongoing debate in the literature (e.g., [@James2012]), some theoretical studies have found that nested networks are more stable and resilient to perturbations because nestedness promotes a greater diversity by minimizing competition among species in a community [@Bastolla2009]. However, many network attributes vary with network size and complexity [@Bluthgen2006]. In the case of nestedness, we know it can be affected by network size and connectance [@Song2017a]. An approach that is often used to correct for this, is to use null models and to compare null-model corrected nestedness values across different networks. However, this approach has been shown to present the same issues, as z-scores also change with network size and connectance [@Song2017a]. We thus followed the advice provided by Song et al. (2017) by using a normalized value of the widely used nestedness metric NODF based on binary matrices [@Almeida-Neto2011], $NODF_c$. This normalized value is calculated as $NODF_c = NODF_n/(C * log(S))$, where C is connectance and S is network size, calculated as $S = \sqrt(ncol(web)*nrow(web))$. $NODF_n$ is calculated as $NODF/max(NODF)$, which is independent of network size and thus comparable across different networks [@Song2017a]. To calculate max(NODF) we used a corrected version of the algorithm [@Simmons2019a] whenever possible. Results did not change qualitatively when using the uncorrected version of the algorithm for all sites as both are highly correlated (Spearman correlation = 0.94).

 To calculate niche complementarity, we used a community-level measure defined as the total branch length of a dendrogram based on qualitative differences in visitor assemblages between plants [@Devoto2012; @Petchey2007a]. All network metrics were calculated using package bipartite [@Dormann2009].


_Statistical analyses_

To evaluate whether adding information on network structure improves our ability to explain differences in reproductive success - both at the species and the site level - we used generalized linear (GLMs) and generalized linear mixed models (GLMMs) respectively. In both cases (species and site-level models) we fit three types of models: (i) model 0, a null model with no explanatory variables,(ii) model 1, that only included simple visitation metrics and (iii) model 2 that additionally included information on network structure. These models are meant to be additive, so that the network metrics included are intended to complement rather than substitute the simple metrics traditionally used.  

At the species level, response variables included fruit set analyzed using a binomial distribution and the average number of seeds per fruit, the average fruit and seed weight fitted using normal distributions. The number of seeds per fruit was centered and scaled (i.e., we subtracted column means and divided by standard deviation) to allow meaningful comparisons across species with contrasting life histories. As explanatory variables, model 1 included the number of pollinator species observed, and the visitation rate received by each plant species. Visitation rate was calculated as the total number of visits received by a plant species divided by the average number of flowers of that species found in the 10 2x2 m quadrats located every 10 m along the transect. In turn, model 2 added the two network attributes calculated at the species level: average plant niche overlap and centrality. For both models, we included plant species identity nested within site and site as random effects to account for the fact that several individuals of the same plant species were measured at each site.   
  
	At the site level, response variables were the average reproductive success of all plants surveyed within a site (i.e., average fruit set analyzed using a binomial distribution, average number of seeds per fruit and average fruit and seed weight using a normal distribution). We thus had a single value per site and no random effects are needed. In this case, model 1 included total pollinator richness and total pollinator abundance (i.e. number of visits received by all plants within the community) as explanatory variables. Model 2, in turn, added information on network structure by including nestedness and pollinator niche complementarity. 

  Average values of reproductive success at the site level can be driven to a large extent by a single plant species. Yet, what will determine the persistence of a diverse plant community, is the presence of some sort of “equity” or evenness in reproductive success across the whole community. We therefore calculated the proportion of species with normalized (between 0 and 1) average fruit set values that were above the 50^th percentile as a measure of equity. As any selected threshold is arbitrary, we repeated this using the 25^th and 75^th percentile thresholds [@Byrnes2014]. We then used the same framework as that used for species and site-level analyses and fit the same models 0, 1 and 2 GLMs using equity in reproductive success as response variable and fitting a binomial distribution. 
  
  In all cases, we used variance inflation factors to check for collinearity between explanatory variables. Additionally, we ran residual diagnostics to check if model assumptions were met and used the Akaike Information Criterion (AIC) to compare model performance and complexity. Whenever the difference between the AIC of the models was < 2 ($\Delta AIC<2$), we considered that all models were equally good [@Burnham2011]. In the case of mixed models, for comparison, models were fitted by maximum likelihood and then the best model was refitted using restricted maximum likelihood. All predictor variables were standardized prior to analysis. For every model we also calculate the R2 value using the approximation suggested for GLMMs when necessary [@Shinichi2017].

  Finally, we tested whether the importance of network structure in explaining differences in equity in reproductive success increases with the number of plant species being considered. We expect that when only one plant species is considered the importance of network structure will be negligible, while we expect it to increase as more plant species are considered (up to a maximum number of 6 species which is the maximum we have measured in our study at a particular site).

  To test this, we ran a simple simulation in which the number of species considered increased at each step and for each step we re-calculated equity in reproductive success. Instead of drawing plant species randomly for each step, we tested all possible combinations for each plant number level and network, as the number of combinations is small (e.g. for n = 3 plant selected out of 6 there is only 20 possible combinations). Then, we tested if the relationship between equity in reproductive success and niche complementarity (given its importance in determining differences in reproductive success, see Results section) changes as a function of the number of plants considered within our simulated communities. To this end, for each level of species number considered, we randomly selected one of the generated equity values across each of the 16 communities and regressed these 16 values against our network level predictor and extracted the model slope estimates. We repeated this process 1,000 times and averaged all slope estimates. We expect that the more plants considered, the larger the resulting average estimates will be. Note that we only interpret the mean effects, as the variance among different plant number of species considered depends on the initial number of possible combinations.


**Results**


```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE}

#check proportion represented by each order, hymenoptera, diptera, coleoptera...
 tr<-read.csv("traits_ainhoa.csv")
# #head(tr)
# 
 dtrans$order<-tr$order[match(dtrans$Pollinator_gen_sp, tr$Pollinator_gen_sp)]
 d.order<- aggregate(Frequency ~ order, dtrans, FUN= "sum")
 d.order$prop<-d.order$Frequency/sum(d.order$Frequency)

```


Within our sampling we recorded `r nrow(dtrans)` plant-pollinator interactions involving `r nlevels(unique(dtrans$Pollinator_gen_sp))` pollinator species and `r nlevels(unique(dtrans$Plant_gen_sp))` plant species (Table S1). Within the pollinator community the distribution of individuals in different orders was: `r round(d.order$prop[d.order$order=="Hymenoptera"]*100, digits=2)`% Hymenoptera, `r round(d.order$prop[d.order$order=="Diptera"]*100, digits=2)`% Diptera, `r round(d.order$prop[d.order$order=="Coleoptera"]*100, digits=2)`% Coleoptera and `r round(d.order$prop[d.order$order=="Lepidoptera"]*100, digits=2)`% Lepidoptera.


```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE}

#######CALCULATE SAMPLING COMPLETENESS FOR POLLINATORS, PLANTS AND LINKS 

#POLLINATORS
d2<-table(dtrans$Site_ID, dtrans$Pollinator_gen_sp)
d3<-as.data.frame.array(d2)

d4 <- t(d3[,1:ncol(d3)]) 
#head(d4)
#str(d4)
d5<-as.data.frame(d4)
#str(d5)
d6<-as.list(d5)


rar <- iNEXT(d6, q=0, datatype="abundance", endpoint = 400)
poll<-ggiNEXT.iNEXT(rar, color.var="site", se=FALSE) + ylab("Pollinator sps richness") + theme_bw() + 
  theme (legend.position= "none") + theme(text = element_text(size = 15), axis.text=element_text(size=rel(1)),
                                          axis.title.x = element_blank(),
        axis.title=element_text(size=rel(1),face="bold"), legend.direction="horizontal", legend.text=element_text(size=10)) +
  scale_color_manual(values=c("#F1BB7B", "#FD6467", "#5B1A18", "#D67236", "#E6A0C4", "#C6CDF7", "#D8A499", "#7294D4", "#D8B70A", "#02401B", "#A2A475", "#81A88D", "#972D15", "#9C964A", "#CDC08C", "#FAD77B"))

#poll


#per site sampling completeness for pollinators
#Aznalcazar 37/69.649 = 0.53
#Bonares  31.000/141.319 = 0.22
#ConventodelaLuz  14.000/53.512 = 0.26
#CotitodeSantaTeresa  24.000/67.798 = 0.35
#Elpinar  12.000/22.105= 0.54
#Elpozo  17.000/99.015= 0.17
#Esparragal  18.000/65.185= 0.28
#LaCunya  18.000/58.842= 0.31
#LaRocina  35.000/106.621 = 0.33
#Lasmulas  23.000/102.159 = 0.23
#Niebla   40.000/91.656 = 0.44
#PinaresdeHinojos 16.000/35.290  = 0.45
#Pinodelcuervo  24.000/76.650  = 0.31
#Urbanizaciones  20.000/74.730 = 0.27
#Villamanriqueeste  29.000/68.395 = 0.42
#Villamanriquesur  25.000/56.590 = 0.44


#(0.53+0.22+0.26+0.35+0.54+0.17+0.28+0.31+0.33+0.23+0.44+0.45+0.31+0.27+0.42+0.44)/16
#TOTAL AVERAGE sampling completeness of pollinators 0.35


#PLANTS
d.pl<-table(dtrans$Site_ID, dtrans$Plant_gen_sp)
d.pl2<-as.data.frame.array(d.pl)

d.pl3 <- t(d.pl2[,1:57])
#head(d.pl3)
#str(d.pl3)
d.pl4<-as.data.frame(d.pl3)
#str(d.pl4)
d.pl5<-as.list(d.pl4)


rar2 <- iNEXT(d.pl5, q=0, datatype="abundance", endpoint = 200)
plant<-ggiNEXT.iNEXT(rar2, color.var="site", se=FALSE) + ylab("Plant sps richness") + 
  theme_bw()  + theme (legend.position= "none") + theme(text = element_text(size = 15), axis.text=element_text(size=rel(1)),
                                                         axis.title.x = element_blank(),
        axis.title=element_text(size=rel(1),face="bold"), legend.direction="horizontal", legend.text=element_text(size=10)) +
  scale_color_manual(values=c("#F1BB7B", "#FD6467", "#5B1A18", "#D67236", "#E6A0C4", "#C6CDF7", "#D8A499", "#7294D4", "#D8B70A", "#02401B", "#A2A475", "#81A88D", "#972D15", "#9C964A", "#CDC08C", "#FAD77B"))


#plant


#per site sampling completeness for plants
#Aznalcazar 12.000/12.988 = 0.92
#Bonares  9.000 /9.000 = 1
#ConventodelaLuz  9.000/9.976 = 0.90
#CotitodeSantaTeresa   7.000/7.243 = 0.97
#Elpinar  6.000/8.842 = 0.68
#Elpozo  5.000/5.000  = 1
#Esparragal   8.000/8.963 = 0.89
#LaCunya  11.000/17.042  = 0.65
#LaRocina  11.000/25.737 =  0.43
#Lasmulas  9.000/9.977 = 0.90
#Niebla  19.000/21.948 = 0.87
#PinaresdeHinojos 8.000/10.152 = 0.79
#Pinodelcuervo  12.000/26.625 = 0.45
#Urbanizaciones   9.000/16.784 = 0.54
#Villamanriqueeste  6.000/6.977 = 0.86
#Villamanriquesur  9.000/9.975 = 0.90

#(0.92 + 1 + 0.90 + 0.97 + 0.68 + 1 + 0.89 + 0.65 + 0.43 + 0.90 + 0.87 + 0.79 + 0.45 + 0.54 + 0.86 + 0.90)/16

#TOTAL AVERAGE sampling completeness of plants 0.80


#LINKS

dtrans$link<-paste(dtrans$Plant_gen_sp, dtrans$Pollinator_gen_sp)
d.l<-table(dtrans$Site_ID, dtrans$link)
d.l2<-as.data.frame.array(d.l)

d.l3 <- t(d.l2[,1:384])
#head(d.l3)
#str(d.l3)
d.l4<-as.data.frame(d.l3)
#str(d.l4)
d.l5<-as.list(d.l4)


rar3 <- iNEXT(d.l5, q=0, datatype="abundance", endpoint = 500)
link<-ggiNEXT.iNEXT(rar3, color.var="site", se=FALSE) + ylab("Link richness") + theme_bw() +
   theme (legend.position= "none") + theme(text = element_text(size = 15), axis.text=element_text(size=rel(1)),
        axis.title=element_text(size=rel(1),face="bold"), legend.direction="horizontal", legend.text=element_text(size=10)) +
 scale_color_manual(values=c("#F1BB7B", "#FD6467", "#5B1A18", "#D67236", "#E6A0C4", "#C6CDF7", "#D8A499", "#7294D4", "#D8B70A", "#02401B", "#A2A475", "#81A88D", "#972D15", "#9C964A", "#CDC08C", "#FAD77B"))
  

#link


#per site sampling completeness for links
#Aznalcazar 58.000/239.782 = 0.24
#Bonares  39.000/122.556 = 0.32
#ConventodelaLuz  26.000/114.049 = =0.23
#CotitodeSantaTeresa  30.000/206.890 = 0.15
#Elpinar  17.000/70.289 = 0.24
#Elpozo   23.000/93.125 = 0.25
#Esparragal   23.000/119.296  = 0.19
#LaCunya  27.000/119.800 = 0.23
#LaRocina  43.000/379.246 = 0.11
#Lasmulas  30.000/94.622 = 0.32
#Niebla  51.000/397.586 = 0.13
#PinaresdeHinojos  22.000/232.913 = 0.09
#Pinodelcuervo   35.000/191.162  = 0.18
#Urbanizaciones  28.000/168.108 = 0.17
#Villamanriqueeste  37.000/162.023 = 0.23
#Villamanriquesur  34.000/253.375  =  0.13

#(0.24 + 0.32 + 0.23 + 0.15 + 0.24 + 0.25 + 0.19 + 0.23 + 0.11 + 0.32 + 0.13 + 0.09 + 0.18 + 0.17 + 0.23 + 0.13)/16

#TOTAL AVERAGE sampling completeness of links 0.20


#FIGURE S2 AT THE END OF THE PAPER

# grid.newpage()
# grid.draw(rbind(ggplotGrob(poll), ggplotGrob(plant), ggplotGrob(link), size = "last"))

FigureS3<-cowplot::plot_grid( poll, plant, link, ncol = 1)

```


  Our sampling completeness analyses revealed that with our survey we were able to capture 17-54% of pollinator species (average = 35%), 43-100% for plant species (average = 80%) and 9-32% for plant-pollinator links (average = 20%), in line with that obtained with other studies (e.g., [@Chacoff2012], Fig. S3). Our values of sampling completeness were slightly smaller in the case of pollinators, probably as a consequence of the great diversity found in the Mediterranean region and within our study area in particular, a hotspot of insect diversity [@Nieto2014].  

```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE}

# CALCULATE NICHE OVERLAP BETWEEN PLANT SPECIES AND RELATIVE 
#NUMBER OF VISITS AND JOIN FRUITSET DATA WITH NETWORK METRICS

#calculate RELATIVE number of visits per plant sps
flower_count$Plant_gen_sps<-paste(flower_count$Plant.genus, flower_count$Plant.species)

flower_count2<-ddply(flower_count, c("Site_ID", "Plant_gen_sps"), summarise,
             tot.flowers= sum(Flower.abundance))

flower_count2$j<-paste(flower_count2$Site_ID, flower_count2$Plant_gen_sps)

dtrans$j<-paste(dtrans$Site_ID, dtrans$Plant_gen_sp)

dtrans$flower_count<-flower_count2$tot.flowers[match(dtrans$j, flower_count2$j)]
#head(dtrans)


d.vis<-ddply(dtrans, c("Site_ID", "Plant_gen_sp"), summarise,
             tot.visits= sum(Frequency),
             tot.flower=sum(flower_count))

#replace NA, species with no flower count for a particular site with 10 (min number of flowers)
d.vis$tot.flower[is.na(d.vis$tot.flower)] <- 10

d.vis$rel.visits<-d.vis$tot.visits/d.vis$tot.flower #CALCULATE NUMBER OF VISITS AND DIVIDE BY AVERAGE NUMBER OF FLOWERS PER PLANT SPECIES TO GET A RELATIVE VALUE OF VISITS

d.vis$j<-paste(d.vis$Site_ID, d.vis$Plant_gen_sp)

#calculate average niche overlap per plant species 

sites <- unique(dtrans$Site_ID)

out.niche <- data.frame(Site_id = NA, row = NA, col = NA,value  = NA)

webs <- list()
for(i in 1:length(sites)){
  temp <- subset(dtrans, Site_ID == sites[i])
  temp2<-droplevels(temp)
  
   web<-table(temp2$Pollinator_gen_sp, temp2$Plant_gen_sp)

  ni<-niche.overlap(web, method="morisita") #THIS SHOULD BE EXPLAINED IN METHODS
  df <- melt(as.matrix(ni), varnames = c("row", "col"))
  df$row<-as.character(df$row)
  df$col<-as.character(df$col)
  
  n <- nrow(out.niche)
 
  out.niche[n + seq(nrow(df)),1] <- as.character(sites[i])
  out.niche[n + seq(nrow(df)),2:3] <- (df[,1:2])
  out.niche[n + seq(nrow(df)),4] <-df[,3]
  
}

#head(out.niche)
out.niche2<-na.omit(out.niche)
out.niche.agg <- ddply(out.niche2, c("Site_id", "col"), summarise,
               mean.niche.over    = mean(value))


out.niche.agg$j<-paste(out.niche.agg$Site_id, out.niche.agg$col)

#join with network metrics

f2$functional.comp.poll<-out.site$functional.comp.poll[match(f2$Site_ID, out.site$Site_id)]
f2$functional.comp.pl<-out.site$functional.comp.pl[match(f2$Site_ID, out.site$Site_id)]
f2$nodf.song<-out.site$nodf.song[match(f2$Site_ID, out.site$Site_id)]
f2$species.poll<-out.site$species.poll[match(f2$Site_ID, out.site$Site_id)]


#also match with plant species level network data
f2$match<-paste(f2$Site_ID, f2$Plant.sp)
outsp.pl.site$match<-paste(outsp.pl.site$Site_id, outsp.pl.site$species)

f2$norm_degree<-outsp.pl.site$norm_degree[match(f2$match, outsp.pl.site$match)]
f2$weigh_closeness<-outsp.pl.site$weigh_closeness[match(f2$match, outsp.pl.site$match)]

#and with niche overlap and RELATIVE number of visits
f2$niche.overlap<-out.niche.agg$mean.niche.over[match(f2$match, out.niche.agg$j)]

f2$rel.visits<-d.vis$rel.visits[match(f2$match, d.vis$j)]
f2$rel.visits[is.na(f2$rel.visits)]<-0


#also total visits for site level calculation of pollinator abundance

f2$tot.visits<-d.vis$tot.visits[match(f2$match, d.vis$j)]
f2$tot.visits[is.na(f2$tot.visits)]<-0  #we use the total number of species to then calculate total number of visits at site level as a proxy for pollinator abundance


#calculate number of pollinator species per plant species 

sites <- unique(dtrans$Site_ID)

out <- data.frame(Site_id = NA, plant.sps = NA, poll.sps = NA)


for(i in 1:length(sites)){
  temp <- subset(dtrans, Site_ID == sites[i])
  tempb<-droplevels(temp)
  plants<-unique(tempb$Plant_gen_sp)
  for(j in 1:length(plants)){
    temp2 <- tempb[tempb$Plant_gen_sp == plants[j],]
  temp3<-droplevels(temp2)

  poll<-nlevels(unique(temp3$Pollinator_gen_sp))
  
  n <- nrow(out)
  
  out[n + 1,1] <- as.character(sites[i])
  out[n + 1,2] <- as.character(plants[j])
  out[n + 1,3] <- poll
  
}
}
out


out2<-out[-1,]
out2$match<-paste(out2$Site_id, out2$plant.sps)

f2$pollspsperplant<-out2$poll.sps[match(f2$match, out2$match)]


#scale all variables used

f2$weigh_closeness.sc<-scale(f2$weigh_closeness, center = T, scale = T)
f2$niche.overlap.sc<-scale(f2$niche.overlap, center = T, scale = T)
f2$pollspsperplant.sc<-scale(f2$pollspsperplant, center = T, scale = T)
f2$rel.visits.sc<-scale(f2$rel.visits, center = T, scale = T)
f2$tot.visits.sc<-scale(f2$tot.visits, center = T, scale = T)

```

_Species-level analyses_



```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, results='hide'}

#compare 3 models: one null model, one with simple diversity metrics (pollinator richness and number of visits), compared to one where position in a network (centrality) and niche overlap are included with these variables.

m0<-glmer(tot.fruitset ~ 1 + (1|Plant.sp:Site_ID) + (1|Site_ID), family="binomial", data=f2, REML=FALSE)
summary(m0)

m1<-glmer(tot.fruitset ~  pollspsperplant.sc + rel.visits.sc  + (1|Plant.sp:Site_ID) + (1|Site_ID), family="binomial", data=f2, REML=FALSE)
summary(m1)
vif(m1)  #check for correlations between variables included in model



m2<-glmer(tot.fruitset ~  pollspsperplant.sc  + rel.visits.sc + weigh_closeness.sc + niche.overlap.sc  + (1|Plant.sp:Site_ID) + (1|Site_ID), family="binomial", data=f2, REML=FALSE)
 
summary(m2) 
vif(m2)

#select best model based on AIC 

AICtab(m0,m1, m2) 


#best model fit with REML=TRUE

m2<-glmer(tot.fruitset ~  pollspsperplant.sc  + rel.visits.sc + weigh_closeness.sc + niche.overlap.sc + (1|Plant.sp:Site_ID) + (1|Site_ID), family="binomial", data=f2, REML=TRUE)
 
summary(m2) 

r2<-rsquared(c(m2, m1)) #check R^2 values for both models 

# extract estimates and st errors to present in table
coefs.m2 <- data.frame(coef(summary(m2)))
#coefs.m2
Table1A<-round(coefs.m2[,1:3],digits=2)
rownames(Table1A)<-c("(Intercept)", "Pollinator richness", "Relative number of visits", "Centrality", "Plant niche overlap")
#at the end of the paper


#devtools::install_github("hohenstein/remef")  USE THIS PACKAGE TO DO PARTIAL RESIDUAL PLOTS OF SIGNIFICANT VARIABLES


y_partial_weigh <- remef(m2, fix= c( "rel.visits.sc", "pollspsperplant.sc", "niche.overlap.sc"), ran = "all", inverse = F)
#With this we remove the influece of x2 and the random effects from the dependent variable
y_partial_weigh_inv<-exp(y_partial_weigh)/(1+exp(y_partial_weigh))

Figure1a<-ggplot(m2@frame,  aes(x=m2@frame$weigh_closeness.sc, y=y_partial_weigh_inv, color= Plant.sp)) +    
  geom_point(size=2.5, shape=21,color = "black", aes(fill=factor(Plant.sp))) + 
  stat_smooth(method=glm,  method.args = list(family = "binomial"), size=1, se=TRUE, color = "black", alpha=0.4) + 
  xlab("Centrality") +      
  ylab("Fruit set") + theme_bw()  + theme (legend.position= "bottom") +
  theme(text = element_text(size = 18), axis.text=element_text(size=rel(1)), axis.title=element_text(size=rel(1.3), face="bold")) + 
  scale_fill_discrete(name="Plant species") +  theme(legend.text = element_text(size = 14, face = "italic"), legend.title = element_text(size=15, face = "bold"), legend.direction = "vertical") + guides(fill=guide_legend(ncol=4))

#Figure1a

y_partial_weigh2 <- remef(m2, fix= c( "weigh_closeness.sc", "pollspsperplant.sc", "niche.overlap.sc"), ran = "all", inverse = F)
#With this we remove the influece of x2 and the random effects from the dependent variable
y_partial_weigh_inv2<-exp(y_partial_weigh2)/(1+exp(y_partial_weigh2))

FigureS5<-ggplot(m2@frame,  aes(x=m2@frame$rel.visits.sc, y=y_partial_weigh_inv, color= Plant.sp)) +
  geom_point(size=2.5, shape=21,color = "black", aes(fill=factor(Plant.sp))) +
  stat_smooth(method=glm,  method.args = list(family = "binomial"), size=1, se=TRUE, color = "black", alpha=0.4) +
  xlab("Relative number of visits") +
  ylab("Fruit set") + theme_bw()  + theme (legend.position= "bottom") +
  theme(text = element_text(size = 18), axis.text=element_text(size=rel(1)), axis.title=element_text(size=rel(1.3), face="bold")) +
  scale_fill_discrete(name="Plant species") +  theme(legend.text = element_text(size = 14, face = "italic"), legend.title = element_text(size=15, face = "bold"), legend.direction = "vertical") + guides(fill=guide_legend(ncol=4))
# 


#This relationship is largely driven by one single point species 

#redo analysis removing one plant species with large number of visits

f2.sub<-subset(f2, f2$rel.visits.sc<4)

m2b<-glmer(tot.fruitset ~  pollspsperplant.sc  + rel.visits.sc + weigh_closeness.sc + niche.overlap.sc  + (1|Plant.sp:Site_ID) + (1|Site_ID), family="binomial", data=f2.sub, REML=TRUE)
 
summary(m2b) #This relationship is largely driven by one single point species so we show results remving one species

# extract estimates and st errors to present in table
coefs.m2b <- data.frame(coef(summary(m2b)))
#coefs.m2
TableS5<-round(coefs.m2b[,1:3],digits=2)
rownames(TableS5)<-c("(Intercept)", "Pollinator richness", "Relative number of visits", "Centrality", "Plant niche overlap")
#at the end of the paper


```

At the species level, in the case of fruit set, our results showed that model 2 had the best fit to our data (lowest AIC value), and fixed  effects explained `r round(r2$Marginal[1], 2)*100`% of the variability observed (conditional R^2=`r round(r2$Conditional[1], 2)*100`%). In this case, we found a positive relationship between fruit set, visitation rate, and a network structure metric, the centrality of a focal plant within the overall network (Table 1, Fig. 1A, Fig. S4). However, in the case of the relative number of visits a single point seemed to be driving the relationship and removing this single point lead to a decrease in the importance of this variable (Fig. S5, Table S5). 

```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, results='hide'}

##seed set

s3$functional.comp.poll<-out.site$functional.comp.poll[match(s3$Site_ID, out.site$Site_id)]
s3$functional.comp.pl<-out.site$functional.comp.pl[match(s3$Site_ID, out.site$Site_id)]
s3$nodf.song<-out.site$nodf.song[match(s3$Site_ID, out.site$Site_id)]
s3$species.poll<-out.site$species.poll[match(s3$Site_ID, out.site$Site_id)]

#also match with plant species level network data
s3$match<-paste(s3$Site_ID, s3$Plant.sp)
outsp.pl.site$match<-paste(outsp.pl.site$Site_id, outsp.pl.site$species)

s3$norm_degree<-outsp.pl.site$norm_degree[match(s3$match, outsp.pl.site$match)]
s3$weigh_closeness<-outsp.pl.site$weigh_closeness[match(s3$match, outsp.pl.site$match)]
s3$niche.overlap<-out.niche.agg$mean.niche.over[match(s3$match, out.niche.agg$j)]


s3$rel.visits<-d.vis$rel.visits[match(s3$match, d.vis$j)]
s3$rel.visits[is.na(s3$rel.visits)]<-0

s3$tot.visits<-d.vis$tot.visits[match(s3$match, d.vis$j)]
s3$tot.visits[is.na(s3$tot.visits)]<-0

s3$pollspsperplant<-out2$poll.sps[match(s3$match, out2$match)]


#scale all variables used

s3$norm_degree.sc<-scale(s3$norm_degree, center = T, scale = T)
s3$weigh_closeness.sc<-scale(s3$weigh_closeness, center = T, scale = T)
s3$niche.overlap.sc<-scale(s3$niche.overlap, center = T, scale = T)
s3$pollspsperplant.sc<-scale(s3$pollspsperplant, center = T, scale = T)
s3$rel.visits.sc<-scale(s3$rel.visits, center = T, scale = T)
s3$tot.visits.sc<-scale(s3$tot.visits, center = T, scale = T)

s3$mean.seedn.sc<-scale(s3$mean.seedn, center = T, scale = T)

#correlation between reproduction variables

 # cor(s3[,4:6], use = "everything",
 #     method = "pearson")

```




```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, results='hide'}
#fit three models


s3$seedcomb<-s3$mean.seedn*s3$mean.seedw
s3$seedcomb.sc<-scale(s3$seedcomb, center = T, scale = T)


m0.seed<-glmer(mean.seedn.sc ~  1  + (1|Plant.sp:Site_ID) + (1|Site_ID), family="gaussian", data=s3, REML=FALSE)
summary(m0.seed)


m1.seed<-glmer(mean.seedn.sc ~  pollspsperplant.sc + rel.visits.sc  + (1|Plant.sp:Site_ID) + (1|Site_ID), family="gaussian", data=s3, REML=FALSE)

summary(m1.seed)
vif(m1.seed)


m2.seed<-glmer(mean.seedn.sc ~  pollspsperplant.sc  + rel.visits.sc + weigh_closeness.sc + niche.overlap.sc  + (1|Plant.sp:Site_ID) + (1|Site_ID), family="gaussian", data=s3, REML=FALSE)
summary(m2.seed)
vif(m2.seed)
 

AICtab(m0.seed, m1.seed, m2.seed) #m2 is best

m2.seed<-glmer(mean.seedn.sc ~  pollspsperplant.sc  + rel.visits.sc + weigh_closeness.sc + niche.overlap.sc  + (1|Plant.sp:Site_ID) + (1|Site_ID), family="gaussian", data=s3, REML=TRUE)
summary(m2.seed)

r2b<-rsquared(c(m2.seed, m1.seed)) #check R^2 values for both models 

#test for problems in residuals
# res<-simulateResiduals(m2.seed)
# plot(res, rank = TRUE)


# extract estimates and st errors to present in table
coefs.m2.seed <- data.frame(coef(summary(m2.seed)))
#coefs.m2.seed
Table1B<-round(coefs.m2.seed,digits=2)
rownames(Table1B)<-c("(Intercept)", "Pollinator richness", "Relative number of visits", "Centrality", "Plant niche overlap")


#plot significant variables
y_partial_norm_seed <- remef(m2.seed, fix= c("pollspsperplant.sc", "rel.visits.sc", "weigh_closeness.sc"), ran = "all")
#With this we remove the influece of x2 and the random effects from the dependent variable


Figure1b<-ggplot(m2.seed@frame,  aes(x=m2.seed@frame$niche.overlap.sc, y=y_partial_norm_seed, color= Plant.sp)) +    
  geom_point(size=2.5, shape=21, colour="black", aes(fill=factor(Plant.sp))) + stat_smooth(method=lm,  size=1, se=TRUE, color = "black", alpha=0.4) + 
  #geom_smooth(method=lm, linetype= "dashed", size=0.7, se=FALSE, alpha=0.8) +
  xlab("Niche overlap") +      
  ylab("Number of \n seeds per fruit") + theme_bw()  + theme (legend.position= "right") +
  theme(text = element_text(size = 18), axis.text=element_text(size=rel(1)), axis.title=element_text(size=rel(1.3), face="bold")) + 
  scale_fill_discrete(name="Plant species") +  theme(legend.text = element_text(size = 6, face = "italic"), legend.title = element_text(size=11, face = "bold"))

#Figure1b


#how to have two plots with same legend


prow <- cowplot::plot_grid( Figure1a + theme(legend.position="none"),
                   Figure1b + theme(legend.position="none"),
                   align = 'vh',
                   labels = c("A", "B"),
                   hjust = -1,
                   nrow = 1
)

# extract the legend from one of the plots
legend_b <- get_legend(Figure1a + theme(legend.position="right"))

# add the legend underneath the row we made earlier. Give it 10% of the height
# of one plot (via rel_heights).
Figure1 <- cowplot::plot_grid( prow, legend_b, ncol = 1, rel_heights = c(2, 1))#al final del paper

FigureS4<-plot_summs(m2, m2.seed, level=0.95, scale = TRUE, model.names = c("Fruit set", "Number of seeds"), legend.title = "Response variables", cex.axis=2)

```

 For the average number of seeds per fruit, our results showed again that model 2 had the best fit, with fixed effects explaining `r round(r2b$Marginal[1], 2)*100`% of the variability observed in our data (conditional R^2 =`r round(r2b$Conditional[1], 2)*100`% ). In this case, we found a positive relationship between plant niche overlap and the number of seeds produced (Table 1B, Fig. 1B, Fig. S4).
 

```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, results='hide'}


#SEED WEIGHT

m0.seed.w<-glmer(mean.seedw ~  1  + (1|Plant.sp:Site_ID) + (1|Site_ID), family="gaussian", data=s3)

summary(m0.seed.w)

m1.seed.w<-glmer(mean.seedw ~  pollspsperplant.sc + rel.visits.sc  + (1|Plant.sp:Site_ID) + (1|Site_ID), family="gaussian", data=s3)

summary(m1.seed.w)
 
 
m2.seed.w<-glmer(mean.seedw ~  pollspsperplant.sc + rel.visits.sc + weigh_closeness.sc + niche.overlap.sc  + (1|Plant.sp:Site_ID)+ (1|Site_ID), family="gaussian", data=s3)
 
summary(m2.seed.w)
 

#select best model based on AIC 

AICtab(m0.seed.w, m1.seed.w, m2.seed.w) 

#best model is null model


#FRUIT WEIGHT
m0.fruit.w<-glmer(mean.fruitweight ~  1  + (1|Plant.sp:Site_ID)+ (1|Site_ID), family="gaussian", data=s3, REML=FALSE)

summary(m0.fruit.w)

m1.fruit.w<-glmer(mean.fruitweight ~  pollspsperplant.sc + rel.visits.sc  + (1|Plant.sp:Site_ID)+ (1|Site_ID), family="gaussian", data=s3, REML=FALSE)

summary(m1.fruit.w)


m2.fruit.w<-glmer(mean.fruitweight ~  pollspsperplant.sc  + rel.visits.sc + weigh_closeness.sc + niche.overlap.sc  + (1|Plant.sp:Site_ID) + (1|Site_ID), family="gaussian", data=s3, REML=FALSE)
 
summary(m2.fruit.w)
 

#select best model based on AIC 

AICtab(m0.fruit.w, m1.fruit.w, m2.fruit.w) 

#best model is null model



```
 For all other measures of reproductive success considered (i.e., fruit and seed weight), none of the models fitted showed a better fit than the null model. 

_Site-level analyses_


```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, results='hide'}

######################## NTW STRUCTURE

#aggregate values at site level

f.ag <- ddply(f2, c("Site_ID", "Plant.sp", "nodf.song", "functional.comp.poll",
                    "functional.comp.pl", "species.poll"), 
               summarise, tot.visits    = sum(tot.visits),
                         mean.fruitset = mean(tot.fruitset))

f.agg <- ddply(f.ag, c("Site_ID",  "nodf.song", "functional.comp.poll", 
                       "functional.comp.pl","species.poll"), 
               summarise, tot.visits    = sum(tot.visits),
                         mean.fruitset = mean(mean.fruitset))


#scale all variables to be able to compare effect sizes 

f.agg$nodf.song.sc <- scale(f.agg$nodf.song, center = T, scale = T)
f.agg$functional.comp.poll.sc <- scale(f.agg$functional.comp.poll, center = T, scale = T)
f.agg$functional.comp.pl.sc <- scale(f.agg$functional.comp.pl, center = T, scale = T)
f.agg$species.poll.sc <- scale(f.agg$species.poll, center = T, scale = T)
f.agg$tot.visits.sc <- scale(f.agg$tot.visits, center = T, scale = T)


```



```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, results='hide'}

#FRUITset

m0.fruit.net<-glmmTMB(mean.fruitset ~  1, family="beta_family", data=f.agg)

summary(m0.fruit.net)

m1.fruit.net<-glmmTMB(mean.fruitset ~  species.poll.sc + tot.visits.sc, family="beta_family", data=f.agg)

summary(m1.fruit.net)

m2.fruit.net<-glmmTMB(mean.fruitset ~  species.poll.sc + tot.visits.sc + functional.comp.poll.sc + nodf.song.sc  , family="beta_family", data=f.agg)

summary(m2.fruit.net)


#select best model based on AIC 

AICtab(m0.fruit.net, m1.fruit.net, m2.fruit.net) #Almost as good. With this, you cannot say one is better than the other one. The take home message would be: if interested in predictions, go for simplicity. If interested in mechanisms, niche part is a mechanism to take into account. And actually m2 has better predictive ability (better R2 see below)

#provide R^2 values for both models

#crude alternative suggested by Ben Bolker to calculate R2 for glmmTMb models https://github.com/glmmTMB/glmmTMB/issues/169

r2.m2<-cor(f.agg$mean.fruitset,predict(m2.fruit.net,type="response"))^2
r2.m1<-cor(f.agg$mean.fruitset,predict(m1.fruit.net,type="response"))^2

m2.fruit.net<-glmmTMB(mean.fruitset ~   tot.visits.sc + nodf.song.sc + functional.comp.poll.sc + species.poll.sc , family="beta_family", data=f.agg)

summary(m2.fruit.net)


#table with results for paper
Table2A<-round(summary(m2.fruit.net)$coefficients$cond[,1:3], digits=2)
rownames(Table2A)<-c("(Intercept)", "Pollinator richness", "Relative number of visits", "Nestedness", "Pollinator niche complementarity")
#at the end of paper


#MANUALLY CREATing PARTIAL RESIDUAL PLOTS

pred<-summary(m2.fruit.net)$coefficients$cond[1]+ (summary(m2.fruit.net)$coefficients$cond[2] * mean(f.agg$species.poll.sc)) + (summary(m2.fruit.net)$coefficients$cond[3] * mean(f.agg$tot.visits.sc)) + (summary(m2.fruit.net)$coefficients$cond[4]* mean(f.agg$nodf.song.sc)) + (summary(m2.fruit.net)$coefficients$cond[5] * f.agg$functional.comp.poll.sc)

res<-pred-f.agg$mean.fruitset
res.tr<-exp(res)/(1+exp(res)) #transform using logit back transformation


pl2 <- ggplot(f.agg,  aes(x=functional.comp.poll.sc, y= res.tr)) +    
        geom_point(size=2.5, shape=21, color="black", fill="darkgrey") + 
  stat_smooth(method = 'lm', size=1, se=TRUE, color = "black", alpha=0.4) +     
        ylim(0.3,0.9) +
        xlab("Pollinator \n niche complementarity") +      
        ylab("Fruit set") + theme_bw()  + #theme (legend.position= "none") +
        theme(text = element_text(size = 18), axis.text=element_text(size=rel(1)), axis.title=element_text(size=rel(1), face="bold")) 




pred2<-summary(m2.fruit.net)$coefficients$cond[1]+ (summary(m2.fruit.net)$coefficients$cond[2] * f.agg$species.poll.sc) + (summary(m2.fruit.net)$coefficients$cond[3] * mean(f.agg$tot.visits.sc)) + (summary(m2.fruit.net)$coefficients$cond[4]* mean(f.agg$nodf.song.sc)) + (summary(m2.fruit.net)$coefficients$cond[5] * mean(f.agg$functional.comp.poll.sc))

res2<-pred2-f.agg$mean.fruitset
res.tr2<-exp(res2)/(1+exp(res2))
  


pl3 <- ggplot(f.agg,  aes(x=species.poll.sc, y= res.tr2)) +    
        geom_point(size=2.5, shape=21, color="black", fill="darkgrey") + 
  stat_smooth(method = 'lm', size=1, se=TRUE, color = "black", alpha=0.4) +  
        ylim(0.3,0.9) +
        xlab("Pollinator richness") +      
        ylab("Fruit set") + theme_bw()  + #theme (legend.position= "none") +
        theme(text = element_text(size = 18), axis.text=element_text(size=rel(1)), axis.title=element_text(size=rel(1), face="bold")) 

FigureS6A<-plot_model(m2.fruit.net, title="Fruit set")
```


```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, results='hide'}

#seed number


s.com <- ddply(s3, c("Site_ID", "Plant.sp", "nodf.song", "functional.comp.poll",
                     "functional.comp.pl", "species.poll"), 
               summarise, tot.visits    = sum(tot.visits),
                         mean.seedset = mean(mean.seedn),
                          mean.seedweight = mean(mean.seedw),
                          mean.fruitweight = mean(mean.fruitweight))


s.comm <- ddply(s.com, c("Site_ID", "nodf.song", "functional.comp.poll", 
                         "functional.comp.pl","species.poll"), 
               summarise, tot.visits    = sum(tot.visits),
                         mean.seedset = mean(mean.seedset),
                          mean.seedweight = mean(mean.seedweight),
                          mean.fruitweight = mean(mean.fruitweight))



#scale variables for comparison of effect sizes

s.comm$nodf.song.sc <- scale(s.comm$nodf.song, center = T, scale = T)
s.comm$functional.comp.poll.sc <- scale(s.comm$functional.comp.poll, center = T, scale = T)
s.comm$functional.comp.pl.sc <- scale(s.comm$functional.comp.pl, center = T, scale = T)
s.comm$species.poll.sc <- scale(s.comm$species.poll, center = T, scale = T)
s.comm$tot.visits.sc <- scale(s.comm$tot.visits, center = T, scale = T)

```


```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, results='hide'}

#NUMBER OF SEEDS PER FRUIT
m0.seed.net <- lm(mean.seedset ~  1,
    data=s.comm,family="gaussian")
 
 summary(m0.seed.net)

m1.seed.net <- lm(mean.seedset ~  species.poll.sc + tot.visits.sc,
    data=s.comm,family="gaussian")
 
 summary(m1.seed.net)
 
m2.seed.net <- lm(mean.seedset ~  species.poll.sc + tot.visits.sc + nodf.song.sc + functional.comp.poll.sc, data=s.comm,family="gaussian")
 
 summary(m2.seed.net)
 
#select best model based on AIC 
AICtab(m0.seed.net, m1.seed.net, m2.seed.net)#both models are equally good

#test for problems in residuals
res<-simulateResiduals(m2.seed.net)
# plot(res, rank = TRUE)

#provide R^2 values for both models

#crude alternative suggested by Ben Bolker to calculate R2 for glmmTMb models https://github.com/glmmTMB/glmmTMB/issues/169

r2.m2.seed<-cor(s.comm$mean.seedset,predict(m2.seed.net,type="response"))^2
r2.m1.seed<-cor(s.comm$mean.seedset,predict(m1.seed.net,type="response"))^2


#save table with results for paper
Table2B<-round(summary(m2.seed.net)$coefficients[,1:3], digits=2)
rownames(Table2B)<-c("(Intercept)", "Pollinator richness", "Relative number of visits", "Nestedness", "Pollinator niche complementarity") #end of paper




pl6<-ggplot(s.comm,  aes(x=functional.comp.poll.sc, y=mean.seedset))+      
        geom_point(size=2.5, shape=21, color="black", fill="darkgrey") + stat_smooth(method=lm,  size=1, se=TRUE, color = "black", alpha=0.4) + 
        #geom_smooth(method=lm, linetype= "dashed", size=0.7, se=FALSE, alpha=0.8) +
        xlab("Pollinator \n niche complementarity") +      
        ylab("Number of \n seeds per fruit") + theme_bw()  + #theme (legend.position= "none") +
        theme(text = element_text(size = 18), axis.text=element_text(size=rel(1)), axis.title=element_text(size=rel(1), face="bold"))

#pl6


Figure2<-cowplot::plot_grid(pl3, pl2, pl6, labels = c("A", "B", "C"), nrow=1)  

FigureS6B<-plot_model(m2.seed.net, title="Number of seeds")
```


At the site level, in the case of fruit set and the number of seeds per fruit, we found that both model 1 and 2 were equally good in describing the differences observed when penalizing for model complexity (i.e.,$\Delta AIC<2$; [@Burnham2002a]). This suggests model 2 was a good model despite its added complexity, and actually shows a substantially better predictive ability than model 1 (R^2 = `r round(r2.m2, 2)` for model 2 versus `r round(r2.m1, 2)` for model 1 in the case of fruit set and R^2 = `r round(r2.m2.seed,2)` for model 2 versus `r round(r2.m1.seed, 2)` for model 1 in the case of the number of seeds per fruit) and therefore we will comment results for this model only. In particular, we found that both fruit set and the number of seeds per fruit were positively related to niche complementarity between pollinators (Tables 2, Fig. 2, Fig. S6). Additionally, we found a negative association between site-level pollinator richness and average fruit set (Table 2A, Fig. 2, Fig. S6). 



```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, results='hide'}

#FRUIT WEIGHT
m0.fruitw.net<-lm(mean.fruitweight ~  1, family="gaussian", data=s.comm)

summary(m0.fruitw.net)

m1.fruitw.net<-lm(mean.fruitweight ~  species.poll.sc + tot.visits.sc, family="gaussian", data=s.comm)

summary(m1.fruitw.net)
 
 vif(m1.fruitw.net)
 
m2.fruitw.net<-lm(mean.fruitweight ~  species.poll.sc + tot.visits.sc + nodf.song.sc + functional.comp.poll.sc, family="gaussian", data=s.comm)
 
 summary(m2.fruitw.net)
 
 vif(m2.fruitw.net)
 
#select best model based on AIC 

AICtab(m0.fruitw.net, m1.fruitw.net, m2.fruitw.net)

#test for problems in residuals
# res<-simulateResiduals(m1.fruitw.net)
# plot(res, rank = TRUE)

r2.fruitw1<-r.squaredGLMM(m1.fruitw.net)


#save table with results for paper
tableS6A<-round(summary(m1.fruitw.net)$coef[,1:3], digits=2)#ch
rownames(tableS6A)<-c("(Intercept)", "Pollinator species diversity", "Relative number of visits")#end of paper



predtest<-summary(m1.fruitw.net)$coefficients[1]+ (summary(m1.fruitw.net)$coefficients[2] * s.comm$species.poll.sc) + (summary(m1.fruitw.net)$coefficients[3] * mean(s.comm$tot.visits.sc)) 

restest<-predtest-s.comm$mean.fruitweight



pltest <- ggplot(s.comm,  aes(x=species.poll.sc, y= restest)) +    
  geom_point(size=2.5, shape=21, color="black", fill="darkgrey") + 
  stat_smooth(method = 'lm', size=1, se=TRUE, color = "black", alpha=0.4) +
  #ylim(0.3,0.9) +
  xlab("Pollinator richness") +      
  ylab("Fruit weight (g)") + theme_bw()  + #theme (legend.position= "none") +
  theme(text = element_text(size = 18), axis.text=element_text(size=rel(1)), axis.title=element_text(size=rel(1), face="bold")) 
 


#There is one point that has a larger pollinator diversity than the rest. To test if this point by itself might be driving the whole relationship we are repeating analyses removing this one point.


s.comm2<-subset(s.comm ,s.comm$species.poll.sc<1.9)

m0.fruitw.net2<-lm(mean.fruitweight ~  1, family="gaussian", data=s.comm2)

summary(m0.fruitw.net2)
m1.fruitw.net2<-lm(mean.fruitweight ~  species.poll.sc + tot.visits.sc, family="gaussian", data=s.comm2)

summary(m1.fruitw.net2)

vif(m1.fruitw.net2)

m2.fruitw.net2<-lm(mean.fruitweight ~  species.poll.sc + tot.visits.sc + nodf.song.sc + functional.comp.poll.sc, family="gaussian", data=s.comm2)

summary(m2.fruitw.net2)

vif(m2.fruitw.net2)

#select best model based on AIC 

AICtab(m0.fruitw.net2, m1.fruitw.net2, m2.fruitw.net2)


#save table with results for paper
tableS6B<-round(summary(m1.fruitw.net2)$coef[,1:3], digits=2)#ch
rownames(tableS6B)<-c("(Intercept)", "Pollinator species diversity", "Relative number of visits")#end of paper



predtestb<-summary(m1.fruitw.net2)$coefficients[1]+ (summary(m1.fruitw.net2)$coefficients[2] * s.comm2$species.poll.sc) + (summary(m1.fruitw.net2)$coefficients[3] * mean(s.comm2$tot.visits.sc)) 

restestb<-predtestb-s.comm2$mean.fruitweight



pltestb <- ggplot(s.comm2,  aes(x=species.poll.sc, y= restestb)) +    
  geom_point(size=2.5, shape=21, color="black", fill="darkgrey") + 
  stat_smooth(method = 'lm', size=1, se=TRUE, color = "black", alpha=0.4) +
  #ylim(0.3,0.9) +
  xlab("Pollinator richness") +      
  ylab("Fruit weight (g)") + theme_bw()  + #theme (legend.position= "none") +
  theme(text = element_text(size = 18), axis.text=element_text(size=rel(1)), axis.title=element_text(size=rel(1), face="bold")) 

```


```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, results='hide'}

#SEED WEIGHT

m0.seedw.net<-glm(mean.seedweight ~  1, family="gaussian", data=s.comm)

summary(m0.seedw.net)
 
m1.seedw.net<-glm(mean.seedweight ~  species.poll.sc + tot.visits.sc, family="gaussian", data=s.comm)

summary(m1.seedw.net)
 
 
vif(m1.seedw.net)
 
m2.seedw.net<-glm(mean.seedweight ~  species.poll.sc + tot.visits.sc + nodf.song.sc + functional.comp.poll.sc, family="gaussian", data=s.comm)
 
summary(m2.seedw.net)
 
vif(m2.seedw.net)
 
#select best model based on AIC 

AICtab(m0.seedw.net,m1.seedw.net, m2.seedw.net) #m1 is better

#test for problems in residuals
# res<-simulateResiduals(m1.seedw.net)
# plot(res, rank = TRUE)

r2.seedw1<-r.squaredGLMM(m1.seedw.net)
r2.seedw2<-r.squaredGLMM(m2.seedw.net)


#confint(m1.seedw.net)

#save table with results for paper
tableS7A<-round(summary(m1.seedw.net)$coef[,1:3], digits=2)#ch
rownames(tableS7A) <-c("(Intercept)", "Pollinator species diversity", "Relative number of visits")#end of paper


predtest2<-summary(m1.seedw.net)$coefficients[1]+ (summary(m1.seedw.net)$coefficients[2] * s.comm$species.poll.sc) + (summary(m1.seedw.net)$coefficients[3] * mean(s.comm$tot.visits.sc)) 

restest2<-predtest2-s.comm$mean.seedweight



pltest2 <- ggplot(s.comm,  aes(x=species.poll.sc, y= restest2)) +    
  geom_point(size=2.5, shape=21, color="black", fill="darkgrey") + 
  stat_smooth(method = 'glm', size=1, se=TRUE, color = "black", alpha=0.4) +
  #ylim(0.3,0.9) +
  xlab("Pollinator richness") +      
  ylab("Seed weight (g)") + theme_bw()  + #theme (legend.position= "none") +
  theme(text = element_text(size = 18), axis.text=element_text(size=rel(1)), axis.title=element_text(size=rel(1), face="bold")) 



FigureS7<-cowplot::plot_grid(pltest, pltest2, labels = c("A", "B"), nrow=1)  



#Repeat analyses but removing one site that has a particularly large pollinator richness value to test whether this point might be driving the relationship by itself.

m0.seedw.net2<-glm(mean.seedweight ~  1, family="gaussian", data=s.comm2)

summary(m0.seedw.net2)
m1.seedw.net2<-glm(mean.seedweight ~  species.poll.sc + tot.visits.sc, family="gaussian", data=s.comm2)

summary(m1.seedw.net2)


vif(m1.seedw.net2)

m2.seedw.net2<-glm(mean.seedweight ~  species.poll.sc + tot.visits.sc + nodf.song.sc + functional.comp.poll.sc, family="gaussian", data=s.comm2)

summary(m2.seedw.net2)

vif(m2.seedw.net2)

#select best model based on AIC 

AICtab(m0.seedw.net2, m1.seedw.net2, m2.seedw.net2) #m1 is better


#save table with results for paper
tableS7B<-round(summary(m1.seedw.net2)$coef[,1:3], digits=2)#ch
rownames(tableS7B) <-c("(Intercept)", "Pollinator species diversity", "Relative number of visits")#end of paper


predtest2b<-summary(m1.seedw.net2)$coefficients[1]+ (summary(m1.seedw.net2)$coefficients[2] * s.comm2$species.poll.sc) + (summary(m1.seedw.net2)$coefficients[3] * mean(s.comm2$tot.visits.sc)) 

restest2b<-predtest2b-s.comm2$mean.seedweight



pltest2.sub <- ggplot(s.comm2,  aes(x=species.poll.sc, y= restest2b)) +    
  geom_point(size=2.5, shape=21, color="black", fill="darkgrey") + 
  stat_smooth(method = 'glm', size=1, se=TRUE, color = "black", alpha=0.4) +
  #ylim(0.3,0.9) +
  xlab("Pollinator richness") +      
  ylab("Seed weight (g)") + theme_bw()  + #theme (legend.position= "none") +
  theme(text = element_text(size = 18), axis.text=element_text(size=rel(1)), axis.title=element_text(size=rel(1), face="bold")) 



FigureS8<-cowplot::plot_grid(pltestb, pltest2.sub, labels = c("A", "B"), nrow=1)  



FigureS6C<-plot_summs(m1.fruitw.net, m1.seedw.net, level=0.95, scale = TRUE, model.names = c("Fruit weight", "Seed weight"), legend.title = "Response variables")

#FigureS4<-plot_grid(FigureS4A, FigureS4B, FigureS4C, labels = c("A", "B", "C"), nrow=3)  
```

  In the case of weight variables (fruit and seed weight), in both cases we found that both the null model, model 0 and model 1 were equally good (i.e.,$\Delta AIC<2$; [@Burnham2002a]). In this case model 1, i.e., that only including simple visitation metrics, showed an R^2  of  0.23. For seed weight, we found model 1 to be the best model too (R^2 = 0.39 in this case). In both cases, we found a consistent positive link to site-level pollinator richness (Tables S6A-S7A, Figs. S6-S7). This association was maintained even after removing a site that has a particularly large pollinator richness value (Tables S6B-S7B, Fig. S8, Fig. S6).

_Equity in fruitset_

When evaluating the relationship between community composition and network structure on equity in reproductive success across the different species within a community, we found that using the 50^th percentile all models were equally good (i.e.,$\Delta AIC<2$; [@Burnham2002a]), but as seen in model 2, none of the variables considered showed any strong associations (Table S8). In the case of the other two thresholds considered (25^th and 75^th percentiles) model 0, the null model, was the best model. 

```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, results='hide'}

#EQUITY SPECIES WITHIN COMMUNITIES
#using raw values of mean fruitset for each species at each site
#dataset f.ag
#number of species per site tableS1

#calculate 25th, 50th and 75th percentiles
q<-quantile(f.ag$mean.fruitset, c(0.25, 0.50, 0.75))

#calculate number of sps per site producing more 50th percentile in fruitset

highprod<-subset(f.ag, f.ag$mean.fruitset>q[2])
highprod.sps<-ddply(highprod, "Site_ID", summarise, 
                   high.sps = length(Plant.sp)) 


#equity as proportion of high producing compared to total
highprod.sps$tot.sps<-tableS1$tot.sps[match(highprod.sps$Site_ID, tableS1$Site_ID)]
highprod.sps$equity<-highprod.sps$high.sps/highprod.sps$tot.sps


highprod.sps$nodf.song.sc<-f.agg$nodf.song.sc[match(highprod.sps$Site_ID, f.agg$Site_ID)]
highprod.sps$functional.comp.poll.sc<-f.agg$functional.comp.poll.sc[match(highprod.sps$Site_ID, f.agg$Site_ID)]
highprod.sps$species.poll.sc<-f.agg$species.poll.sc[match(highprod.sps$Site_ID, f.agg$Site_ID)]
highprod.sps$tot.visits.sc<-f.agg$tot.visits.sc[match(highprod.sps$Site_ID, f.agg$Site_ID)]
```


```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, results='hide'}

#fit three models
 m0.eq.comm<-glm(equity ~  1 , family="binomial", data=highprod.sps)
 

 summary(m0.eq.comm)

 m1.eq.comm<-glm(equity ~  species.poll.sc + tot.visits.sc , family="binomial", data=highprod.sps)
 

 summary(m1.eq.comm)

 m2.eq.comm<-glm(equity ~  species.poll.sc + tot.visits.sc + nodf.song.sc + functional.comp.poll.sc, family="binomial", data=highprod.sps)
summary(m2.eq.comm) 
 

#select best model based on AIC 

AICtab(m0.eq.comm, m1.eq.comm, m2.eq.comm) #m1 is best no variables significant


r2.eq<-r.squaredGLMM(m1.eq.comm)


#save table with results for paper
tableS8<-round(summary(m2.eq.comm)$coef[,1:3], digits=2)#ch
rownames(tableS8)<-c("(Intercept)", "Pollinator richness", "Relative number of visits", "Nestedness", "Pollinator niche complementarity")


#test for problems in residuals
# res<-simulateResiduals(m1.eq.comm)
# plot(res, rank = TRUE)



```

```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, results='hide'}

#EQUITY SPECIES WITHIN COMMUNITIES 75% threshold
#using raw values of mean fruitset for each species at each site
#dataset f.ag
#number of species per site tableS1


#calculate number of sps per site producing more than 75th percentile in fruitset

highprod75<-subset(f.ag, f.ag$mean.fruitset>q[3])
highprod75.sps<-ddply(highprod75, "Site_ID", summarise, 
                   high.sps = length(Plant.sp)) 


#equity as proportion of high producing compared to total
highprod75.sps$tot.sps<-tableS1$tot.sps[match(highprod75.sps$Site_ID, tableS1$Site_ID)]
highprod75.sps$equity<-highprod75.sps$high.sps/highprod75.sps$tot.sps


highprod75.sps$nodf.song.sc<-f.agg$nodf.song.sc[match(highprod75.sps$Site_ID, f.agg$Site_ID)]
highprod75.sps$functional.comp.poll.sc<-f.agg$functional.comp.poll.sc[match(highprod75.sps$Site_ID, f.agg$Site_ID)]
highprod75.sps$species.poll.sc<-f.agg$species.poll.sc[match(highprod75.sps$Site_ID, f.agg$Site_ID)]
highprod75.sps$tot.visits.sc<-f.agg$tot.visits.sc[match(highprod75.sps$Site_ID, f.agg$Site_ID)]
```


```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, results='hide'}

#fit three models


 m0.eq.comm75<-glm(equity ~  1 , family="binomial", data=highprod75.sps)
 

 summary(m0.eq.comm75)
 
 m1.eq.comm75<-glm(equity ~  species.poll.sc + tot.visits.sc , family="binomial", data=highprod75.sps)
 

 summary(m1.eq.comm75)

 m2.eq.comm75<-glm(equity ~  species.poll.sc + tot.visits.sc + nodf.song.sc + functional.comp.poll.sc , family="binomial", data=highprod75.sps)
summary(m2.eq.comm75) 
 

#select best model based on AIC 

AICtab(m0.eq.comm75,m1.eq.comm75, m2.eq.comm75) #m1 is best no variables significant


#test for problems in residuals
# res<-simulateResiduals(m1.eq.comm)
# plot(res, rank = TRUE)


```


```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, results='hide'}

#EQUITY SPECIES WITHIN COMMUNITIES 25% threshold
#using raw values of mean fruitset for each species at each site
#dataset f.ag
#number of species per site tableS1


#calculate number of sps per site producing more than 25th percentile in fruitset

highprod25<-subset(f.ag, f.ag$mean.fruitset>q[1])
highprod25.sps<-ddply(highprod25, "Site_ID", summarise, 
                   high.sps = length(Plant.sp)) 


#equity as proportion of high producing compared to total
highprod25.sps$tot.sps<-tableS1$tot.sps[match(highprod25.sps$Site_ID, tableS1$Site_ID)]
highprod25.sps$equity<-highprod25.sps$high.sps/highprod25.sps$tot.sps


highprod25.sps$nodf.song.sc<-f.agg$nodf.song.sc[match(highprod25.sps$Site_ID, f.agg$Site_ID)]
highprod25.sps$functional.comp.poll.sc<-f.agg$functional.comp.poll.sc[match(highprod25.sps$Site_ID, f.agg$Site_ID)]
highprod25.sps$species.poll.sc<-f.agg$species.poll.sc[match(highprod25.sps$Site_ID, f.agg$Site_ID)]
highprod25.sps$tot.visits.sc<-f.agg$tot.visits.sc[match(highprod25.sps$Site_ID, f.agg$Site_ID)]
```


```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, results='hide'}

#fit three models

 m0.eq.comm25<-glm(equity ~  1 , family="binomial", data=highprod25.sps)
 

 summary(m0.eq.comm25)
 
 m1.eq.comm25<-glm(equity ~  species.poll.sc + tot.visits.sc , family="binomial", data=highprod25.sps)
 

 summary(m1.eq.comm25)

 m2.eq.comm25<-glm(equity ~  species.poll.sc + tot.visits.sc + nodf.song.sc + functional.comp.poll.sc , family="binomial", data=highprod25.sps)
summary(m2.eq.comm25) 
 

#select best model based on AIC 

AICtab(m0.eq.comm25, m1.eq.comm25, m2.eq.comm25) #m1 is best no variables significant


```


  Within our simulation evaluating the relationship between niche complementarity and equity in reproductive success at increasing number of plant species considered, we found that the link to complementarity became more important as more species were considered (Fig. 3). This importance seemed to reach a plateau at 6 species. However, this should be further evaluated, as this was the maximum number of species simultaneously observed in a community for our study, which precludes us from simulating further numbers of species.  
 

```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, results='hide', fig.show = 'hide'}

f2$Plant.sp<-paste(f2$Plant_genus, f2$Plant_species)
f3<-f2[,c(1,13:14)]

f4 <- ddply(f3, c("Site_ID", "Plant.sp"), summarise,
                         mean.fruitset    = mean(tot.fruitset))

table(f4$Plant.sp)
#Astragalus lusitanicus and Cistus albidus are causing problems because they have very low fruit set, but as there is only one value, when correcting for max fruit set, gets a value of 1. 
#I am removing them here.
f4 <- subset(f4, !Plant.sp %in% c("Astragalus lusitanicus", "Cistus albidus", "Anchusa azurea"))



#f4

fr.max<-aggregate(.~ Plant.sp, f4, FUN=max)

f4$fruit.max<-fr.max$mean.fruitset[match(f4$Plant.sp, fr.max$Plant.sp)]

f4$fruit.prop<-f4$mean.fruitset/f4$fruit.max
head(f4) 

  
#1) First let's calculate all combinations of 1,2,3,4,5,6 species per network.
combinatorials_all <-  matrix(ncol = 5, nrow = 1, NA) 
colnames(combinatorials_all) <- c("SiteID", "Plant_number_level", "iteration", "equity", "functional.comp")
uniqueSite_ID <- unique(f4$Site_ID)
for(k in 1:length(uniqueSite_ID)){ #sites
  Site_temp <- subset(f4, Site_ID == uniqueSite_ID[k]) #1:SiteID
  n <- length(Site_temp$Plant.sp)
  combinatorials <- matrix(ncol = 5, nrow = 1, NA) #flexible
  colnames(combinatorials) <- c("SiteID", "Plant_number_level", "iteration", "equity", "functional.comp")
  combinatorials <- as.data.frame(combinatorials)
  for (i in 1:n){ #levels
    combinatorials_1 <- combn(x = Site_temp$Plant.sp, m = i) #1:n
    for (j in 1:ncol(combinatorials_1)){ #different combinations
      temp1 <- Site_temp[which(Site_temp$Plant.sp %in% combinatorials_1[,j]),]
      combinatorials_2 <- subset(temp1, temp1$fruit.prop > 0.8) #use 50th percentile
      if(dim(combinatorials_2)[1] == 0) {
        combinatorials_2 <- temp1
        combinatorials_2$no_rows <- 0
      } else{
        combinatorials_2$no_rows<-rep(1, nrow(combinatorials_2))
      }
      #head(combinatorials_2)
      #for each site here is the number of sps whose fruitset exceeds 50th percentile of maximum fruitset observed in the whole study area
      combinatorials_3 <- aggregate(no_rows ~ Site_ID, combinatorials_2, sum)
      #head(combinatorials_3)
      combinatorials_3$functional.comp.poll <- out.site$functional.comp.poll[match(combinatorials_3$Site_ID, out.site$Site_id)]
      #now save for later.
      index <- dim(combinatorials)[1]
      combinatorials[index+1,1] <-  as.character(combinatorials_3$Site_ID) #1:SiteID
      combinatorials[index+1,2] <-  i #Plant number level
      #combinatorials[index+1,3] <-    #"iteration" let's asume we don' care, but would be good for unit testing
      combinatorials[index+1,4] <- combinatorials_3$no_rows/i #above threshold in %
      combinatorials[index+1,5] <-  combinatorials_3$functional.comp.poll #nich comp value...

    } #close different combinations
  } #close levels
  combinatorials_all <- rbind(combinatorials_all, combinatorials[-1,])
} #close sites

combinatorials_all <- combinatorials_all[-1,]

#plot overall 

#scatter.smooth(combinatorials_all$equity ~ combinatorials_all$functional.comp) 
 

#scale variables

combinatorials_all$functional.comp.sc<-scale(combinatorials_all$functional.comp, center = T, scale = T)


#now try overall, per level.
estimate <- rep(NA,6)
for (i in unique(combinatorials_all$Plant_number_level)){
  temp <- subset(combinatorials_all, Plant_number_level == i)
  m <- lm(temp$equity ~ temp$functional.comp.sc)
  plot(temp$equity ~ temp$functional.comp.sc) 
  abline(m)
  estimate[i] <- m$coefficients[2]
  }

#plot(unique(combinatorials_all$Plant_number_level) , estimate, las = 1, ylim = c(-0.01, 0.1) ,
   #  ylab = "importance of niche partitioning", xlab = "number of plants considered")


#now we subsample 16 combinations at a time 100 timeas and make the average.
estimate_i <- data.frame(level = NA, estimate = NA)
estimate_k <- data.frame(level = NA, estimate = NA)
head(combinatorials_all)
for (i in 1:length(unique(combinatorials_all$Plant_number_level))){ # over levels
  temp <- subset(combinatorials_all, Plant_number_level == unique(combinatorials_all$Plant_number_level)[i])
  for(k in 1:100){ #iterations
    value <- data.frame(site = NA, eq = NA, nich = NA)
    for(j in 1:length(unique(temp$SiteID))){ # over sites
      temp2 <- subset(temp, SiteID == unique(temp$SiteID)[j]) 
      value_temp <- temp2[sample(x = 1:nrow(temp2), 1),]
      value[j,1] <- value_temp$SiteID
      value[j,2] <- value_temp$equity
      value[j,3] <- value_temp$functional.comp
    } #close sites
    m <- lm(value$eq ~ value$nich)
    #plot(value$eq ~ value$nich)
    estimate_k[k,1] <- i
    estimate_k[k,2] <- m$coefficients[2]  
  } #close iteration
  #unique(estimate_k) #only 5 unique ombinations for n = 5. All negative. highly influenced by one data point of low niche part and equ = 1. "CotitodeSantaTeresa"
  #subset(f4, Site_ID == "CotitodeSantaTeresa") #Super high values!
  estimate_mean <- aggregate(estimate ~ level, data = estimate_k, FUN = "mean")
  estimate_i[i,1] <- estimate_mean$level
  estimate_i[i,2] <- estimate_mean$estimate
  }

estimate_i

#plot(estimate_i$level, estimate_i$estimate, las = 1,
    # ylab = "importance of niche partitioning", xlab = "number of plants considered")


Figure3<-ggplot(estimate_i,  aes(x=level, y=estimate)) +    
  geom_point(size=4) + 
  xlab("Number of plant species considered") +      
  ylab("Importance of niche complementarity") + theme_bw()  +
  theme(text = element_text(size = 18), axis.text=element_text(size=rel(1)), axis.title=element_text(size=rel(1), face="bold")) 


```



**Discussion**

The existence of relationships between interaction network structure and ecosystem function have been long hypothesized, yet, the specific mechanisms underlying this relationship remain elusive [@Thompson2012]. Our results suggest that different aspects of network structure affect different dimensions of ecosystem functioning. In particular, we find that the centrality of a plant species within a community has a positive association with its fruit set, indicating that from a plant's perspective in this case, being connected to other plant species via shared pollinators has a positive outcome (e.g. by ensuring a stable pollinator supply through time) rather than a negative one (e.g. via heterospecific pollen transport). At the site level, we find that greater values of niche complementarity between pollinators result in larger average values of reproductive success.

 Most of our analyses reveal that both model 1 and 2 were equally good, which suggests that the added complexity of measuring the full network of interactions may not pay off for rapid assessments. Hence, simple visitation metrics, such as pollinator richness, might be enough to describe general patterns [@Garibaldi2013; @Garibaldi2015]. Yet, adding network level information may inform us of the potential ecological mechanisms underlying the processes driving these observed patterns. Further, although we sampled each site seven times in a randomized order in an attempt to better represent interactions through time, our surveys were able to capture 20% of interactions given the great diversity of our study system. This could be explaining part of the low effect sizes we find at the species level, where a stronger contribution of pollinator visits is expected given their obligate dependence. In addition, plant reproductive success is affected by other variables which we do not attempt to measure in this study and that could explain a large portion of the variability observed (e.g., XX).

  Consistent with previous experimental [@Fontaine2005; @Frund2013], theoretical [@Pauw2013], and empirical studies [@Poisot2013; @Valdovinos2016], we find that niche complementarity is key in determining differences in reproductive outputs at the community level, both greater fruit set and larger numbers of seeds per fruit. These results show that reproductive success in plants requires of a certain degree of specialization amongst pollinator species on a particular plant resource in order to avoid the negative effects of inter-specific pollen deposition (e.g., pollen loss [@Flanagan2009] or interference with conspecific pollen [@Morales2008]). However, we also find that some level of redundancy in these functions is needed as revealed by the positive effect of plant niche overlap on the number of seeds per fruit at the species level. 

  In our study, we did not find a relationship between nestedness and any of the reproductive success measures. This metric, widely used across network analysis, and which is deemed to stabilize natural communities ([@Bastolla2009] but see [@James2012]), does not seem to play a direct role in ecosystem function measured as plant reproductive success. However, our study is limited to a maximum of six common plant species per community, and including more species, especially rare species, might reveal different patterns. Further, although we sampled each site seven times in a randomized order in an attempt to better represent interactions through time, our surveys were able to capture ~20% of interactions given the great diversity of our study system. This could be explaining part of the low effect sizes we find at the species level, where a stronger contribution of pollinator visits is expected given their obligate dependence [@Garibaldi2013]. In addition, it is important to note that plant reproductive success is affected by other environmental variables which we do not attempt to measure in this study and that could explain a large portion of the variability observed.
 
  Our measure of reproductive success at the site level using average values of fruit or seed set represents an important part of the functions delivered by pollinators to plants. However, these average values might be masking a great deal of variability amongst plant species, and thus a nuanced view of the effect of pollinators on whole-plant ensembles is needed. This can be captured by the effect of pollinators on equity in reproductive success across plant species. This aspect ensures that reproductive success is equally distributed amongst a larger number of species, thus contributing to the maintenance of greater species diversities in natural populations. Indeed, we know that plant species diversity within a community is largely driven by different types of direct and indirect interactions including those amongst plant species (e.g., resource competition [@Goldberg1992] or facilitation [@Bruno2003]), as well as those defining antagonistic (e.g., involving pathogens [@Bagchi2010], or mutualistic interactions (e.g, pollinators [@Benadi2013; @Lanuza2018]). However, equitability in reproductive success across species is seldom taken into account, despite increasing theoretical and empirical support to the idea that minimizing fitness differences among species is an important mechanism of species coexistence [@Godoy2014]. 

 In our case , we did not find a strong effect of either simple visitation or network structure metrics on reproductive equity. However, the results of our simulation, shows us that the effect of network structure increases when more than four plant species are considered. This implies that if we were able to measure reproductive success for all the plant species in all the communities (which is not feasible given constraints on sampling effort), we might find that the effects of network structure on equity might be more prevalent.
  
  One of the unexpected results of our analyses is the strong negative relationship between total pollinator richness and fruit set at the site level. One possible explanation for this is that greater richness means greater transfer of heterospecific pollen [@Arceo-Gomez2019]. Another possible explanation to this might be the fact that pollinator richness includes all the pollinators recorded during our sampling efforts, i.e., it includes species that do not pollinate some of the species whose reproductive success was measured. More complex communities with more pollinators, but also with more plant species (Pearson correlation between plant and pollinator richness  = 0.42 in our case) may require stabilizing mechanisms that reduce the competition exerted by the dominant plant species. A way to reduce the competition exerted by these dominant species, which are precisely those evaluated in this study, is by reducing their reproductive success [@Lanuza2018; @Stavert2019]. These ideas open the door to exploring the positive or negative effects of the complete pollinator community on full plant species coexistence, which may be determined by density-dependence effects [@Benadi2018]. In our case, while fruit set is negatively related to pollinator richness, it is important to note that fruit and seed weight show the opposite relationship, indicating that this density-dependent effect might only be limiting fruit quantity and not fruit quality. Thus, taking into account the densities of co-flowering plant species may be the next step [@Vanbergen2014]. 
  
Our study illustrates the challenges of measuring and linking network structure to ecosystem function empirically. There is an ongoing debate as to which network metrics better reflect classic ecological mechanisms, such as niche partitioning or competition [@Delmas2019]. Here, we focus on testing two specific hypotheses, but other structural properties can be explored in the future. Furthermore, the structure of plant-pollinators networks is dynamic due to ecological and evolutionary reasons, but so far, we are only able to characterize it for single snap-shots. Moreover, different aspects of functioning may be important, such as the need to consider the functioning of both trophic levels [@Godoy2018]. In terms of plant reproductive success and the functions performed by pollinators we can measure different aspects, ranging from pollen deposition (the direct pollinator function), to its final effects on plant fitness. Here, we focus on an intermediate stage including fruit quantity and quality, which is of clear ecological importance.   

 In summary, our findings show that the analysis of natural communities using network analysis represents an ideal way of visualizing the complexity present within these communities, but also represents a manner of mechanistically representing the differences observed across the reproductive success of individuals and/or species while linking them to potential ecological mechanisms. Our findings represent a step forward in our understanding of how community structure affects function, yet they also show that more studies with better resolved communities are needed, with a special focus being placed in evaluating reproductive success of a larger array of plant species. 

**Data accessibility**

All the data used is available https://zenodo.org/account/settings/github/repository/ibartomeus/BeeFunData 
and the code used to generate all results can be found at https://doi.org/10.5281/zenodo.3364037.

**Acknowledgements**

The authors would like to thank Oscar Aguado for identifying pollinator species. We would also like to acknowledge the efforts of the editor Cédric Gaucherel, as well as those of Michael Lattorff, Nicolas Deguines, Alberto Pascual, Nico Blüthgen and six anonymous reviewers who provided very helpful comments and suggestions in a previous version of this manuscript. AM received funding from a Juan de la Cierva (IJCI-2014-22558) and Ikerbasque fellowships. IB acknowledges funding from MSC-PCIG14-GA-2013-631653 BeeFun Project. We thank Doñana’s Singular Scientific-Technical Infrastructure (ICTS-RBD) for access to the park. Research also supported by the Spanish State Research Agency through María de Maeztu Excellence Unit accreditation (MDM-2017-0714) and the Basque Government BERC Programme. AM received funding from an Ikerbasque Research Fellowship.



\nextpage

##Tables

```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=5}

knitr::kable(list(Table1A, Table1B), caption = "**Table 1**. Results of GLMM showing the association between simple visitation and network structure metrics and A) species-level fruit set and B) average number of seeds per fruit based on best model selected. Bold letters indicate variables with large effects.")
```
\newpage


```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=5}
knitr::kable(list(Table2A, Table2B), caption = "**Table 2**. Results of GLM showing associations between simple visitation and network structure metrics and A) site-level average fruit set and B) site-level average number of seeds per fruit based on best model selected. Bold letters indicate variables with large effects.")


```
\newpage


**Figure legends**

**Figure 1**. Partial residual plots showing the effect of the single predictor which best explains the variability in species-level reproductive success. A) shows the effect of plant species centrality on the fruit set of each of the plant species considered and B) shows the effect of plant niche overlap on its average number of seeds per fruit. Dots represent each of the individuals sampled for each species within each site.

**Figure 2.** Partial residual plots showing the effect of the single predictor which best explains the variability in site-level reproductive success. A) Shows the effect of pollinator richness, and B) of niche complementarity among pollinator species on site-level average fruit set. C) Shows the effect of niche complementarity among pollinator species on the average number of seeds per fruit at the site level. Dots represent average values of fruit set at the level of the community for all plant species considered (N=16 sites).

**Figure 3.** Results of simulation evaluating the importance of niche complementarity in determining differences in equity in reproductive across communities harboring from one to six species. Points represent average values across 1,000 simulated combinations. 

\newpage



\newpage

```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=9, fig.width=9}

#FIGURE 1
Figure1

   # save_plot("figures/Figure2.tiff", Figure2,
   #           base_height = 6, base_width = 9)
```
**Figure 1**

\newpage


```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=3, fig.width=11}

#FIGURE 2
Figure2

    # save_plot("figures/Figure3.tiff", Figure3,
    #           base_height = 3, base_width = 11)
```
**Figure 2**

\newpage



```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=5, fig.width=8}
Figure3
```
**Figure 3.** 




\newpage

#Supplementary material


```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=7, fig.width=10}

#FIGURE S1


mydf <- read.csv("site_coordinates.csv")

# Making a data frame *spatial*
library(devtools)
# install_github("edzer/sfr")
# install_github("edzer/rgdal2")
library(rgdal)
library(sf)
library(sp)
library(raster)
library(tmap)
library(dplyr)
library(spData)
library(leaflet)
library(ggplot2)
library(grid)

#devtools::install_github("Nowosad/spDataLarge")
library(spDataLarge)

occs <- st_as_sf(mydf, coords = c("longitude", "latitude"))

#setting projection
st_crs(occs) <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +init=epsg:3042"

data(world)
sp<-subset(world, world$iso_a2==c("ES", "PT"))

#extent(occs)  #to calculate xmin, xmax, ymin, ymax
doñana_region = st_bbox(c(xmin = -7.000000, xmax = -6.00000,
                      ymin = 37.10000, ymax = 37.51200),
                    crs = st_crs(sp)) %>% 
  st_as_sfc()


sp_map = tm_shape(sp) + tm_polygons() +   tm_compass(type = "8star", position = c("right", "bottom")) +
  tm_shape(occs) + tm_symbols(shape = 16, col = "black", size = 0.03) + 
 tm_shape(doñana_region) + tm_borders(lwd = 3) #map of all spain



# Get elevation data from the internet 
elev <- getData("alt", country = "Spain")

# Crop raster to desired extent
ele <- crop(elev, c(-7.000000, -6.00000, 37.10000, 37.51200))



sp_points_map = tm_shape(ele, bbox = doñana_region) +
 tm_raster(legend.show = TRUE, title = "Elevation \n (m)") + 
  tm_layout(legend.text.size=1.5, legend.title.size = 1.6, legend.bg.color = "white", legend.frame = TRUE) +
  tm_shape(occs) + tm_symbols(shape = 24, col = "darkgrey", size = 2) +
  tm_scale_bar(position = c("left", "bottom"), size=1.5)



sp_points_map
print(sp_map, vp = viewport(0.8335, 0.6812, width = 0.35, height = 0.35))


```
**Figure S1.** Map showing location of 16 Mediterranean woodland patches where plant-pollinator interactions were surveyed from February to May 2015. Inset shows location of study area within SW Spain.

```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=13, fig.width=7}
#Figure S2 is autocorrelation analysis

library(BeeFunData)

si<-BeeFunData::sites #lat long data for sites 

f.agg$lat<-si$latitude[match(f.agg$Site_ID, si$Site_ID)]
f.agg$lon<-si$longitude[match(f.agg$Site_ID, si$Site_ID)]

s.comm$lat<-si$latitude[match(s.comm$Site_ID, si$Site_ID)]
s.comm$lon<-si$longitude[match(s.comm$Site_ID, si$Site_ID)]

library(ecodist)

#distance matrices
xy <- cbind(as.vector(f.agg$lat), as.vector(f.agg$long))
xydis <-distance(xy, method="euclidean")

nesteddis<-distance(as.vector(f.agg$nodf.song), method="euclidean")
functdis<-distance(as.vector(f.agg$functional.comp.poll), method="euclidean")
richdis<-distance(as.vector(f.agg$species.poll), method="euclidean")
fruitdis<-distance(as.vector(f.agg$mean.fruitset), method="euclidean")
visdis<-distance(as.vector(f.agg$tot.visits), method="euclidean")
seeddis<-distance(as.vector(s.comm$mean.seedset), method="euclidean")
seedwdis<-distance(as.vector(s.comm$mean.seedweight), method="euclidean")
fruitwdis<-distance(as.vector(s.comm$mean.fruitweight), method="euclidean")


#correlograms
Nestcor=mgram(nesteddis, xydis, nperm=10000, nboot=100, nclass=7)
plot(Nestcor, main="Nestedness")

Functcor=mgram(functdis, xydis, nperm=10000, nboot=100, nclass=7)
plot(Functcor, main="Pollinator niche complementarity")

Richcor=mgram(richdis, xydis, nperm=10000, nboot=100, nclass=7)
plot(Richcor, main="Pollinator species richness")

Viscor=mgram(visdis, xydis, nperm=10000, nboot=100, nclass=7)
plot(Viscor, main="Total visits")

Fruitcor=mgram(fruitdis, xydis, nperm=10000, nboot=100, nclass=7)
plot(Fruitcor, main="Fruitset")

Seedcor=mgram(seeddis, xydis, nperm=10000, nboot=100, nclass=7)
plot(Seedcor, main="Seeds per fruit")

Seedwcor=mgram(seedwdis, xydis, nperm=10000, nboot=100, nclass=7)
plot(Seedwcor, main="Seed weight")

Fruitwcor=mgram(fruitwdis, xydis, nperm=10000, nboot=100, nclass=7)
plot(Fruitwcor, main="Fruit weight")

par(mfrow=c(3,3))
plot(Nestcor, main="Nestedness");plot(Functcor, main="Pollinator niche complementarity");
plot(Richcor, main="Pollinator species richness");plot(Viscor, main="Total visits");
plot(Fruitcor, main="Fruit set"); plot(Seedcor, main="Seeds per fruit"); plot(Seedwcor, main="Seed weight");
plot(Fruitwcor, main="Fruit weight")


```
**Figure S2.**Mantel correlograms showing a low spatial autocorrelation for the different variables included in the analyses. 

```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=13, fig.width=7}

#######FIG S2 SAMPLING COMPLETENESS 
#FigureS2<-plot_grid( poll, plant, link, ncol = 1)
FigureS3

# save_plot("figures/FigureS1.tiff", figures1,
#            base_height = 13, base_width = 7)
```

**Figure S3.** Accumulation curves of pollinator, plant and plant-pollinator link richness with increasing sampling effort up to 100% sample coverage. Solid lines and points indicate observed richness while dashed lines show expected richness at increasing sample size, (i.e., extrapolated). 

```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=5, fig.width=8}

FigureS4

```
**Figure S4.** Forest plots showing 95% confidence intervals for all coefficients included in species-level models. 


```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=5, fig.width=8}

FigureS5

```
**Figure S5.** Scatterplot showing the effect of the relative number of visits received by a focal plant on its reproductive success. Relationship is largely driven by one species with a particularly large value of relative visits and removing this point leads to no effect of visitation rate. 


```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=15, fig.width=8}

FigureS6A
FigureS6B
FigureS6C

```
**Figure S6.** Forest plots showing 95% confidence intervals for all coefficients included in site-level models, A) fruit set, B) number of seeds per fruit and C) fruit and seed weight. 

```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=3, fig.width=10}

#FIGURE 4
FigureS7
# 
# save_plot("figures/Figure4.tiff", Figure4,
#              base_height = 5, base_width = 10)
```
**Figure S7.** Partial residual plots showing the effect of pollinator richness on site-level average A) fruit and B) seed weight. Dots represent values for each site (N=16 sites).

```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=3, fig.width=10}

FigureS8

```

**Figure S8.** Partial residual plots showing the effect of pollinator richness on site-level average A) fruit and B) seed weight. Here, a site with a particularly large pollinator richness value is removed to test whether it might be driving the significant relationship. Dots represent values for each site (N=15 sites).

\newpage

```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE}

Suppl2a<-ddply(dtrans, c("Site_ID", " Plant_gen_sp"), summarise, 
                      tot.inds = length( Plant_gen_sp))

Suppl2a<-Suppl2a[,1:2]
colnames(Suppl2a)<-c("Site", "Plant species")

kable(Suppl2a, caption = "TableS1A. List with all plant species present at each of the sites.")


Suppl2b<-ddply(dtrans, c("Site_ID", " Pollinator_gen_sp "), summarise, 
                      tot.inds = length( Pollinator_gen_sp ))
Suppl2b<-Suppl2b[,1:2]
colnames(Suppl2b)<-c("Site", "Pollinator species")

kable(Suppl2b, caption = "TableS1B. List with all pollinator species present at each of the sites.")


# pruebaA<-ddply(Suppl2a, c("Site_ID"), summarise, 
#                tot.inds = length(Plant_gen_sp))  #get number of plant species per site included in network analyses
# 
# 
# pruebaB<-ddply(Suppl2b, c("Site_ID"), summarise, 
#               tot.inds = length(Pollinator_gen_sp))  #get number of pollinator species per site included in network analyses


#calculate number of plant species per site, number of individuals per plant species and number of fruits per ind surveyed for repr succ


tableS2 <- aggregate(Plant.ID ~ Site_ID + Plant.sp, data = f2, FUN = function(x){NROW(x)})

colnames(tableS2)<-c("Site", "Plant species", "Number of individuals")

kable(tableS2, caption = "Table S2. Number of individuals per plant species sampled at each site.")


tableS3<-ddply(s, c("Site_ID", "Plant.sp"), summarise, 
                   tot.fruits = length(Plant.ID)) #number of fruits per individual

colnames(tableS3)<- c("Site", "Plant species", "Number of fruits")

kable(tableS3, caption = "Table S3. Number of fruits per plant species sampled at each site.")
```


```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=5}

#coefs.m2
TableS5<-round(coefs.m2b[,1:3],digits=2)
rownames(TableS5)<-c("(Intercept)", "Pollinator richness", "Relative number of visits", "Centrality", "Plant niche overlap")

kable(TableS5, caption="Table S5. Results of GLMM showing effect of simple visitation and network metrics on species-level fruit set based on best model selected as in Table 1, but removing one species point with a particularly large visitation rate which drives this relationship.")

```


```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=5}

tableS6A<-round(summary(m1.fruitw.net)$coef[,1:3], digits=2)
rownames(tableS6A)<-c("(Intercept)", "Pollinator richness", "Relative number of visits")

kable(tableS6A, caption="Table S6. Results of GLM showing effect of simple visitation metrics on A) site-level average fruit weight based on best model selected and B) the same analysis removing one site that has a particularly large pollinator richness value to test whether this point might be driving the relationship.")
```

```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=5}

tableS6B<-round(summary(m1.fruitw.net2)$coef[,1:3], digits=2)
rownames(tableS6B)<-c("(Intercept)", "Pollinator richness", "Relative number of visits")

kable(tableS6B, caption="Table S6. Results of GLM showing effect of simple visitation metrics on A) site-level average fruit weight based on best model selected and B) the same analysis removing one site that has a particularly large pollinator richness value to test whether this point might be driving the relationship.")
```

```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=5}
#save table with results for paper
tableS7A<-round(summary(m1.seedw.net)$coef[,1:3], digits=2)
rownames(tableS7A) <-c("(Intercept)", "Pollinator richness", "Relative number of visits")

kable(tableS7A, caption="Table S7. Results of GLM showing effect of simple visitation metrics on A) site-level average seed weight based on best model selected and B) the same analysis removing one site that has a particularly large pollinator richness value to test whether this point might be driving the relationship.")
```

```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=5}
#save table with results for paper
tableS7B<-round(summary(m1.seedw.net2)$coef[,1:3], digits=2)
rownames(tableS7B) <-c("(Intercept)", "Pollinator richness", "Relative number of visits")

kable(tableS7B, caption="Table S7. Results of GLM showing effect of simple visitation metrics on A) site-level average seed weight based on best model selected and B) the same analysis removing one site that has a particularly large pollinator richness value to test whether this point might be driving the relationship.")
```

```{r, include=TRUE, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE, fig.height=5}

kable(tableS8, caption="Table S8. Results of GLM showing effect of simple visitation metrics on equity in reproductive success across plant species within a site based on best model selected (0.50 threshold).")

```

\newpage

**References**